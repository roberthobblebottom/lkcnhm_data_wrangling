<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>bos_gbif_matching_marimo_notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>bos gbif matching marimo notebook</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/index-BB71mG_d.js"></script>
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/index-DryPQDfA.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "bos_gbif_matching_marimo_notebook.py",
            "mode": "read",
            "version": "0.15.2",
            "serverToken": "static",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "plain", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "full", "reference_highlighting": true, "theme": "dark"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "package_management": {"manager": "pip"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "full"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "mo.md(\n    r\"\"\"\n# Introduction  \n\ncombination of r_translation.py script and more_r_translation.py marimo notebook. these olds scripts are under `old_files`\n\nfor the second matching wrangle, the parts for specificEpithet and infraSpecificEpithet doesn't match with many results.\n\n# Imports and Initial Preprocessing\n\"\"\"\n)", "code_hash": "fef7f51634a67ed57cff77a654024693", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "import marimo as mo\nimport polars as pl", "code_hash": "ce4194fff5fe8b0eebb7a09769bc0473", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "bos = (\n    pl.read_csv(\"bos.csv\")\n    .rename(\n        {\n            \"data cleanup changes\": \"data cleanup changes 1\",\n            \"species\": \"specificEpithet\",\n            \"subspecies\": \"infraspecificEpithet\",\n            \"domain \": \"domain\",\n        }\n    )\n    .with_columns(pl.col(pl.String).str.strip_chars(\" \"))\n    .with_columns(genericName=pl.col(\"genus\"))\n)", "code_hash": "aec531ea99fb89c31feec8ef0103e84a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "null_counts = (\n    bos.null_count()\n    .transpose(include_header=True)\n    .rename({\"column\": \"feature\", \"column_0\": \"len\"})\n)\ncolumns_to_drop_as_all_nulls = (\n    null_counts.filter(null_counts[\"len\"] == bos.shape[0])\n    .transpose()[0, :]\n    .transpose()\n    .to_series()\n    .to_list()\n)", "code_hash": "326926b50dfc5120bb2413c46973fe5f", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "columns_to_drop_as_they_are_just_changes_logs = [\n    \"cleanup changes \",\n    \"Data cleanup changes\",\n    \"data cleanup changes 1\",\n    \"changes\",\n    \"cleanup changes\",\n    \"Unnamed: 18\",\n    \"Unnamed: 17\",\n    \"Unnamed: 19\",\n    \"query\",\n    \"query \",\n    \"issue\",\n    \"cleanup changes/comments\",\n    \"subphylum\",\n]", "code_hash": "740c615dabbd943e156e6d426dabb055", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "bos_cleaned = (\n    (\n        bos.drop(columns_to_drop_as_all_nulls)\n        .drop(columns_to_drop_as_they_are_just_changes_logs)\n        .select(~pl.selectors.starts_with(\"Unnamed\"))\n    )\n    .with_columns(\n        infraspecificEpithet=pl.when(pl.col(\"infraspecificEpithet\").is_null())\n        .then(pl.lit(\"\"))\n        .otherwise(pl.col(\"infraspecificEpithet\"))\n    )\n    .with_columns(\n        infraspecificEpithet=pl.when(\n            (pl.col(\"genericName\") == \"Glenea\")\n            & (pl.col(\"specificEpithet\") == \"mathemathica\")\n        )\n        .then(pl.lit(\"mathematica\"))\n        .otherwise(pl.col(\"infraspecificEpithet\"))\n    )\n    .with_columns(\n        specificEpithet=pl.when(\n            (pl.col(\"genericName\") == \"Glenea\")\n            & (pl.col(\"specificEpithet\") == \"mathemathica\")\n        )\n        .then(pl.lit(\"mathematica\"))\n        .when(\n            (pl.col(\"genericName\") == \"Bavia\")\n            & (pl.col(\"specificEpithet\") == \"sexupunctata\")\n        )\n        .then(pl.lit(\"sexpunctata\"))\n        .when(\n            (pl.col(\"genericName\") == \"Omoedus\")\n            & (pl.col(\"specificEpithet\") == \"ephippigera\")\n        )\n        .then(pl.lit(\"ephippiger\"))\n        .when(\n            (pl.col(\"genericName\") == \"Byblis\")\n            & (pl.col(\"specificEpithet\") == \"kallartha\")\n        )\n        .then(pl.lit(\"kallarthra\"))\n        .when(\n            (pl.col(\"genericName\") == \"Alcockpenaeopsis\")\n            & (pl.col(\"specificEpithet\") == \"hungerfordi\")\n        )\n        .then(pl.lit(\"hungerfordii\"))\n        .when(\n            (pl.col(\"genericName\") == \"Pseudosesarma\")\n            & (pl.col(\"specificEpithet\") == \"edwardsi\")\n        )\n        .then(pl.lit(\"edwardsii\"))\n        .when(\n            (pl.col(\"genericName\") == \"Urocaridella\")\n            & (pl.col(\"specificEpithet\") == \"antonbruuni\")\n        )\n        .then(pl.lit(\"antonbruunii\"))\n        .when(\n            (pl.col(\"genericName\") == \"Ocypode\")\n            & (pl.col(\"specificEpithet\") == \"cordimanus\")\n        )\n        .then(pl.lit(\"cordimana\"))\n        .otherwise(pl.col(\"specificEpithet\"))\n    )\n    .with_columns(\n        domain=pl.lit(\"Eukarya\"),\n        kingdom=pl.when(\n            (pl.col(\"phylum\").is_in([\"Ascomycota\", \"Basidiomycota\"]))\n        )\n        .then(pl.lit(\"fungi\"))\n        .when(pl.col(\"phylum\") == \"Cyanobacteria\")\n        .then(pl.lit(\"Bacteria\"))\n        .when(pl.col(\"phylum\") == \"Ciliophora\")\n        .then(pl.lit(\"Protista\"))\n        .otherwise(pl.lit(\"Animalia\")),\n    )\n    .with_columns(\n        taxonName=pl.col(\"taxonName\")\n        .str.replace_all(\"<i>\", \"\")\n        .str.replace_all(\"</i>\", \"\"),\n    )\n)", "code_hash": "651051385bc53c333d98c016c1598f50", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "_filter = pl.col(\"taxonomicStatus\").is_in(\n    [\n        \"accepted\",\n        \"synonym\",\n        \"homotypic synonym\",\n        \"proparte synonym\",\n        \"heterotypic synonym\",\n    ]\n)\ntaxon_ranked_only = (\n    pl.scan_csv(\n        \"gbif/Taxon.tsv\",\n        separator=\"\\t\",\n        quote_char=None,\n        cache=True,\n    )\n    .filter((pl.col(\"taxonRank\") != \"unranked\") & _filter)\n    .select(\n        \"taxonID\",\n        \"genericName\",\n        \"genus\",\n        \"specificEpithet\",\n        \"infraspecificEpithet\",\n        \"taxonomicStatus\",\n        \"acceptedNameUsageID\",\n        # \"domain\",\n    )\n    .filter((pl.col(\"genus\") != \"\") & (pl.col(\"specificEpithet\") != \"\"))\n    .with_columns(\n        infraspecificEpithet=pl.when(\n            (pl.col(\"infraspecificEpithet\").is_null())\n        )\n        .then(pl.lit(\"\"))\n        .otherwise(pl.col(\"infraspecificEpithet\"))\n    )\n)\ntaxon_ranked_only = taxon_ranked_only.with_columns(\n    genus=pl.when(pl.col(\"genus\").is_null())\n    .then(\"genericName\")\n    .otherwise(\"genus\")\n)", "code_hash": "89f397595c6d2ca65b548c18aa7846d1", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "matching = (\n    taxon_ranked_only.join(\n        other=pl.LazyFrame(bos_cleaned),\n        on=[\"genus\", \"specificEpithet\", \"infraspecificEpithet\"],\n        how=\"right\",\n    )\n    .rename({\"taxonID\": \"matched_taxonID\"})\n    .select(\n        \"speciesId\",\n        \"matched_taxonID\",\n        \"acceptedNameUsageID\",\n        \"taxonName\",\n        \"domain\",\n        \"kingdom\",\n        \"phylum\",\n        \"class\",\n        \"subclass\",\n        \"superorder\",\n        \"order\",\n        \"sub-order\",\n        \"infraorder\",\n        \"section\",\n        \"subsection\",\n        \"superfamily\",\n        \"family\",\n        \"subfamily\",\n        \"tribe\",\n        \"genus\",\n        \"subgenus\",\n        \"genericName\",\n        \"specificEpithet\",\n        \"infraspecificEpithet\",\n    )\n    .with_columns(\n        pl.when(pl.col(\"infraspecificEpithet\") == \"\")\n        .then(pl.lit(None))\n        .otherwise(\"infraspecificEpithet\")\n        .alias(\"infraspecificEpithet\")\n    )\n)\n# matching and contetnious split\n# What makes a data point contentious is where it has duplicate speciesId.\nmatching = matching.filter(~pl.col(\"speciesId\").is_duplicated()).with_columns(\n    acceptedNameUsageID=pl.col(\"acceptedNameUsageID\")\n    .fill_null(pl.lit(None))\n    .cast(pl.Int64)\n)\ncontentious = matching.filter(\n    (pl.col(\"speciesId\").is_duplicated())\n).with_columns(\n    acceptedNameUsageID=pl.col(\"acceptedNameUsageID\")\n    .fill_null(pl.lit(None))\n    .cast(pl.Int64)\n)\n\nunique_contentious = contentious.filter(\n    (pl.col(\"acceptedNameUsageID\").is_null())\n    & (\n        pl.col(\"matched_taxonID\").is_in(\n            pl.col(\"acceptedNameUsageID\").implode()\n        )\n    )\n)\n\nunique_contentious_speciesId = (\n    unique_contentious.select(\"speciesId\").collect().to_series().implode()\n)  # Just the speciesIds\ncontentious = contentious.filter(\n    ~pl.col(\"speciesId\").is_in(unique_contentious_speciesId)\n)  # Removing unique conentious\n\nmatching = pl.concat(\n    [matching, unique_contentious],\n)\n\nmatching = matching.with_columns(\n    genus=pl.when(\n        (pl.col(\"genus\").is_null()) & (pl.col(\"specificEpithet\").is_not_null())\n    )\n    .then(pl.col(\"taxonName\").str.split(\" \").list[0])\n    .otherwise(\"genus\")\n)\n\nno_match = (\n    matching.filter(pl.col(\"matched_taxonID\").is_null())\n    .with_columns(\n        taxonRank=pl.lit(\"BOSuncornirmedSpecies\"),\n        taxonomicStatus=pl.lit(\"BOSunformired\"),\n        parentNameUsageID=pl.lit(None),\n    )\n    .fill_null(\"\")\n    .collect()\n)", "code_hash": "a24d137a18177e367f6e2921047bedbb", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(r\"\"\"# First Matching Wrangle\"\"\")", "code_hash": "3ca094b96f6d720e9f2e6cb24585f57d", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "emfo", "name": "_"}, {"code": "repeated_accepted_taxons = (\n    pl.scan_csv(\"gbif/Taxon.tsv\", separator=\"\\t\", quote_char=None, cache=True)\n    .filter(pl.col(\"taxonomicStatus\") == pl.lit(\"accepted\"))\n    .filter(pl.col(\"kingdom\").is_in([\"Animalia\", \"Plantae\"]))\n    .filter(~pl.col(\"canonicalName\").is_null())\n    .filter(pl.col(\"canonicalName\") != \"\")\n    .sort(\"canonicalName\")\n    .filter(pl.col(\"canonicalName\").is_duplicated())\n)", "code_hash": "c7f3a3438d801f195ee5a1cc82d021b0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "priority_columns = [\n    \"infraspecificEpithet\",\n    \"specificEpithet\",\n    \"genus\",\n    \"family\",\n    \"order\",\n    \"class\",\n    \"phylum\",\n    \"kingdom\",\n]", "code_hash": "d63a3ea8b7e381b43a40de6296620085", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "_schema = {\n    \"feature_that_is_equal_to_canonicalName\": pl.String,\n    \"matches\": pl.String,\n}\ncollected_repeated_taxons = repeated_accepted_taxons.collect()\nRAT_interim = pl.DataFrame(schema=_schema)\nfor _col in priority_columns:\n    _canonical_names = (\n        collected_repeated_taxons.filter(\n            pl.col(\"canonicalName\") == pl.col(_col)\n        )\n        .select(\"canonicalName\")\n        .unique()\n        .to_series()\n        .to_list()\n    )\n    if len(_canonical_names) != 0:\n        _row = pl.DataFrame(\n            data={\n                \"feature_that_is_equal_to_canonicalName\": _col,\n                \"matches\": _canonical_names,\n            },\n            schema=_schema,\n        )\n        RAT_interim = RAT_interim.vstack(_row)\n\nRAT_feats = (\n    RAT_interim.group_by(\"matches\")\n    .agg(pl.col(\"feature_that_is_equal_to_canonicalName\").str.join(\", \"))\n    .with_columns(\n        pl.col(\"feature_that_is_equal_to_canonicalName\").str.split(\", \")\n    )\n    .sort(\"feature_that_is_equal_to_canonicalName\")\n)\nRAT_feats", "code_hash": "1142283d9fac0a5f2163f15eb03c663d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "updated_to_matching = []\nstill_no_match = []\n_collected_repeated_taxons = collected_repeated_taxons.fill_null(\"\")\n_reversed_priority_columns = priority_columns.copy()\n_reversed_priority_columns.reverse()\npl.Config.set_tbl_cols(10)\nfor _col in _reversed_priority_columns:\n    for _match in RAT_feats[\"matches\"]:\n        # skipping those that are not in RAT_feats\n        if _match not in no_match[_col].to_list():\n            continue\n\n        taxon_data_to_select_from = _collected_repeated_taxons.filter(\n            pl.col(\"canonicalName\") == _match\n        ).select([\"taxonID\"] + _reversed_priority_columns)\n\n        # Select from the two rows what taxon data to select.\n        selected_row_int = -1\n        for i, _tuple in enumerate(\n            taxon_data_to_select_from.select(\n                [\"taxonID\"] + priority_columns\n            ).iter_rows()\n        ):\n            col_index = priority_columns.index(_col)\n            _x = _tuple[col_index]\n            if not bool(_x):\n                selected_row_int = i  # Since there are usually only two rows from taxon_data_to_select_from, the results is either 0 or 1\n                break\n        assert selected_row_int != -1\n\n        # has_predicament1 is when kingdom to genus all has values and it is kind of leveled between the two rows of the taxon data.\n        has_predicament1 = False\n        _l = taxon_data_to_select_from[\"family\"].to_list()\n        if _col == \"genus\" and _l[0] is not None and _l[1] is not None:\n            has_predicament1 = True\n\n        chosen_taxonId = taxon_data_to_select_from[selected_row_int, 0]\n        other_taxonId = taxon_data_to_select_from[\n            int(\n                not bool(selected_row_int)\n            ),  # converts the int value into boolean than reverse the boolean before converting back to int.\n            0,\n        ]\n\n        # Getting the _no_match_subset_to_update section\n        _no_match_subset_to_update = no_match.filter(\n            pl.col(_col) == _match,\n        )\n        for _col3 in priority_columns[: priority_columns.index(_col)]:\n            _no_match_subset_to_update = _no_match_subset_to_update.filter(\n                pl.col(_col3) == \"\",\n            )\n        if not _no_match_subset_to_update.select(priority_columns).is_empty():\n            pass\n        else:\n            continue\n        _x = _reversed_priority_columns[:-3]\n        feature_to_find_nulls = (\n            _x[_reversed_priority_columns.index(_col) + 1]\n            if len(_x) > _reversed_priority_columns.index(_col) + 1\n            else None\n        )  # just the next feature to find null\n        if feature_to_find_nulls is not None:\n            _no_match_subset_to_update = _no_match_subset_to_update.filter(\n                pl.col(feature_to_find_nulls) == \"\"\n            )\n            # print(_no_match_subset_to_update)\n            # if _no_match_subset_to_update.is_empty():\n            #     still_no_match_subset = no_match.filter(\n            #         pl.col(_col) == _match, # This is the problme where there is too little matches in second matching wrangling\n            #     ).with_columns(\n            #         current_feature=pl.lit(_col), current_name=pl.lit(_match)\n            #     )\n            #     still_no_match.append(still_no_match_subset)\n            #     continue\n\n        # Settling predicament one\n        # this predicament thing should only happen when the subset is of only 1 row.\n        # has_predicament1 is when kingdom to genus all has values and it is kind of leveled between the two rows of the taxon data.\n        if has_predicament1 and _no_match_subset_to_update.shape[0] == 1:\n            match = True\n            for _col1 in [\n                \"class\",\n                \"order\",\n                \"family\",\n                \"genus\",\n                \"specificEpithet\",\n                \"infraspecificEpithet\",\n            ]:\n                match *= (\n                    _no_match_subset_to_update[_col1].item()\n                    == taxon_data_to_select_from[selected_row_int, :][\n                        _col1\n                    ].item()\n                )\n            if not match:\n                match = True\n                for _col1 in [\n                    \"class\",\n                    \"order\",\n                    \"family\",\n                    \"genus\",\n                    \"specificEpithet\",\n                    \"infraspecificEpithet\",\n                ]:\n                    match *= (\n                        _no_match_subset_to_update[_col1].item()\n                        == taxon_data_to_select_from[\n                            int(not bool(selected_row_int)), :\n                        ][_col1].item()\n                    )  # searching in the three columns of interests for matches\n\n                # assert (\n                #     match\n                # )  # Double check that there is no unmatch.  # noqa: E712\n                if match:\n                    temp = chosen_taxonId\n                    chosen_taxonId = other_taxonId\n                    other_taxonId = temp\n\n        # turning these rows to matching by filling parentNameUsageID\n        _no_match_subset_to_update = _no_match_subset_to_update.with_columns(\n            parentNameUsageID=pl.when(\n                (pl.col(\"infraspecificEpithet\").is_null())\n                & (pl.col(\"specificEpithet\").is_not_null())\n                & (pl.col(\"genus\").is_not_null())\n            )\n            .then(pl.lit(other_taxonId))\n            .otherwise(pl.lit(chosen_taxonId))\n        )\n\n        updated_to_matching.append(_no_match_subset_to_update)\n\n# turn them into dataframes and writing to csv files\nupdated_to_matching = pl.concat(\n    updated_to_matching, rechunk=True, parallel=True\n)\nupdated_to_matching.write_csv(\"first_matches_set_from_wrangling.csv\")\n\nstill_no_match = no_match.join(\n    updated_to_matching.select(\"speciesId\"), on=\"speciesId\", how=\"anti\"\n)", "code_hash": "067c876fb0489d3a76222beb5f61f1e1", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZHCJ", "name": "_"}, {"code": "updated_to_matching.select([\"speciesId\"] + priority_columns).filter(\n    pl.col(\"genus\") == \"Aonides\"\n)", "code_hash": "1245f1ca1a93c38922de3b66f1270003", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ROlb", "name": "_"}, {"code": "updated_to_matching.shape", "code_hash": "87f6d35379db1e98fc7bee6fd102aded", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "mpNS", "name": "_"}, {"code": "still_no_match", "code_hash": "378709255300318567048faf59c9484b", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "rtLE", "name": "_"}, {"code": "mo.md(r\"\"\"# Second Matching Wrangle\"\"\")", "code_hash": "ddb5f316ef72826d4b72561b97d0219e", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "qnkX", "name": "_"}, {"code": "taxons = (\n    pl.scan_csv(\"gbif/Taxon.tsv\", separator=\"\\t\", quote_char=None, cache=True)\n    .filter(\n        pl.col(\"taxonomicStatus\") == pl.lit(\"accepted\"),\n        pl.col(\"taxonRank\") != \"unranked\",\n    )\n    .filter(pl.col(\"kingdom\").is_in([\"Animalia\", \"Plantae\"]))\n    .select([\"taxonID\"] + priority_columns)\n)\n\n\ndef join_and_parentId_insertion(\n    match_on: pl.DataFrame, _taxons_subset: pl.DataFrame, on: list\n) -> pl.DataFrame:\n    return (\n        match_on.join(_taxons_subset, on=on)\n        .with_columns(\n            parentNameUsageID=pl.when(pl.col(\"taxonID\").is_not_null())\n            .then(\"taxonID\")\n            .otherwise(\"parentNameUsageID\")\n        )\n        .drop(\"taxonID\")\n    )", "code_hash": "a6d478b4bb7451122894fc9097b30c0d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TqIu", "name": "_"}, {"code": "mo.md(r\"\"\"##  matching for datapoints where phylumn to class ranks features are not empty strings\"\"\")", "code_hash": "6c0fd5673b6f66f9a59ad81c176301fd", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "Vxnm", "name": "_"}, {"code": "_filter_class = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") == \"\",\n    pl.col(\"family\") == \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\nmatch_on_class = still_no_match.with_columns(\n    name_to_match=pl.when(_filter_class).then(\"class\").otherwise(None)\n).filter(_filter_class)\n\n_x_class = (\n    still_no_match.filter(_filter_class)\n    .select(\"class\")\n    .group_by(\"class\")\n    .len()\n)\n\n_taxons_subset_class = (\n    taxons.filter(\n        pl.col(\"family\").is_null(),\n        pl.col(\"order\").is_null(),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"class\").is_in(_x_class[\"class\"].unique().to_list()),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n    )\n    .select(\"taxonID\", \"class\")\n    .collect()\n)\nmatch_on_class = join_and_parentId_insertion(\n    match_on_class, _taxons_subset_class, [\"class\"]\n)", "code_hash": "947bdf190644da888f9c683321003bd3", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "DnEU", "name": "_"}, {"code": "match_on_class.select([\"parentNameUsageID\", \"class\"]).sort(\"parentNameUsageID\")", "code_hash": "a7b0c5bc44884367e59b8121f4b13a99", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "HOkB", "name": "_"}, {"code": "match_on_class.select(\n    [\"speciesId\", \"taxonName\", \"parentNameUsageID\"] + priority_columns\n).sort(\"parentNameUsageID\").filter(pl.col(\"parentNameUsageID\") == 136)", "code_hash": "cf921335b6b8279ee21964e16b9b54c1", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TUOp", "name": "_"}, {"code": "mo.md(r\"\"\"## matching for datapoints where phylum to order ranks features are not empty strings\"\"\")", "code_hash": "7e22b9c47d1f06e39a5062eaadbd9539", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "ulZA", "name": "_"}, {"code": "_filter_order = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") == \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\nmatch_on_order = still_no_match.with_columns(\n    name_to_match=pl.when(_filter_order).then(\"order\").otherwise(None)\n).filter(_filter_order)\n_x_order = (\n    still_no_match.filter(_filter_order)\n    .select(\"order\")\n    .group_by(\"order\")\n    .len()\n)\n\n_taxons_subset_order = (\n    taxons.filter(\n        pl.col(\"family\").is_null(),\n        pl.col(\"order\").is_in(_x_order[\"order\"].unique().to_list()),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n    )\n    .select(\"taxonID\", \"order\")\n    .collect()\n)\nmatch_on_order = join_and_parentId_insertion(\n    match_on_order, _taxons_subset_order, [\"order\"]\n)", "code_hash": "a027c2491fbc4f302bb06436ab6321ea", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ecfG", "name": "_"}, {"code": "match_on_order.select([\"parentNameUsageID\", \"order\"]).sort(\"parentNameUsageID\")", "code_hash": "c7b125a42b75ef50d712956ed97f7ce0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "sVan", "name": "_"}, {"code": "match_on_order.select(\n    [\"speciesId\", \"taxonName\", \"parentNameUsageID\"] + priority_columns\n).sort(\"parentNameUsageID\").filter(pl.col(\"parentNameUsageID\") == 459)", "code_hash": "5cee40c60b8c977b3fbfe3f4cc64bf36", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "dimQ", "name": "_"}, {"code": "mo.md(r\"\"\"## matching for datapoints where phylum to family ranks features are not empty\"\"\")", "code_hash": "8e125e61486ef658592985431d2d6daa", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "Pvdt", "name": "_"}, {"code": "_filter_family = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\nmatch_on_family = still_no_match.with_columns(\n    name_to_match=pl.when(_filter_family).then(\"family\").otherwise(None)\n).filter(_filter_family)\n_x_family = (\n    still_no_match.filter(_filter_family)\n    .select(\"family\", \"order\")\n    .group_by(\"family\", \"order\")\n    .len()\n)\n\n_taxons_subset_family = (\n    taxons.filter(\n        pl.col(\"order\").is_in(_x_family[\"order\"].unique().to_list()),\n        pl.col(\"family\").is_in(_x_family[\"family\"].unique().to_list()),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n    )\n    .select(\"taxonID\", \"family\")\n    .collect()\n)\nmatch_on_family = join_and_parentId_insertion(\n    match_on_family, _taxons_subset_family, [\"family\"]\n)", "code_hash": "ab431a57a5886457a8398ad3b454e8f5", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZBYS", "name": "_"}, {"code": "match_on_family.select(\n    [\"speciesId\", \"taxonName\", \"parentNameUsageID\"] + priority_columns\n).sort(\"parentNameUsageID\")", "code_hash": "571c8ed2cc9879d16e11b8cd0bb6ee3d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "JoWz", "name": "_"}, {"code": "match_on_family.select(\n    [\"speciesId\", \"taxonName\", \"parentNameUsageID\"] + priority_columns\n).sort(\"parentNameUsageID\").filter(pl.col(\"parentNameUsageID\") == 2045)", "code_hash": "3f47edd106cf6c31b906f8a42c7f94f3", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "qvtn", "name": "_"}, {"code": "mo.md(r\"\"\"# matching for datapoints where phylum to genus ranks features are not empty strings\"\"\")", "code_hash": "cfdfb403305c567169098c5c4094fe9a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZKce", "name": "_"}, {"code": "_filter_genus = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\n\nto_be_match_on_genus = still_no_match.filter(_filter_genus)\n\n_x_genus = (\n    still_no_match.filter(_filter_genus)\n    .select(\"genus\")\n    .group_by(\"genus\")\n    .len()\n)\n\n_taxons_subset_genus = (\n    taxons.filter(\n        pl.col(\"genus\").is_in(_x_genus[\"genus\"].unique().to_list()),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n    )\n    .select(\"taxonID\", \"genus\")\n    .collect()\n)\nmatch_on_genus = join_and_parentId_insertion(\n    to_be_match_on_genus,\n    _taxons_subset_genus,\n    [\"genus\"],\n)", "code_hash": "cdb8447779ccf9604c08cf58a1530096", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "wFHQ", "name": "_"}, {"code": "match_on_genus.select(\n    [\"speciesId\", \"taxonName\", \"parentNameUsageID\"] + priority_columns\n).sort(\"parentNameUsageID\")", "code_hash": "c37de667395dfac85a495a78230afc2c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "JHrc", "name": "_"}, {"code": "match_on_genus.select(\n    [\"speciesId\", \"taxonName\", \"parentNameUsageID\"] + priority_columns\n).sort(\"parentNameUsageID\").filter(pl.col(\"parentNameUsageID\") == 1004617)", "code_hash": "efacd8c94b9bc071836db367d60b24d2", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "XGYj", "name": "_"}, {"code": "match_on_genus.select(\n    [\"speciesId\", \"taxonName\", \"parentNameUsageID\"] + priority_columns\n).filter(pl.col(\"taxonName\") == \"Paguristes sp. 1\").sort(\"parentNameUsageID\")", "code_hash": "4b897b06aac35fce92dc468f4bd36e1c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "AEvs", "name": "_"}, {"code": "match_on_genus.shape", "code_hash": "d837c302bbcd21e0375952f7ccb6dd5b", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "hdWg", "name": "_"}, {"code": "mo.md(r\"\"\"## matching for datapoints where phylum to specificEpithet ranks features are not empty strings\"\"\")", "code_hash": "c7552034078a79bae55dce93d34c8f10", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "aLJB", "name": "_"}, {"code": "_filter_specificEpithet = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"specificEpithet\") != \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\n\nto_be_match_on_specificEpithet = still_no_match.filter(_filter_specificEpithet)\n\n_x_specificEpithet = (\n    still_no_match.filter(_filter_specificEpithet)\n    .select(\"specificEpithet\", \"genus\")\n    .group_by(\"specificEpithet\", \"genus\")\n    .len()\n)\n\n_taxons_subset_specificEpithet = (\n    taxons.filter(\n        pl.col(\"specificEpithet\").is_in(\n            _x_specificEpithet[\"specificEpithet\"].unique().to_list()\n        ),\n        pl.col(\"genus\").is_in(_x_specificEpithet[\"genus\"].unique().to_list()),\n        pl.col(\"infraspecificEpithet\").is_not_null(),\n    )\n    .select(\"taxonID\", \"specificEpithet\", \"genus\")\n    .collect()\n)\nmatch_on_specificEpithet = join_and_parentId_insertion(\n    to_be_match_on_specificEpithet,\n    _taxons_subset_specificEpithet,\n    [\"specificEpithet\", \"genus\"],\n)", "code_hash": "34d5db8ae4f868b29bda3c21d2e86d40", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nHfw", "name": "_"}, {"code": "match_on_specificEpithet.select(\n    \"specificEpithet\", \"genus\", \"parentNameUsageID\"\n)", "code_hash": "f2be55d9e430707e307cd00d86327258", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nevo", "name": "_"}, {"code": "mo.md(r\"\"\"##matching for datapoints where phylum to infraspecificEpithet (Except for specificEpithet, no filters involved) ranks features are not empty strings.\"\"\")", "code_hash": "03ef130298a708ce26e48aa811b5a702", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "xXTn", "name": "_"}, {"code": "_filter_infraspecificEpithet = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"infraspecificEpithet\") != \"\",\n)  # different filter because some don't have specificEpithet either, if I am not wrong\nto_be_match_on_infraspecificEpithet = still_no_match.filter(\n    _filter_infraspecificEpithet\n)\n\n_x_infraspecificEpithet = (\n    still_no_match.filter(_filter_infraspecificEpithet)\n    .select(\"infraspecificEpithet\", \"genus\")\n    .group_by(\"infraspecificEpithet\", \"genus\")\n    .len()\n)\n\n_taxons_subset_infraspecificEpithet = (\n    taxons.filter(\n        pl.col(\"infraspecificEpithet\").is_in(\n            _x_infraspecificEpithet[\"infraspecificEpithet\"].unique().to_list()\n        ),\n        pl.col(\"genus\").is_in(\n            _x_infraspecificEpithet[\"genus\"].unique().to_list()\n        ),\n    )\n    .select(\"taxonID\", \"infraspecificEpithet\", \"genus\")\n    .collect()\n)\n\nmatch_on_infraspecificEpithet = join_and_parentId_insertion(\n    to_be_match_on_infraspecificEpithet,\n    _taxons_subset_infraspecificEpithet,\n    [\"infraspecificEpithet\", \"genus\"],\n)", "code_hash": "eba56862832e028ac74d188c02f9f6c8", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "AjVT", "name": "_"}, {"code": "match_on_infraspecificEpithet.select(\n    \"infraspecificEpithet\", \"specificEpithet\", \"genus\", \"parentNameUsageID\"\n).sort(\"parentNameUsageID\")", "code_hash": "6e1a08b51fae54682c8f56293eab151e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "AmCr", "name": "_"}, {"code": "mo.md(r\"\"\"## Combining all these second matching wrangling stage dataframes of the ranks\"\"\")", "code_hash": "8fa0ac3399b354d7dbfda99e19d5b2bb", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "pHFh", "name": "_"}, {"code": "_to_drop = [\"name_to_match\"]\nmatch_on_genus.write_csv(\"second_matches_set_for_genus_only.csv\")\n_new_match = pl.concat(\n    [\n        match_on_class.drop(_to_drop),\n        match_on_order.drop(_to_drop),\n        match_on_family.drop(_to_drop),\n        match_on_genus,\n        match_on_specificEpithet,\n        match_on_infraspecificEpithet,\n    ]\n)\nprint(\"second wrangle new matches\", _new_match.shape)\n_new_match.write_csv(\"second_matches_set_from_wrangling.csv\")\n_new_match = pl.concat(\n    [\n        _new_match,\n        updated_to_matching.with_columns(\n            pl.col(\"parentNameUsageID\").cast(pl.Int64)\n        ),\n    ]\n)\n_new_match.write_csv(\"updated_to_matching.csv\")\n_no_match = no_match.join(\n    _new_match.select(\"speciesId\"), on=\"speciesId\", how=\"anti\"\n)\nprint(\"all matches\", _new_match.shape)\nprint(\"no match\", _no_match.shape)\n_no_match.write_csv(\"no_match.csv\")", "code_hash": "5d248b4fe97e580c3854b19f3bf6b759", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "NCOB", "name": "_"}, {"code": "bos.shape", "code_hash": "d92d5e990f7cb0ade2bb83472bdfddaa", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ATqp", "name": "_"}], "metadata": {"marimo_version": "0.15.2"}, "version": "1"},
            "session": {"cells": [{"code_hash": "fef7f51634a67ed57cff77a654024693", "console": [], "id": "Hbol", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"introduction\">Introduction</h1>\n<span class=\"paragraph\">combination of r_translation.py script and more_r_translation.py marimo notebook. these olds scripts are under <code>old_files</code></span>\n<span class=\"paragraph\">for the second matching wrangle, the parts for specificEpithet and infraSpecificEpithet doesn't match with many results.</span>\n<h1 id=\"imports-and-initial-preprocessing\">Imports and Initial Preprocessing</h1></span>"}, "type": "data"}]}, {"code_hash": "ce4194fff5fe8b0eebb7a09769bc0473", "console": [], "id": "MJUe", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "aec531ea99fb89c31feec8ef0103e84a", "console": [], "id": "vblA", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "326926b50dfc5120bb2413c46973fe5f", "console": [], "id": "bkHC", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "740c615dabbd943e156e6d426dabb055", "console": [], "id": "lEQa", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "651051385bc53c333d98c016c1598f50", "console": [], "id": "PKri", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "89f397595c6d2ca65b548c18aa7846d1", "console": [], "id": "Xref", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "a24d137a18177e367f6e2921047bedbb", "console": [], "id": "Kclp", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "3ca094b96f6d720e9f2e6cb24585f57d", "console": [], "id": "emfo", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"first-matching-wrangle\">First Matching Wrangle</h1></span>"}, "type": "data"}]}, {"code_hash": "c7f3a3438d801f195ee5a1cc82d021b0", "console": [], "id": "Hstk", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d63a3ea8b7e381b43a40de6296620085", "console": [], "id": "nWHF", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "1142283d9fac0a5f2163f15eb03c663d", "console": [], "id": "iLit", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (1_639, 2)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>matches</th><th>feature_that_is_equal_to_canonicalName</th></tr><tr><td>str</td><td>list[str]</td></tr></thead><tbody><tr><td>&quot;Micrognathozoa&quot;</td><td>[&quot;class&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Passeriformes&quot;</td><td>[&quot;family&quot;, &quot;order&quot;]</td></tr><tr><td>&quot;Sirenia&quot;</td><td>[&quot;family&quot;, &quot;order&quot;]</td></tr><tr><td>&quot;Hildebrandtiella&quot;</td><td>[&quot;genus&quot;]</td></tr><tr><td>&quot;Bartramia&quot;</td><td>[&quot;genus&quot;]</td></tr><tr><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Diplura&quot;</td><td>[&quot;genus&quot;, &quot;order&quot;, &quot;class&quot;]</td></tr><tr><td>&quot;Acanthocephala&quot;</td><td>[&quot;genus&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Ctenophora&quot;</td><td>[&quot;genus&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Arthropoda&quot;</td><td>[&quot;genus&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Protura&quot;</td><td>[&quot;order&quot;, &quot;class&quot;]</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "067c876fb0489d3a76222beb5f61f1e1", "console": [], "id": "ZHCJ", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "1245f1ca1a93c38922de3b66f1270003", "console": [], "id": "ROlb", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (0, 9)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>genus</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "87f6d35379db1e98fc7bee6fd102aded", "console": [], "id": "mpNS", "outputs": [{"data": {"application/json": "[469, 27]"}, "type": "data"}]}, {"code_hash": "378709255300318567048faf59c9484b", "console": [], "id": "rtLE", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (8_101, 27)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>matched_taxonID</th><th>acceptedNameUsageID</th><th>taxonName</th><th>domain</th><th>&hellip;</th><th>specificEpithet</th><th>infraspecificEpithet</th><th>taxonRank</th><th>taxonomicStatus</th><th>parentNameUsageID</th></tr><tr><td>str</td><td>i64</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>null</td></tr></thead><tbody><tr><td>&quot;A-Anne-Clit-Hirudinea-000001&quot;</td><td>null</td><td>null</td><td>&quot;Glossiphoniidae sp. &quot;1&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000002&quot;</td><td>null</td><td>null</td><td>&quot;Glossiphoniidae sp. &quot;2&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000003&quot;</td><td>null</td><td>null</td><td>&quot;Glossiphoniidae sp. &quot;3&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000004&quot;</td><td>null</td><td>null</td><td>&quot;Hirudinidae sp. &quot;1&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000005&quot;</td><td>null</td><td>null</td><td>&quot;Hirudinidae sp. &quot;2&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;A-Hemi-Enteropneusta-000010&quot;</td><td>null</td><td>null</td><td>&quot;Acorn worm sp.&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Hemi-Enteropneusta-000011&quot;</td><td>null</td><td>null</td><td>&quot;Acorn worm sp.&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Phoronida-000002&quot;</td><td>null</td><td>null</td><td>&quot;Phoronida sp.&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Phoronida-000003&quot;</td><td>null</td><td>null</td><td>&quot;Phoronida sp. SEA-4090&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;B-Alga-Cyanobacteria-000003&quot;</td><td>null</td><td>null</td><td>&quot;Microcystis icthyoblabe&quot;</td><td>&quot;Eukarya&quot;</td><td>&hellip;</td><td>&quot;icthyoblabe&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "ddb5f316ef72826d4b72561b97d0219e", "console": [], "id": "qnkX", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"second-matching-wrangle\">Second Matching Wrangle</h1></span>"}, "type": "data"}]}, {"code_hash": "a6d478b4bb7451122894fc9097b30c0d", "console": [], "id": "TqIu", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "6c0fd5673b6f66f9a59ad81c176301fd", "console": [], "id": "Vxnm", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"matching-for-datapoints-where-phylumn-to-class-ranks-features-are-not-empty-strings\">matching for datapoints where phylumn to class ranks features are not empty strings</h2></span>"}, "type": "data"}]}, {"code_hash": "947bdf190644da888f9c683321003bd3", "console": [], "id": "DnEU", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "a7b0c5bc44884367e59b8121f4b13a99", "console": [], "id": "HOkB", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (572, 2)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>parentNameUsageID</th><th>class</th></tr><tr><td>i64</td><td>str</td></tr></thead><tbody><tr><td>136</td><td>&quot;Cephalopoda&quot;</td></tr><tr><td>136</td><td>&quot;Cephalopoda&quot;</td></tr><tr><td>136</td><td>&quot;Cephalopoda&quot;</td></tr><tr><td>136</td><td>&quot;Cephalopoda&quot;</td></tr><tr><td>137</td><td>&quot;Bivalvia&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td></tr><tr><td>11545536</td><td>&quot;Copepoda&quot;</td></tr><tr><td>11545536</td><td>&quot;Copepoda&quot;</td></tr><tr><td>11545536</td><td>&quot;Copepoda&quot;</td></tr><tr><td>11545536</td><td>&quot;Copepoda&quot;</td></tr><tr><td>11545536</td><td>&quot;Copepoda&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "cf921335b6b8279ee21964e16b9b54c1", "console": [], "id": "TUOp", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (4, 11)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>taxonName</th><th>parentNameUsageID</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>&hellip;</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;A-Moll-Cephalopoda-000012&quot;</td><td>&quot;Squid eggs&quot;</td><td>136</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000062&quot;</td><td>&quot;Squid eggs sp 2&quot;</td><td>136</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000021&quot;</td><td>&quot;Squid sp. 1&quot;</td><td>136</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000032&quot;</td><td>&quot;Squid sp. 2&quot;</td><td>136</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "7e22b9c47d1f06e39a5062eaadbd9539", "console": [], "id": "ulZA", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"matching-for-datapoints-where-phylum-to-order-ranks-features-are-not-empty-strings\">matching for datapoints where phylum to order ranks features are not empty strings</h2></span>"}, "type": "data"}]}, {"code_hash": "a027c2491fbc4f302bb06436ab6321ea", "console": [], "id": "ecfG", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c7b125a42b75ef50d712956ed97f7ce0", "console": [], "id": "sVan", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (1_189, 2)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>parentNameUsageID</th><th>order</th></tr><tr><td>i64</td><td>str</td></tr></thead><tbody><tr><td>459</td><td>&quot;Octopoda&quot;</td></tr><tr><td>459</td><td>&quot;Octopoda&quot;</td></tr><tr><td>459</td><td>&quot;Octopoda&quot;</td></tr><tr><td>459</td><td>&quot;Octopoda&quot;</td></tr><tr><td>459</td><td>&quot;Octopoda&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td></tr><tr><td>12202578</td><td>&quot;Scleralcyonacea&quot;</td></tr><tr><td>12202578</td><td>&quot;Scleralcyonacea&quot;</td></tr><tr><td>12202578</td><td>&quot;Scleralcyonacea&quot;</td></tr><tr><td>12202578</td><td>&quot;Scleralcyonacea&quot;</td></tr><tr><td>12202578</td><td>&quot;Scleralcyonacea&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "5cee40c60b8c977b3fbfe3f4cc64bf36", "console": [], "id": "dimQ", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (35, 11)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>taxonName</th><th>parentNameUsageID</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>&hellip;</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;A-Moll-Cephalopoda-000064&quot;</td><td>&quot;Octopus sp.&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000065&quot;</td><td>&quot;Octopus sp.&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000066&quot;</td><td>&quot;Octopus sp.&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000067&quot;</td><td>&quot;Octopus sp.&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000068&quot;</td><td>&quot;Octopus sp.&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000041&quot;</td><td>&quot;Octopus sp. 6&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000042&quot;</td><td>&quot;Octopus sp. 7&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000043&quot;</td><td>&quot;Octopus sp. 8&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000044&quot;</td><td>&quot;Octopus sp. 9&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Moll-Cephalopoda-000063&quot;</td><td>&quot;Octopus sp. SS-4372&quot;</td><td>459</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;&quot;</td><td>&quot;Octopoda&quot;</td><td>&quot;Cephalopoda&quot;</td><td>&quot;Mollusca&quot;</td><td>&quot;Animalia&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "8e125e61486ef658592985431d2d6daa", "console": [], "id": "Pvdt", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"matching-for-datapoints-where-phylum-to-family-ranks-features-are-not-empty\">matching for datapoints where phylum to family ranks features are not empty</h2></span>"}, "type": "data"}]}, {"code_hash": "ab431a57a5886457a8398ad3b454e8f5", "console": [], "id": "ZBYS", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "571c8ed2cc9879d16e11b8cd0bb6ee3d", "console": [], "id": "JoWz", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (2_763, 11)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>taxonName</th><th>parentNameUsageID</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>&hellip;</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;A-Arth-Crus-Isopoda-000023&quot;</td><td>&quot;Sphaeromatidae sp. 1&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000024&quot;</td><td>&quot;Sphaeromatidae sp. 2&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000025&quot;</td><td>&quot;Sphaeromatidae sp. 3&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000026&quot;</td><td>&quot;Sphaeromatidae sp. 4&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000027&quot;</td><td>&quot;Sphaeromatidae sp. 5&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-002917&quot;</td><td>&quot;Sphaeroceridae sp. ZRC_BDP0294\u2026</td><td>11928281</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeroceridae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-002918&quot;</td><td>&quot;Sphaeroceridae sp. ZRC_BDP0303\u2026</td><td>11928281</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeroceridae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-002919&quot;</td><td>&quot;Sphaeroceridae sp. ZRC_BDP0309\u2026</td><td>11928281</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeroceridae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-002920&quot;</td><td>&quot;Sphaeroceridae sp. ZRC_BDP0310\u2026</td><td>11928281</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeroceridae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-003078&quot;</td><td>&quot;Sphaeroceridae sp. ZRC_MIS0000\u2026</td><td>11928281</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeroceridae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "3f47edd106cf6c31b906f8a42c7f94f3", "console": [], "id": "qvtn", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (48, 11)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>taxonName</th><th>parentNameUsageID</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>&hellip;</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;A-Arth-Crus-Isopoda-000023&quot;</td><td>&quot;Sphaeromatidae sp. 1&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000024&quot;</td><td>&quot;Sphaeromatidae sp. 2&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000025&quot;</td><td>&quot;Sphaeromatidae sp. 3&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000026&quot;</td><td>&quot;Sphaeromatidae sp. 4&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000027&quot;</td><td>&quot;Sphaeromatidae sp. 5&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000145&quot;</td><td>&quot;Sphaeromatidae sp. 44&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000146&quot;</td><td>&quot;Sphaeromatidae sp. 45&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000147&quot;</td><td>&quot;Sphaeromatidae sp. 46&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000148&quot;</td><td>&quot;Sphaeromatidae sp. 47&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Crus-Isopoda-000149&quot;</td><td>&quot;Sphaeromatidae sp. 48&quot;</td><td>2045</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Sphaeromatidae&quot;</td><td>&quot;Isopoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "cfdfb403305c567169098c5c4094fe9a", "console": [], "id": "ZKce", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"matching-for-datapoints-where-phylum-to-genus-ranks-features-are-not-empty-strings\">matching for datapoints where phylum to genus ranks features are not empty strings</h1></span>"}, "type": "data"}]}, {"code_hash": "cdb8447779ccf9604c08cf58a1530096", "console": [], "id": "wFHQ", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c37de667395dfac85a495a78230afc2c", "console": [], "id": "JHrc", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (2_633, 11)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>taxonName</th><th>parentNameUsageID</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>&hellip;</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;A-Bryozoa-000006&quot;</td><td>&quot;Celleporaria sp.&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Bryozoa-000041&quot;</td><td>&quot;Celleporaria sp. 2&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Bryozoa-000042&quot;</td><td>&quot;Celleporaria sp. 3&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Bryozoa-000043&quot;</td><td>&quot;Celleporaria sp. 4&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Bryozoa-000012&quot;</td><td>&quot;Triphyllozoon sp.&quot;</td><td>1004892</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Phidoloporidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-002483&quot;</td><td>&quot;Siphona (Asiphona) sp. ZRC_BDP\u2026</td><td>11592210</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Tachinidae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-002613&quot;</td><td>&quot;Siphona (Asiphona) sp. ZRC_BDP\u2026</td><td>11592210</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Tachinidae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-002618&quot;</td><td>&quot;Siphona (Asiphona) sp. ZRC_BDP\u2026</td><td>11592210</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Tachinidae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-001083&quot;</td><td>&quot;Dexia sp. (vittata?) ZRC_BDP00\u2026</td><td>11946306</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Tachinidae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Arth-Hexa-Diptera-000091&quot;</td><td>&quot;Tanytarsus sp. &quot;GC40&quot;&quot;</td><td>12175832</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Chironomidae&quot;</td><td>&quot;Diptera&quot;</td><td>&quot;Insecta&quot;</td><td>&quot;Arthopoda&quot;</td><td>&quot;Animalia&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "efacd8c94b9bc071836db367d60b24d2", "console": [], "id": "XGYj", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (4, 11)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>taxonName</th><th>parentNameUsageID</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>&hellip;</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;A-Bryozoa-000006&quot;</td><td>&quot;Celleporaria sp.&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Bryozoa-000041&quot;</td><td>&quot;Celleporaria sp. 2&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Bryozoa-000042&quot;</td><td>&quot;Celleporaria sp. 3&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr><tr><td>&quot;A-Bryozoa-000043&quot;</td><td>&quot;Celleporaria sp. 4&quot;</td><td>1004617</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Lepraliellidae&quot;</td><td>&quot;Cheilostomatida&quot;</td><td>&quot;Gymnolaemata&quot;</td><td>&quot;Bryozoa&quot;</td><td>&quot;Animalia&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "4b897b06aac35fce92dc468f4bd36e1c", "console": [], "id": "AEvs", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (1, 11)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>taxonName</th><th>parentNameUsageID</th><th>infraspecificEpithet</th><th>specificEpithet</th><th>&hellip;</th><th>family</th><th>order</th><th>class</th><th>phylum</th><th>kingdom</th></tr><tr><td>str</td><td>str</td><td>i64</td><td>str</td><td>str</td><td>&hellip;</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;A-Arth-Crus-Decapoda-000285&quot;</td><td>&quot;Paguristes sp. 1&quot;</td><td>2224457</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&hellip;</td><td>&quot;Diogenidae&quot;</td><td>&quot;Decapoda&quot;</td><td>&quot;Malacostraca&quot;</td><td>&quot;Arthropoda&quot;</td><td>&quot;Animalia&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "d837c302bbcd21e0375952f7ccb6dd5b", "console": [], "id": "hdWg", "outputs": [{"data": {"application/json": "[2633, 27]"}, "type": "data"}]}, {"code_hash": "c7552034078a79bae55dce93d34c8f10", "console": [], "id": "aLJB", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"matching-for-datapoints-where-phylum-to-specificepithet-ranks-features-are-not-empty-strings\">matching for datapoints where phylum to specificEpithet ranks features are not empty strings</h2></span>"}, "type": "data"}]}, {"code_hash": "34d5db8ae4f868b29bda3c21d2e86d40", "console": [], "id": "nHfw", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "f2be55d9e430707e307cd00d86327258", "console": [], "id": "nevo", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (0, 3)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>specificEpithet</th><th>genus</th><th>parentNameUsageID</th></tr><tr><td>str</td><td>str</td><td>i64</td></tr></thead><tbody></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "03ef130298a708ce26e48aa811b5a702", "console": [], "id": "xXTn", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"matching-for-datapoints-where-phylum-to-infraspecificepithet-except-for-specificepithet-no-filters-involved-ranks-features-are-not-empty-strings\">matching for datapoints where phylum to infraspecificEpithet (Except for specificEpithet, no filters involved) ranks features are not empty strings.</h2></span>"}, "type": "data"}]}, {"code_hash": "eba56862832e028ac74d188c02f9f6c8", "console": [], "id": "AjVT", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "6e1a08b51fae54682c8f56293eab151e", "console": [], "id": "AmCr", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (20, 4)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>infraspecificEpithet</th><th>specificEpithet</th><th>genus</th><th>parentNameUsageID</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td></tr></thead><tbody><tr><td>&quot;bina&quot;</td><td>&quot;besta&quot;</td><td>&quot;Telicota&quot;</td><td>6204724</td></tr><tr><td>&quot;cresina&quot;</td><td>&quot;leucoporos&quot;</td><td>&quot;Neptis&quot;</td><td>6224905</td></tr><tr><td>&quot;tisamenus&quot;</td><td>&quot;schreiber&quot;</td><td>&quot;Polyura&quot;</td><td>6233167</td></tr><tr><td>&quot;barthema&quot;</td><td>&quot;suffusa&quot;</td><td>&quot;Rapala&quot;</td><td>6236869</td></tr><tr><td>&quot;phanda&quot;</td><td>&quot;phanda&quot;</td><td>&quot;Arhopala&quot;</td><td>6237141</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;distanti&quot;</td><td>&quot;panda&quot;</td><td>&quot;Saletara&quot;</td><td>11488355</td></tr><tr><td>&quot;modesta&quot;</td><td>&quot;monacha&quot;</td><td>&quot;Taeniodera&quot;</td><td>11747532</td></tr><tr><td>&quot;ruficollis&quot;</td><td>&quot;amphyrysus&quot;</td><td>&quot;Troides&quot;</td><td>11764150</td></tr><tr><td>&quot;emas&quot;</td><td>&quot;major&quot;</td><td>&quot;Catapaecilma&quot;</td><td>11849200</td></tr><tr><td>&quot;cresina&quot;</td><td>&quot;leucoporos&quot;</td><td>&quot;Neptis&quot;</td><td>11890274</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "8fa0ac3399b354d7dbfda99e19d5b2bb", "console": [], "id": "pHFh", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"combining-all-these-second-matching-wrangling-stage-dataframes-of-the-ranks\">Combining all these second matching wrangling stage dataframes of the ranks</h2></span>"}, "type": "data"}]}, {"code_hash": "5d248b4fe97e580c3854b19f3bf6b759", "console": [{"name": "stdout", "text": "second wrangle new matches (7177, 27)\n", "type": "stream"}, {"name": "stdout", "text": "all matches (7646, 27)\nno match (1567, 27)\n", "type": "stream"}], "id": "NCOB", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d92d5e990f7cb0ade2bb83472bdfddaa", "console": [], "id": "ATqp", "outputs": [{"data": {"application/json": "[13103, 61]"}, "type": "data"}]}], "metadata": {"marimo_version": "0.15.2"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.15.2%22%0Aapp%20%3D%20marimo.App(width%3D%22full%22)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Introduction%20%20%0A%0A%20%20%20%20combination%20of%20r_translation.py%20script%20and%20more_r_translation.py%20marimo%20notebook.%20these%20olds%20scripts%20are%20under%20%60old_files%60%0A%0A%20%20%20%20for%20the%20second%20matching%20wrangle%2C%20the%20parts%20for%20specificEpithet%20and%20infraSpecificEpithet%20doesn't%20match%20with%20many%20results.%0A%0A%20%20%20%20%23%20Imports%20and%20Initial%20Preprocessing%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20polars%20as%20pl%0A%20%20%20%20return%20mo%2C%20pl%0A%0A%0A%40app.cell%0Adef%20_(pl)%3A%0A%20%20%20%20bos%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.read_csv(%22bos.csv%22)%0A%20%20%20%20%20%20%20%20.rename(%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22data%20cleanup%20changes%22%3A%20%22data%20cleanup%20changes%201%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22species%22%3A%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22subspecies%22%3A%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22domain%20%22%3A%20%22domain%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(pl.col(pl.String).str.strip_chars(%22%20%22))%0A%20%20%20%20%20%20%20%20.with_columns(genericName%3Dpl.col(%22genus%22))%0A%20%20%20%20)%0A%20%20%20%20return%20(bos%2C)%0A%0A%0A%40app.cell%0Adef%20_(bos)%3A%0A%20%20%20%20null_counts%20%3D%20(%0A%20%20%20%20%20%20%20%20bos.null_count()%0A%20%20%20%20%20%20%20%20.transpose(include_header%3DTrue)%0A%20%20%20%20%20%20%20%20.rename(%7B%22column%22%3A%20%22feature%22%2C%20%22column_0%22%3A%20%22len%22%7D)%0A%20%20%20%20)%0A%20%20%20%20columns_to_drop_as_all_nulls%20%3D%20(%0A%20%20%20%20%20%20%20%20null_counts.filter(null_counts%5B%22len%22%5D%20%3D%3D%20bos.shape%5B0%5D)%0A%20%20%20%20%20%20%20%20.transpose()%5B0%2C%20%3A%5D%0A%20%20%20%20%20%20%20%20.transpose()%0A%20%20%20%20%20%20%20%20.to_series()%0A%20%20%20%20%20%20%20%20.to_list()%0A%20%20%20%20)%0A%20%20%20%20return%20(columns_to_drop_as_all_nulls%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20columns_to_drop_as_they_are_just_changes_logs%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%22cleanup%20changes%20%22%2C%0A%20%20%20%20%20%20%20%20%22Data%20cleanup%20changes%22%2C%0A%20%20%20%20%20%20%20%20%22data%20cleanup%20changes%201%22%2C%0A%20%20%20%20%20%20%20%20%22changes%22%2C%0A%20%20%20%20%20%20%20%20%22cleanup%20changes%22%2C%0A%20%20%20%20%20%20%20%20%22Unnamed%3A%2018%22%2C%0A%20%20%20%20%20%20%20%20%22Unnamed%3A%2017%22%2C%0A%20%20%20%20%20%20%20%20%22Unnamed%3A%2019%22%2C%0A%20%20%20%20%20%20%20%20%22query%22%2C%0A%20%20%20%20%20%20%20%20%22query%20%22%2C%0A%20%20%20%20%20%20%20%20%22issue%22%2C%0A%20%20%20%20%20%20%20%20%22cleanup%20changes%2Fcomments%22%2C%0A%20%20%20%20%20%20%20%20%22subphylum%22%2C%0A%20%20%20%20%5D%0A%20%20%20%20return%20(columns_to_drop_as_they_are_just_changes_logs%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20bos%2C%0A%20%20%20%20columns_to_drop_as_all_nulls%2C%0A%20%20%20%20columns_to_drop_as_they_are_just_changes_logs%2C%0A%20%20%20%20pl%2C%0A)%3A%0A%20%20%20%20bos_cleaned%20%3D%20(%0A%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20bos.drop(columns_to_drop_as_all_nulls)%0A%20%20%20%20%20%20%20%20%20%20%20%20.drop(columns_to_drop_as_they_are_just_changes_logs)%0A%20%20%20%20%20%20%20%20%20%20%20%20.select(~pl.selectors.starts_with(%22Unnamed%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20infraspecificEpithet%3Dpl.when(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22infraspecificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20infraspecificEpithet%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Glenea%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22mathemathica%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22mathematica%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22infraspecificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20specificEpithet%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Glenea%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22mathemathica%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22mathematica%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Bavia%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22sexupunctata%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22sexpunctata%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Omoedus%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22ephippigera%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22ephippiger%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Byblis%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22kallartha%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22kallarthra%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Alcockpenaeopsis%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22hungerfordi%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22hungerfordii%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Pseudosesarma%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22edwardsi%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22edwardsii%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Urocaridella%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22antonbruuni%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22antonbruunii%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Ocypode%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22cordimanus%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22cordimana%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22specificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20domain%3Dpl.lit(%22Eukarya%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kingdom%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22phylum%22).is_in(%5B%22Ascomycota%22%2C%20%22Basidiomycota%22%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22fungi%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(pl.col(%22phylum%22)%20%3D%3D%20%22Cyanobacteria%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22Bacteria%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(pl.col(%22phylum%22)%20%3D%3D%20%22Ciliophora%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22Protista%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.lit(%22Animalia%22))%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonName%3Dpl.col(%22taxonName%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.str.replace_all(%22%3Ci%3E%22%2C%20%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.str.replace_all(%22%3C%2Fi%3E%22%2C%20%22%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20return%20(bos_cleaned%2C)%0A%0A%0A%40app.cell%0Adef%20_(pl)%3A%0A%20%20%20%20_filter%20%3D%20pl.col(%22taxonomicStatus%22).is_in(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22accepted%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22synonym%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22homotypic%20synonym%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22proparte%20synonym%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22heterotypic%20synonym%22%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20taxon_ranked_only%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22gbif%2FTaxon.tsv%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20separator%3D%22%5Ct%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20quote_char%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20cache%3DTrue%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.filter((pl.col(%22taxonRank%22)%20!%3D%20%22unranked%22)%20%26%20_filter)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genericName%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonomicStatus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22acceptedNameUsageID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20%22domain%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.filter((pl.col(%22genus%22)%20!%3D%20%22%22)%20%26%20(pl.col(%22specificEpithet%22)%20!%3D%20%22%22))%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20infraspecificEpithet%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22infraspecificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20taxon_ranked_only%20%3D%20taxon_ranked_only.with_columns(%0A%20%20%20%20%20%20%20%20genus%3Dpl.when(pl.col(%22genus%22).is_null())%0A%20%20%20%20%20%20%20%20.then(%22genericName%22)%0A%20%20%20%20%20%20%20%20.otherwise(%22genus%22)%0A%20%20%20%20)%0A%20%20%20%20return%20(taxon_ranked_only%2C)%0A%0A%0A%40app.cell%0Adef%20_(bos_cleaned%2C%20pl%2C%20taxon_ranked_only)%3A%0A%20%20%20%20matching%20%3D%20(%0A%20%20%20%20%20%20%20%20taxon_ranked_only.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20other%3Dpl.LazyFrame(bos_cleaned)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%5B%22genus%22%2C%20%22specificEpithet%22%2C%20%22infraspecificEpithet%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22right%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.rename(%7B%22taxonID%22%3A%20%22matched_taxonID%22%7D)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22speciesId%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22matched_taxonID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22acceptedNameUsageID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonName%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22domain%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22kingdom%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22phylum%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22class%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subclass%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22superorder%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22order%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22sub-order%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraorder%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22section%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subsection%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22superfamily%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22family%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subfamily%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22tribe%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subgenus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genericName%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(None))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22infraspecificEpithet%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22infraspecificEpithet%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20%23%20matching%20and%20contetnious%20split%0A%20%20%20%20%23%20What%20makes%20a%20data%20point%20contentious%20is%20where%20it%20has%20duplicate%20speciesId.%0A%20%20%20%20matching%20%3D%20matching.filter(~pl.col(%22speciesId%22).is_duplicated()).with_columns(%0A%20%20%20%20%20%20%20%20acceptedNameUsageID%3Dpl.col(%22acceptedNameUsageID%22)%0A%20%20%20%20%20%20%20%20.fill_null(pl.lit(None))%0A%20%20%20%20%20%20%20%20.cast(pl.Int64)%0A%20%20%20%20)%0A%20%20%20%20contentious%20%3D%20matching.filter(%0A%20%20%20%20%20%20%20%20(pl.col(%22speciesId%22).is_duplicated())%0A%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20acceptedNameUsageID%3Dpl.col(%22acceptedNameUsageID%22)%0A%20%20%20%20%20%20%20%20.fill_null(pl.lit(None))%0A%20%20%20%20%20%20%20%20.cast(pl.Int64)%0A%20%20%20%20)%0A%0A%20%20%20%20unique_contentious%20%3D%20contentious.filter(%0A%20%20%20%20%20%20%20%20(pl.col(%22acceptedNameUsageID%22).is_null())%0A%20%20%20%20%20%20%20%20%26%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22matched_taxonID%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22acceptedNameUsageID%22).implode()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20unique_contentious_speciesId%20%3D%20(%0A%20%20%20%20%20%20%20%20unique_contentious.select(%22speciesId%22).collect().to_series().implode()%0A%20%20%20%20)%20%20%23%20Just%20the%20speciesIds%0A%20%20%20%20contentious%20%3D%20contentious.filter(%0A%20%20%20%20%20%20%20%20~pl.col(%22speciesId%22).is_in(unique_contentious_speciesId)%0A%20%20%20%20)%20%20%23%20Removing%20unique%20conentious%0A%0A%20%20%20%20matching%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5Bmatching%2C%20unique_contentious%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20matching%20%3D%20matching.with_columns(%0A%20%20%20%20%20%20%20%20genus%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genus%22).is_null())%20%26%20(pl.col(%22specificEpithet%22).is_not_null())%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.then(pl.col(%22taxonName%22).str.split(%22%20%22).list%5B0%5D)%0A%20%20%20%20%20%20%20%20.otherwise(%22genus%22)%0A%20%20%20%20)%0A%0A%20%20%20%20no_match%20%3D%20(%0A%20%20%20%20%20%20%20%20matching.filter(pl.col(%22matched_taxonID%22).is_null())%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonRank%3Dpl.lit(%22BOSuncornirmedSpecies%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonomicStatus%3Dpl.lit(%22BOSunformired%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.lit(None)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.fill_null(%22%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20return%20(no_match%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%20First%20Matching%20Wrangle%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl)%3A%0A%20%20%20%20repeated_accepted_taxons%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%22gbif%2FTaxon.tsv%22%2C%20separator%3D%22%5Ct%22%2C%20quote_char%3DNone%2C%20cache%3DTrue)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22taxonomicStatus%22)%20%3D%3D%20pl.lit(%22accepted%22))%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22kingdom%22).is_in(%5B%22Animalia%22%2C%20%22Plantae%22%5D))%0A%20%20%20%20%20%20%20%20.filter(~pl.col(%22canonicalName%22).is_null())%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22canonicalName%22)%20!%3D%20%22%22)%0A%20%20%20%20%20%20%20%20.sort(%22canonicalName%22)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22canonicalName%22).is_duplicated())%0A%20%20%20%20)%0A%20%20%20%20return%20(repeated_accepted_taxons%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20priority_columns%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%22family%22%2C%0A%20%20%20%20%20%20%20%20%22order%22%2C%0A%20%20%20%20%20%20%20%20%22class%22%2C%0A%20%20%20%20%20%20%20%20%22phylum%22%2C%0A%20%20%20%20%20%20%20%20%22kingdom%22%2C%0A%20%20%20%20%5D%0A%20%20%20%20return%20(priority_columns%2C)%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20priority_columns%2C%20repeated_accepted_taxons)%3A%0A%20%20%20%20_schema%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22feature_that_is_equal_to_canonicalName%22%3A%20pl.String%2C%0A%20%20%20%20%20%20%20%20%22matches%22%3A%20pl.String%2C%0A%20%20%20%20%7D%0A%20%20%20%20collected_repeated_taxons%20%3D%20repeated_accepted_taxons.collect()%0A%20%20%20%20RAT_interim%20%3D%20pl.DataFrame(schema%3D_schema)%0A%20%20%20%20for%20_col%20in%20priority_columns%3A%0A%20%20%20%20%20%20%20%20_canonical_names%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20collected_repeated_taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22canonicalName%22)%20%3D%3D%20pl.col(_col)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.select(%22canonicalName%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.unique()%0A%20%20%20%20%20%20%20%20%20%20%20%20.to_series()%0A%20%20%20%20%20%20%20%20%20%20%20%20.to_list()%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20if%20len(_canonical_names)%20!%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_row%20%3D%20pl.DataFrame(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22feature_that_is_equal_to_canonicalName%22%3A%20_col%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22matches%22%3A%20_canonical_names%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20schema%3D_schema%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20RAT_interim%20%3D%20RAT_interim.vstack(_row)%0A%0A%20%20%20%20RAT_feats%20%3D%20(%0A%20%20%20%20%20%20%20%20RAT_interim.group_by(%22matches%22)%0A%20%20%20%20%20%20%20%20.agg(pl.col(%22feature_that_is_equal_to_canonicalName%22).str.join(%22%2C%20%22))%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22feature_that_is_equal_to_canonicalName%22).str.split(%22%2C%20%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.sort(%22feature_that_is_equal_to_canonicalName%22)%0A%20%20%20%20)%0A%20%20%20%20RAT_feats%0A%20%20%20%20return%20RAT_feats%2C%20collected_repeated_taxons%0A%0A%0A%40app.cell%0Adef%20_(RAT_feats%2C%20collected_repeated_taxons%2C%20no_match%2C%20pl%2C%20priority_columns)%3A%0A%20%20%20%20updated_to_matching%20%3D%20%5B%5D%0A%20%20%20%20still_no_match%20%3D%20%5B%5D%0A%20%20%20%20_collected_repeated_taxons%20%3D%20collected_repeated_taxons.fill_null(%22%22)%0A%20%20%20%20_reversed_priority_columns%20%3D%20priority_columns.copy()%0A%20%20%20%20_reversed_priority_columns.reverse()%0A%20%20%20%20pl.Config.set_tbl_cols(10)%0A%20%20%20%20for%20_col%20in%20_reversed_priority_columns%3A%0A%20%20%20%20%20%20%20%20for%20_match%20in%20RAT_feats%5B%22matches%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20skipping%20those%20that%20are%20not%20in%20RAT_feats%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20_match%20not%20in%20no_match%5B_col%5D.to_list()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20taxon_data_to_select_from%20%3D%20_collected_repeated_taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22canonicalName%22)%20%3D%3D%20_match%0A%20%20%20%20%20%20%20%20%20%20%20%20).select(%5B%22taxonID%22%5D%20%2B%20_reversed_priority_columns)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Select%20from%20the%20two%20rows%20what%20taxon%20data%20to%20select.%0A%20%20%20%20%20%20%20%20%20%20%20%20selected_row_int%20%3D%20-1%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20_tuple%20in%20enumerate(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20taxon_data_to_select_from.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%22taxonID%22%5D%20%2B%20priority_columns%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).iter_rows()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20col_index%20%3D%20priority_columns.index(_col)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x%20%3D%20_tuple%5Bcol_index%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20bool(_x)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20selected_row_int%20%3D%20i%20%20%23%20Since%20there%20are%20usually%20only%20two%20rows%20from%20taxon_data_to_select_from%2C%20the%20results%20is%20either%200%20or%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20assert%20selected_row_int%20!%3D%20-1%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20has_predicament1%20is%20when%20kingdom%20to%20genus%20all%20has%20values%20and%20it%20is%20kind%20of%20leveled%20between%20the%20two%20rows%20of%20the%20taxon%20data.%0A%20%20%20%20%20%20%20%20%20%20%20%20has_predicament1%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20_l%20%3D%20taxon_data_to_select_from%5B%22family%22%5D.to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20_col%20%3D%3D%20%22genus%22%20and%20_l%5B0%5D%20is%20not%20None%20and%20_l%5B1%5D%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20has_predicament1%20%3D%20True%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20chosen_taxonId%20%3D%20taxon_data_to_select_from%5Bselected_row_int%2C%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20other_taxonId%20%3D%20taxon_data_to_select_from%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20int(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20not%20bool(selected_row_int)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%20%20%23%20converts%20the%20int%20value%20into%20boolean%20than%20reverse%20the%20boolean%20before%20converting%20back%20to%20int.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Getting%20the%20_no_match_subset_to_update%20section%0A%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20no_match.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(_col)%20%3D%3D%20_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20_col3%20in%20priority_columns%5B%3A%20priority_columns.index(_col)%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20_no_match_subset_to_update.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(_col3)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20_no_match_subset_to_update.select(priority_columns).is_empty()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pass%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%20%20%20%20%20%20%20%20%20%20%20%20_x%20%3D%20_reversed_priority_columns%5B%3A-3%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20feature_to_find_nulls%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x%5B_reversed_priority_columns.index(_col)%20%2B%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20len(_x)%20%3E%20_reversed_priority_columns.index(_col)%20%2B%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20)%20%20%23%20just%20the%20next%20feature%20to%20find%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20feature_to_find_nulls%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20_no_match_subset_to_update.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(feature_to_find_nulls)%20%3D%3D%20%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20print(_no_match_subset_to_update)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20if%20_no_match_subset_to_update.is_empty()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20still_no_match_subset%20%3D%20no_match.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20%20%20%20%20pl.col(_col)%20%3D%3D%20_match%2C%20%23%20This%20is%20the%20problme%20where%20there%20is%20too%20little%20matches%20in%20second%20matching%20wrangling%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20%20%20%20%20current_feature%3Dpl.lit(_col)%2C%20current_name%3Dpl.lit(_match)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20still_no_match.append(still_no_match_subset)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20continue%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Settling%20predicament%20one%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20this%20predicament%20thing%20should%20only%20happen%20when%20the%20subset%20is%20of%20only%201%20row.%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20has_predicament1%20is%20when%20kingdom%20to%20genus%20all%20has%20values%20and%20it%20is%20kind%20of%20leveled%20between%20the%20two%20rows%20of%20the%20taxon%20data.%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20has_predicament1%20and%20_no_match_subset_to_update.shape%5B0%5D%20%3D%3D%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20_col1%20in%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22class%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22order%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22family%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20*%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%3D%20taxon_data_to_select_from%5Bselected_row_int%2C%20%3A%5D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_col1%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20match%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20_col1%20in%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22class%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22order%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22family%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20*%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%3D%20taxon_data_to_select_from%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20int(not%20bool(selected_row_int))%2C%20%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%20%20%23%20searching%20in%20the%20three%20columns%20of%20interests%20for%20matches%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20assert%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20%20%20match%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20)%20%20%23%20Double%20check%20that%20there%20is%20no%20unmatch.%20%20%23%20noqa%3A%20E712%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20match%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20temp%20%3D%20chosen_taxonId%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chosen_taxonId%20%3D%20other_taxonId%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20other_taxonId%20%3D%20temp%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20turning%20these%20rows%20to%20matching%20by%20filling%20parentNameUsageID%0A%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20_no_match_subset_to_update.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22genus%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(other_taxonId))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.lit(chosen_taxonId))%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20updated_to_matching.append(_no_match_subset_to_update)%0A%0A%20%20%20%20%23%20turn%20them%20into%20dataframes%20and%20writing%20to%20csv%20files%0A%20%20%20%20updated_to_matching%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20updated_to_matching%2C%20rechunk%3DTrue%2C%20parallel%3DTrue%0A%20%20%20%20)%0A%20%20%20%20updated_to_matching.write_csv(%22first_matches_set_from_wrangling.csv%22)%0A%0A%20%20%20%20still_no_match%20%3D%20no_match.join(%0A%20%20%20%20%20%20%20%20updated_to_matching.select(%22speciesId%22)%2C%20on%3D%22speciesId%22%2C%20how%3D%22anti%22%0A%20%20%20%20)%0A%20%20%20%20return%20still_no_match%2C%20updated_to_matching%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20priority_columns%2C%20updated_to_matching)%3A%0A%20%20%20%20updated_to_matching.select(%5B%22speciesId%22%5D%20%2B%20priority_columns).filter(%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22Aonides%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(updated_to_matching)%3A%0A%20%20%20%20updated_to_matching.shape%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(still_no_match)%3A%0A%20%20%20%20still_no_match%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%20Second%20Matching%20Wrangle%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20priority_columns)%3A%0A%20%20%20%20taxons%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%22gbif%2FTaxon.tsv%22%2C%20separator%3D%22%5Ct%22%2C%20quote_char%3DNone%2C%20cache%3DTrue)%0A%20%20%20%20%20%20%20%20.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22taxonomicStatus%22)%20%3D%3D%20pl.lit(%22accepted%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22taxonRank%22)%20!%3D%20%22unranked%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22kingdom%22).is_in(%5B%22Animalia%22%2C%20%22Plantae%22%5D))%0A%20%20%20%20%20%20%20%20.select(%5B%22taxonID%22%5D%20%2B%20priority_columns)%0A%20%20%20%20)%0A%0A%0A%20%20%20%20def%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on%3A%20pl.DataFrame%2C%20_taxons_subset%3A%20pl.DataFrame%2C%20on%3A%20list%0A%20%20%20%20)%20-%3E%20pl.DataFrame%3A%0A%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on.join(_taxons_subset%2C%20on%3Don)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(pl.col(%22taxonID%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(%22taxonID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22parentNameUsageID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.drop(%22taxonID%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20join_and_parentId_insertion%2C%20taxons%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23%20%20matching%20for%20datapoints%20where%20phylumn%20to%20class%20ranks%20features%20are%20not%20empty%20strings%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_class%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_class%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter_class).then(%22class%22).otherwise(None)%0A%20%20%20%20).filter(_filter_class)%0A%0A%20%20%20%20_x_class%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_class)%0A%20%20%20%20%20%20%20%20.select(%22class%22)%0A%20%20%20%20%20%20%20%20.group_by(%22class%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_class%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22class%22).is_in(_x_class%5B%22class%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22class%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_class%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on_class%2C%20_taxons_subset_class%2C%20%5B%22class%22%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_class%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_class)%3A%0A%20%20%20%20match_on_class.select(%5B%22parentNameUsageID%22%2C%20%22class%22%5D).sort(%22parentNameUsageID%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_class%2C%20pl%2C%20priority_columns)%3A%0A%20%20%20%20match_on_class.select(%0A%20%20%20%20%20%20%20%20%5B%22speciesId%22%2C%20%22taxonName%22%2C%20%22parentNameUsageID%22%5D%20%2B%20priority_columns%0A%20%20%20%20).sort(%22parentNameUsageID%22).filter(pl.col(%22parentNameUsageID%22)%20%3D%3D%20136)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23%20matching%20for%20datapoints%20where%20phylum%20to%20order%20ranks%20features%20are%20not%20empty%20strings%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_order%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_order%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter_order).then(%22order%22).otherwise(None)%0A%20%20%20%20).filter(_filter_order)%0A%20%20%20%20_x_order%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_order)%0A%20%20%20%20%20%20%20%20.select(%22order%22)%0A%20%20%20%20%20%20%20%20.group_by(%22order%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_order%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_in(_x_order%5B%22order%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_order%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on_order%2C%20_taxons_subset_order%2C%20%5B%22order%22%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_order%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_order)%3A%0A%20%20%20%20match_on_order.select(%5B%22parentNameUsageID%22%2C%20%22order%22%5D).sort(%22parentNameUsageID%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_order%2C%20pl%2C%20priority_columns)%3A%0A%20%20%20%20match_on_order.select(%0A%20%20%20%20%20%20%20%20%5B%22speciesId%22%2C%20%22taxonName%22%2C%20%22parentNameUsageID%22%5D%20%2B%20priority_columns%0A%20%20%20%20).sort(%22parentNameUsageID%22).filter(pl.col(%22parentNameUsageID%22)%20%3D%3D%20459)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23%20matching%20for%20datapoints%20where%20phylum%20to%20family%20ranks%20features%20are%20not%20empty%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_family%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_family%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter_family).then(%22family%22).otherwise(None)%0A%20%20%20%20).filter(_filter_family)%0A%20%20%20%20_x_family%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_family)%0A%20%20%20%20%20%20%20%20.select(%22family%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.group_by(%22family%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_family%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_in(_x_family%5B%22order%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_in(_x_family%5B%22family%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22family%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_family%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on_family%2C%20_taxons_subset_family%2C%20%5B%22family%22%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_family%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_family%2C%20priority_columns)%3A%0A%20%20%20%20match_on_family.select(%0A%20%20%20%20%20%20%20%20%5B%22speciesId%22%2C%20%22taxonName%22%2C%20%22parentNameUsageID%22%5D%20%2B%20priority_columns%0A%20%20%20%20).sort(%22parentNameUsageID%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_family%2C%20pl%2C%20priority_columns)%3A%0A%20%20%20%20match_on_family.select(%0A%20%20%20%20%20%20%20%20%5B%22speciesId%22%2C%20%22taxonName%22%2C%20%22parentNameUsageID%22%5D%20%2B%20priority_columns%0A%20%20%20%20).sort(%22parentNameUsageID%22).filter(pl.col(%22parentNameUsageID%22)%20%3D%3D%202045)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%20matching%20for%20datapoints%20where%20phylum%20to%20genus%20ranks%20features%20are%20not%20empty%20strings%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_genus%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20to_be_match_on_genus%20%3D%20still_no_match.filter(_filter_genus)%0A%0A%20%20%20%20_x_genus%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_genus)%0A%20%20%20%20%20%20%20%20.select(%22genus%22)%0A%20%20%20%20%20%20%20%20.group_by(%22genus%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_genus%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_in(_x_genus%5B%22genus%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_genus%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20to_be_match_on_genus%2C%0A%20%20%20%20%20%20%20%20_taxons_subset_genus%2C%0A%20%20%20%20%20%20%20%20%5B%22genus%22%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_genus%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_genus%2C%20priority_columns)%3A%0A%20%20%20%20match_on_genus.select(%0A%20%20%20%20%20%20%20%20%5B%22speciesId%22%2C%20%22taxonName%22%2C%20%22parentNameUsageID%22%5D%20%2B%20priority_columns%0A%20%20%20%20).sort(%22parentNameUsageID%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_genus%2C%20pl%2C%20priority_columns)%3A%0A%20%20%20%20match_on_genus.select(%0A%20%20%20%20%20%20%20%20%5B%22speciesId%22%2C%20%22taxonName%22%2C%20%22parentNameUsageID%22%5D%20%2B%20priority_columns%0A%20%20%20%20).sort(%22parentNameUsageID%22).filter(pl.col(%22parentNameUsageID%22)%20%3D%3D%201004617)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_genus%2C%20pl%2C%20priority_columns)%3A%0A%20%20%20%20match_on_genus.select(%0A%20%20%20%20%20%20%20%20%5B%22speciesId%22%2C%20%22taxonName%22%2C%20%22parentNameUsageID%22%5D%20%2B%20priority_columns%0A%20%20%20%20).filter(pl.col(%22taxonName%22)%20%3D%3D%20%22Paguristes%20sp.%201%22).sort(%22parentNameUsageID%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_genus)%3A%0A%20%20%20%20match_on_genus.shape%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23%20matching%20for%20datapoints%20where%20phylum%20to%20specificEpithet%20ranks%20features%20are%20not%20empty%20strings%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_specificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20to_be_match_on_specificEpithet%20%3D%20still_no_match.filter(_filter_specificEpithet)%0A%0A%20%20%20%20_x_specificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_specificEpithet)%0A%20%20%20%20%20%20%20%20.select(%22specificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.group_by(%22specificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_specificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x_specificEpithet%5B%22specificEpithet%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_in(_x_specificEpithet%5B%22genus%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_not_null()%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22specificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_specificEpithet%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20to_be_match_on_specificEpithet%2C%0A%20%20%20%20%20%20%20%20_taxons_subset_specificEpithet%2C%0A%20%20%20%20%20%20%20%20%5B%22specificEpithet%22%2C%20%22genus%22%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_specificEpithet%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_specificEpithet)%3A%0A%20%20%20%20match_on_specificEpithet.select(%0A%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%20%22genus%22%2C%20%22parentNameUsageID%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23matching%20for%20datapoints%20where%20phylum%20to%20infraspecificEpithet%20(Except%20for%20specificEpithet%2C%20no%20filters%20involved)%20ranks%20features%20are%20not%20empty%20strings.%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_infraspecificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20!%3D%20%22%22%2C%0A%20%20%20%20)%20%20%23%20different%20filter%20because%20some%20don't%20have%20specificEpithet%20either%2C%20if%20I%20am%20not%20wrong%0A%20%20%20%20to_be_match_on_infraspecificEpithet%20%3D%20still_no_match.filter(%0A%20%20%20%20%20%20%20%20_filter_infraspecificEpithet%0A%20%20%20%20)%0A%0A%20%20%20%20_x_infraspecificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_infraspecificEpithet)%0A%20%20%20%20%20%20%20%20.select(%22infraspecificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.group_by(%22infraspecificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_infraspecificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x_infraspecificEpithet%5B%22infraspecificEpithet%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x_infraspecificEpithet%5B%22genus%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22infraspecificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%0A%20%20%20%20match_on_infraspecificEpithet%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20to_be_match_on_infraspecificEpithet%2C%0A%20%20%20%20%20%20%20%20_taxons_subset_infraspecificEpithet%2C%0A%20%20%20%20%20%20%20%20%5B%22infraspecificEpithet%22%2C%20%22genus%22%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_infraspecificEpithet%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_infraspecificEpithet)%3A%0A%20%20%20%20match_on_infraspecificEpithet.select(%0A%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%20%22specificEpithet%22%2C%20%22genus%22%2C%20%22parentNameUsageID%22%0A%20%20%20%20).sort(%22parentNameUsageID%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23%20Combining%20all%20these%20second%20matching%20wrangling%20stage%20dataframes%20of%20the%20ranks%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20match_on_class%2C%0A%20%20%20%20match_on_family%2C%0A%20%20%20%20match_on_genus%2C%0A%20%20%20%20match_on_infraspecificEpithet%2C%0A%20%20%20%20match_on_order%2C%0A%20%20%20%20match_on_specificEpithet%2C%0A%20%20%20%20no_match%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20updated_to_matching%2C%0A)%3A%0A%20%20%20%20_to_drop%20%3D%20%5B%22name_to_match%22%5D%0A%20%20%20%20match_on_genus.write_csv(%22second_matches_set_for_genus_only.csv%22)%0A%20%20%20%20_new_match%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_class.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_order.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_family.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_genus%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_specificEpithet%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_infraspecificEpithet%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20print(%22second%20wrangle%20new%20matches%22%2C%20_new_match.shape)%0A%20%20%20%20_new_match.write_csv(%22second_matches_set_from_wrangling.csv%22)%0A%20%20%20%20_new_match%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20_new_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20updated_to_matching.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22parentNameUsageID%22).cast(pl.Int64)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20_new_match.write_csv(%22updated_to_matching.csv%22)%0A%20%20%20%20_no_match%20%3D%20no_match.join(%0A%20%20%20%20%20%20%20%20_new_match.select(%22speciesId%22)%2C%20on%3D%22speciesId%22%2C%20how%3D%22anti%22%0A%20%20%20%20)%0A%20%20%20%20print(%22all%20matches%22%2C%20_new_match.shape)%0A%20%20%20%20print(%22no%20match%22%2C%20_no_match.shape)%0A%20%20%20%20_no_match.write_csv(%22no_match.csv%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(bos)%3A%0A%20%20%20%20bos.shape%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">7d4111916bbd7369212b3ec9eb10e47e8eaa29838a290e2ef57c4ce51bc2de33</marimo-code-hash>
</body>
</html>
