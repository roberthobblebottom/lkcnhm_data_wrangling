<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>bos_gbif_matching_marimo_notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>bos gbif matching marimo notebook</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/index-BB71mG_d.js"></script>
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/index-DryPQDfA.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "bos_gbif_matching_marimo_notebook.py",
            "mode": "read",
            "version": "0.15.2",
            "serverToken": "static",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "plain", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "full", "reference_highlighting": true, "theme": "dark"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "package_management": {"manager": "pip"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "full"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "mo.md(\n    r\"\"\"\n# Introduction  \n\nThe documentation of this notebook is for those who are new to `python` and `polars`\n\ncombination of r_transaltion.py script and more_r_translation.py marimo notebook\n\nfor the second matching wrangle, the parts for specificEpithet and infraSpecificEpithet doesn't match with many results.\n\n[Read the powers getting started guide](https://docs.pola.rs/user-guide/getting-started/)\nYou may check out the `Polars` API References and tutorials for more information.\n\nString values are denoted with double quotations and contains unicode characters like alphabets, number and etc. eg: \"test\"\n\nBooleans are binary values that are either 'True' or 'False'.  \n\n# Imports\n\"\"\"\n)", "code_hash": "1c4af65e61673fa156224d1a44a913dd", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "import marimo as mo\nimport polars as pl", "code_hash": "ce4194fff5fe8b0eebb7a09769bc0473", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n`with_columns()`:[ Adds columns to this DataFrame. Added columns will replace existing columns with the same name.](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.with_columns.html)\n\n`pl.col()`: [Create an expression representing column(s) in a DataFrame.](https://docs.pola.rs/api/python/stable/reference/expressions/col.html)  \n\n `.str`: to get the string functions so that you could chain it with other funcitons such as `strip_chars()`   \n\n`strip_char()`: strip a certain characters that is present in the start or end of the string\n\"\"\"\n)", "code_hash": "e025bc903828106069c84aabb5a0c4ec", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "bos = (\n    pl.read_csv(\"bos.csv\")\n    .rename(\n        {\n            \"data cleanup changes\": \"data cleanup changes 1\",\n            \"species\": \"specificEpithet\",\n            \"subspecies\": \"infraspecificEpithet\",\n            \"domain \": \"domain\",\n        }\n    )\n    .with_columns(pl.col(pl.String).str.strip_chars(\" \"))\n    .with_columns(genericName=pl.col(\"genus\"))\n)", "code_hash": "aec531ea99fb89c31feec8ef0103e84a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "mo.md(r\"\"\"`transpose()`: matrix transpose the tabular data.\"\"\")", "code_hash": "f960dad7d6e4ccbb564813492b17c3fc", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "null_counts = (\n    bos.null_count()\n    .transpose(include_header=True)\n    .rename({\"column\": \"feature\", \"column_0\": \"len\"})\n)\ncolumns_to_drop_as_all_nulls = (\n    null_counts.filter(null_counts[\"len\"] == bos.shape[0])\n    .transpose()[0, :]\n    .transpose()\n    .to_series()\n    .to_list()\n)", "code_hash": "326926b50dfc5120bb2413c46973fe5f", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "columns_to_drop_as_they_are_just_changes_logs = [\n    \"cleanup changes \",\n    \"Data cleanup changes\",\n    \"data cleanup changes 1\",\n    \"changes\",\n    \"cleanup changes\",\n    \"Unnamed: 18\",\n    \"Unnamed: 17\",\n    \"Unnamed: 19\",\n    \"query\",\n    \"query \",\n    \"issue\",\n    \"cleanup changes/comments\",\n    \"subphylum\",\n]", "code_hash": "740c615dabbd943e156e6d426dabb055", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n`~`: negation of the predicate expressions.  \n`fitler()` : [Filter rows, retaining those that match the given predicate expression(s). Only rows where the predicate resolves as True are retained; when the predicate result is False (or null), the row is discarded.](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.filter.html)  \n\n`select()`: select specific columns \n\n`when().then().otherwise()`: Like if else statement. \n```\ne.g. infraspecificEpithet=pl.when(pl.col(\"infraspecificEpithet\").is_null())\n        .then(pl.lit(\"\"))\n        .otherwise(pl.col(\"infraspecificEpithet\"))\n```\nexplaination: when values in infraspecificEpithet column is null then populate it with the literal empty string (as denoted as \"\") otherise populate it with infraspecificEpithet.  \n\n\n`lit()`: Tells the intepretator that you are refering to a literal string not any columns.  \n\n`pl.col(\"col1\").is_in([\"a\",\"b\"])`: is_in is used to check and filter in values that are the list of strings, these strings do not refer to any columns.\n\"\"\"\n)", "code_hash": "1e0cab6e3e929b42d3d03e1e45ea6e18", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "bos_cleaned = (\n    (\n        bos.drop(columns_to_drop_as_all_nulls)\n        .drop(columns_to_drop_as_they_are_just_changes_logs)\n        .select(~pl.selectors.starts_with(\"Unnamed\"))\n    )\n    .with_columns(\n        infraspecificEpithet=pl.when(pl.col(\"infraspecificEpithet\").is_null())\n        .then(pl.lit(\"\"))\n        .otherwise(pl.col(\"infraspecificEpithet\"))\n    )\n    .with_columns(\n        infraspecificEpithet=pl.when(\n            (pl.col(\"genericName\") == \"Glenea\")\n            & (pl.col(\"specificEpithet\") == \"mathemathica\")\n        )\n        .then(pl.lit(\"mathematica\"))\n        .otherwise(pl.col(\"infraspecificEpithet\"))\n    )\n    .with_columns(\n        specificEpithet=pl.when(\n            (pl.col(\"genericName\") == \"Glenea\")\n            & (pl.col(\"specificEpithet\") == \"mathemathica\")\n        )\n        .then(pl.lit(\"mathematica\"))\n        .when(\n            (pl.col(\"genericName\") == \"Bavia\")\n            & (pl.col(\"specificEpithet\") == \"sexupunctata\")\n        )\n        .then(pl.lit(\"sexpunctata\"))\n        .when(\n            (pl.col(\"genericName\") == \"Omoedus\")\n            & (pl.col(\"specificEpithet\") == \"ephippigera\")\n        )\n        .then(pl.lit(\"ephippiger\"))\n        .when(\n            (pl.col(\"genericName\") == \"Byblis\")\n            & (pl.col(\"specificEpithet\") == \"kallartha\")\n        )\n        .then(pl.lit(\"kallarthra\"))\n        .when(\n            (pl.col(\"genericName\") == \"Alcockpenaeopsis\")\n            & (pl.col(\"specificEpithet\") == \"hungerfordi\")\n        )\n        .then(pl.lit(\"hungerfordii\"))\n        .when(\n            (pl.col(\"genericName\") == \"Pseudosesarma\")\n            & (pl.col(\"specificEpithet\") == \"edwardsi\")\n        )\n        .then(pl.lit(\"edwardsii\"))\n        .when(\n            (pl.col(\"genericName\") == \"Urocaridella\")\n            & (pl.col(\"specificEpithet\") == \"antonbruuni\")\n        )\n        .then(pl.lit(\"antonbruunii\"))\n        .when(\n            (pl.col(\"genericName\") == \"Ocypode\")\n            & (pl.col(\"specificEpithet\") == \"cordimanus\")\n        )\n        .then(pl.lit(\"cordimana\"))\n        .otherwise(pl.col(\"specificEpithet\"))\n    )\n    .with_columns(\n        domain=pl.lit(\"Eukarya\"),\n        kingdom=pl.when(\n            (pl.col(\"phylum\").is_in([\"Ascomycota\", \"Basidiomycota\"]))\n        )\n        .then(pl.lit(\"fungi\"))\n        .when(pl.col(\"phylum\") == \"Cyanobacteria\")\n        .then(pl.lit(\"Bacteria\"))\n        .when(pl.col(\"phylum\") == \"Ciliophora\")\n        .then(pl.lit(\"Protista\"))\n        .otherwise(pl.lit(\"Animalia\")),\n    )\n    .with_columns(\n        taxonName=pl.col(\"taxonName\")\n        .str.replace_all(\"<i>\", \"\")\n        .str.replace_all(\"</i>\", \"\"),\n    )\n)", "code_hash": "651051385bc53c333d98c016c1598f50", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "mo.md(r\"\"\"Lazyframes from `pl.scan_csv()` is use to efficiently process big csv files.\"\"\")", "code_hash": "0a986c10a39f3669873e3545881fc184", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "_filter = pl.col(\"taxonomicStatus\").is_in(\n    [\n        \"accepted\",\n        \"synonym\",\n        \"homotypic synonym\",\n        \"proparte synonym\",\n        \"heterotypic synonym\",\n    ]\n)\ntaxon_ranked_only = (\n    pl.scan_csv(\n        \"gbif/Taxon.tsv\",\n        separator=\"\\t\",\n        quote_char=None,\n        cache=True,\n    )\n    .filter((pl.col(\"taxonRank\") != \"unranked\") & _filter)\n    .select(\n        \"taxonID\",\n        \"genericName\",\n        \"genus\",\n        \"specificEpithet\",\n        \"infraspecificEpithet\",\n        \"taxonomicStatus\",\n        \"acceptedNameUsageID\",\n        # \"domain\",\n    )\n    .filter((pl.col(\"genus\") != \"\") & (pl.col(\"specificEpithet\") != \"\"))\n    .with_columns(\n        infraspecificEpithet=pl.when(\n            (pl.col(\"infraspecificEpithet\").is_null())\n        )\n        .then(pl.lit(\"\"))\n        .otherwise(pl.col(\"infraspecificEpithet\"))\n    )\n)", "code_hash": "41d3b7e805122f937ac25fb515025ff1", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n`cast()`: Cast column(s) in to a specific polars datatype.  \n\n`collect()`: Materialize this LazyFrame into a DataFrame. It is a slow function so use it sparingly and appropriately.\n\n`is_duplicated()`: a expression function for checking if a row's set of values is duplicated from one of the previous row's set of values.  \n\n`fill_null()`: fills null values in a column with a particular string.\n\n`list[0]`: gets the first element of the list. the numbering starts from 0 because of computer's base 2 counting standards.\n\"\"\"\n)", "code_hash": "20e967ca7c38e7ddab3a577e282b91c3", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "matching = (\n    taxon_ranked_only.join(\n        other=pl.LazyFrame(bos_cleaned),\n        on=[\"genericName\", \"specificEpithet\", \"infraspecificEpithet\"],\n        how=\"right\",\n    )\n    .rename({\"taxonID\": \"matched_taxonID\"})\n    .select(\n        \"speciesId\",\n        \"matched_taxonID\",\n        \"acceptedNameUsageID\",\n        \"taxonName\",\n        \"domain\",\n        \"kingdom\",\n        \"phylum\",\n        \"class\",\n        \"subclass\",\n        \"superorder\",\n        \"order\",\n        \"sub-order\",\n        \"infraorder\",\n        \"section\",\n        \"subsection\",\n        \"superfamily\",\n        \"family\",\n        \"subfamily\",\n        \"tribe\",\n        \"genus\",\n        \"subgenus\",\n        \"genericName\",\n        \"specificEpithet\",\n        \"infraspecificEpithet\",\n    )\n    .with_columns(\n        pl.when(pl.col(\"infraspecificEpithet\") == \"\")\n        .then(pl.lit(None))\n        .otherwise(\"infraspecificEpithet\")\n        .alias(\"infraspecificEpithet\")\n    )\n)\n# matching and contetnious split\n# What makes a data point contentious is where it has duplicate speciesId.\nmatching = matching.filter(~pl.col(\"speciesId\").is_duplicated()).with_columns(\n    acceptedNameUsageID=pl.col(\"acceptedNameUsageID\")\n    .fill_null(pl.lit(None))\n    .cast(pl.Int64)\n)\ncontentious = matching.filter(\n    (pl.col(\"speciesId\").is_duplicated())\n).with_columns(\n    acceptedNameUsageID=pl.col(\"acceptedNameUsageID\")\n    .fill_null(pl.lit(None))\n    .cast(pl.Int64)\n)\n\nunique_contentious = contentious.filter(\n    (pl.col(\"acceptedNameUsageID\").is_null())\n    & (\n        pl.col(\"matched_taxonID\").is_in(\n            pl.col(\"acceptedNameUsageID\").implode()\n        )\n    )\n)\n\nunique_contentious_speciesId = (\n    unique_contentious.select(\"speciesId\").collect().to_series().implode()\n)  # Just the speciesIds\ncontentious = contentious.filter(\n    ~pl.col(\"speciesId\").is_in(unique_contentious_speciesId)\n)  # Removing unique conentious\n\nmatching = pl.concat(\n    [matching, unique_contentious],\n)\n\nmatching = matching.with_columns(\n    genus=pl.when(\n        (pl.col(\"genus\").is_null()) & (pl.col(\"specificEpithet\").is_not_null())\n    )\n    .then(pl.col(\"taxonName\").str.split(\" \").list[0])\n    .otherwise(\"genus\")\n)\n\nno_match = (\n    matching.filter(pl.col(\"matched_taxonID\").is_null())\n    .with_columns(\n        taxonRank=pl.lit(\"BOSuncornirmedSpecies\"),\n        taxonomicStatus=pl.lit(\"BOSunformired\"),\n        parentNameUsageID=pl.lit(None),\n    )\n    .fill_null(\"\")\n    .collect()\n)", "code_hash": "d0bee1459bc800580e39aa090f0d97ff", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n# First Matching\n\n`sort()`: sort by a specific column(s) in ascending order\n\"\"\"\n)", "code_hash": "2af03c47f68e34e926a5f5d66c460c3b", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "nWHF", "name": "_"}, {"code": "repeated_accepted_taxons = (\n    pl.scan_csv(\"gbif/Taxon.tsv\", separator=\"\\t\", quote_char=None, cache=True)\n    .filter(pl.col(\"taxonomicStatus\") == pl.lit(\"accepted\"))\n    .filter(pl.col(\"kingdom\").is_in([\"Animalia\", \"Plantae\"]))\n    .filter(~pl.col(\"canonicalName\").is_null())\n    .filter(pl.col(\"canonicalName\") != \"\")\n    .sort(\"canonicalName\")\n    .filter(pl.col(\"canonicalName\").is_duplicated())\n)", "code_hash": "c7f3a3438d801f195ee5a1cc82d021b0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "priority_columns = [\n    \"infraspecificEpithet\",\n    \"specificEpithet\",\n    \"genus\",\n    \"family\",\n    \"order\",\n    \"class\",\n    \"phylum\",\n    \"kingdom\",\n]", "code_hash": "d63a3ea8b7e381b43a40de6296620085", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZHCJ", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n`vstack()`: Stack the new dataframe vertically.  \n`group_by()`: group the data by some column(s) and then do an operation such as `mean()`, `len()`, `agg()` and etc.  \n`agg()`: a function to work on the groups.   \n\nThis line below is used to join the strings in the group using the delimiter \", \"\n`.agg(pl.col(\"feature_that_is_equal_to_canonicalName\").str.join(\", \"))`  \n\n`split()`: used to split a string type column into a list of strings.\n\"\"\"\n)", "code_hash": "dd86a499496aff2645f80235dad40105", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RQiy", "name": "_"}, {"code": "_schema = {\n    \"feature_that_is_equal_to_canonicalName\": pl.String,\n    \"matches\": pl.String,\n}\n_r = (repeated_accepted_taxons).collect()\nRAT_interim = pl.DataFrame(schema=_schema)\nfor _col in priority_columns:\n    _canonical_names = (\n        _r.filter(pl.col(\"canonicalName\") == pl.col(_col))\n        .select(\"canonicalName\")\n        .unique()\n        .to_series()\n        .to_list()\n    )\n    if len(_canonical_names) != 0:\n        _row = pl.DataFrame(\n            data={\n                \"feature_that_is_equal_to_canonicalName\": _col,\n                \"matches\": _canonical_names,\n            },\n            schema=_schema,\n        )\n        RAT_interim = RAT_interim.vstack(_row)\nRAT_feats = (\n    RAT_interim.group_by(\"matches\")\n    .agg(pl.col(\"feature_that_is_equal_to_canonicalName\").str.join(\", \"))\n    .with_columns(\n        pl.col(\"feature_that_is_equal_to_canonicalName\").str.split(\", \")\n    )\n    .sort(\"feature_that_is_equal_to_canonicalName\")\n)", "code_hash": "be2f4ab2a04402de6adf9cc1b5fe6ace", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ROlb", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n`copy()`: deep copy, you may search it up to read more about it.  \n`reverse()`: reverse a list in place  \n`index()`: The index() method in Python is used to find the position of the first occurrence of a specified value in a list or string.  \n\n`bool()`: cast a value into boolean  \n`None`: Null value in python\n`append()`: add new element to the back of a list\n`len()`: get length of string,list,etc  \n`item()`: only in polars Series where there is one value, this will get that value out.  \n\nThis code returns a boolean `pl.Series`:\n```\n  (\n                        _no_match_subset_to_update[_col1].item()\n                        == taxon_data_to_select_from[\n                            int(not bool(selected_row_int)), :\n                        ]\n                    ) \n                    ```  \n                      \n# I stopped the documentation here as I was given the instruction that these instrucitons are no longer needed.\n\"\"\"\n)", "code_hash": "c943d6ec2349a5b647aadff8f2165077", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "zsSM", "name": "_"}, {"code": "updated_to_matching = []\nstill_no_match = []\n_collected_repeated_taxons = repeated_accepted_taxons.collect().fill_null(\"\")\n_reversed_priority_columns = priority_columns.copy()\n_reversed_priority_columns.reverse()\nfor _col in _reversed_priority_columns:\n    for _match in RAT_feats[\"matches\"]:\n        # skipping those that are not in RAT_feats\n        if _match not in no_match[_col].to_list():\n            continue\n\n        taxon_data_to_select_from = _collected_repeated_taxons.filter(\n            pl.col(\"canonicalName\") == _match\n        ).select([\"taxonID\"] + _reversed_priority_columns)\n\n        # Select from the two rows what taxon data to select.\n        selected_row_int = -1\n        for i, _tuple in enumerate(\n            taxon_data_to_select_from.select(\n                [\"taxonID\"] + priority_columns\n            ).iter_rows()\n        ):\n            col_index = priority_columns.index(_col)\n            _x = _tuple[col_index]\n            if not bool(_x):\n                selected_row_int = i  # Since there are usually only two rows from taxon_data_to_select_from, the results is either 0 or 1\n                break\n        assert selected_row_int != -1\n\n        # has_predicament1 is when kingdom to genus all has values and it is kind of leveled between the two rows of the taxon data.\n        has_predicament1 = False\n        _l = taxon_data_to_select_from[\"family\"].to_list()\n        if _col == \"genus\" and _l[0] is not None and _l[1] is not None:\n            has_predicament1 = True\n\n        chosen_taxonId = taxon_data_to_select_from[selected_row_int, 0]\n        other_taxonId = taxon_data_to_select_from[\n            int(\n                not bool(selected_row_int)\n            ),  # converts the int value into boolean than reverse the boolean before converting back to int.\n            0,\n        ]\n\n        # Getting the _no_match_subset_to_update section\n        _no_match_subset_to_update = no_match.filter(\n            pl.col(_col) == _match,\n        )\n        _x = _reversed_priority_columns[:-3]\n        feature_to_find_nulls = (\n            _x[_reversed_priority_columns.index(_col) + 1]\n            if len(_x) > _reversed_priority_columns.index(_col) + 1\n            else None\n        )  # just the next feature to find null\n        if feature_to_find_nulls is not None:\n            _no_match_subset_to_update = _no_match_subset_to_update.filter(\n                pl.col(feature_to_find_nulls) == \"\"\n            )\n            if _no_match_subset_to_update.is_empty():\n                still_no_match_subset = no_match.filter(\n                    pl.col(_col) == _match,\n                ).with_columns(\n                    current_feature=pl.lit(_col), current_name=pl.lit(_match)\n                )\n                still_no_match.append(still_no_match_subset)\n\n                continue\n\n        # Settling predicament one\n        # this predicament thing should only happen when the subset is of only 1 row.\n        if has_predicament1 and _no_match_subset_to_update.shape[0] == 1:\n            match = True\n            for _col1 in [\"class\", \"order\", \"family\"]:\n                match *= (\n                    _no_match_subset_to_update[_col1].item()\n                    == taxon_data_to_select_from[selected_row_int, :][\n                        _col1\n                    ].item()\n                )\n            if not match:\n                match = True\n                for _col1 in [\"class\", \"order\", \"family\"]:\n                    match *= (\n                        _no_match_subset_to_update[_col1].item()\n                        == taxon_data_to_select_from[\n                            int(not bool(selected_row_int)), :\n                        ][_col1].item() \n                    )  # searching in the three columns of interests for matches\n                assert (\n                    match\n                )  # Double check that there is no unmatch.  # noqa: E712\n                temp = chosen_taxonId\n                chosen_taxonId = other_taxonId\n                other_taxonId = temp\n\n        # turning these rows to matching by filling parentNameUsageID\n        _no_match_subset_to_update = _no_match_subset_to_update.with_columns(\n            parentNameUsageID=pl.when(\n                (pl.col(\"infraspecificEpithet\").is_null())\n                & (pl.col(\"specificEpithet\").is_not_null())\n                & (pl.col(\"genus\").is_not_null())\n            )\n            .then(pl.lit(other_taxonId))\n            .otherwise(pl.lit(chosen_taxonId))\n        )\n\n        updated_to_matching.append(_no_match_subset_to_update)\n\n# turn them into dataframes and writing to csv files\nupdated_to_matching = pl.concat(\n    updated_to_matching, rechunk=True, parallel=True\n)\nupdated_to_matching.write_csv(\"first_matches_set_from_wrangling.csv\")\n\nstill_no_match = pl.concat(still_no_match, rechunk=True, parallel=True)\nstill_no_match = still_no_match.join(\n    updated_to_matching.select(\"speciesId\"), on=\"speciesId\", how=\"anti\"\n)", "code_hash": "509ba5b325c022b6d94f8925bb09fb1a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "qnkX", "name": "_"}, {"code": "mo.md(r\"\"\"# Second Matching Wrangle\"\"\")", "code_hash": "ddb5f316ef72826d4b72561b97d0219e", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "TqIu", "name": "_"}, {"code": "taxons = (\n    pl.scan_csv(\"gbif/Taxon.tsv\", separator=\"\\t\", quote_char=None, cache=True)\n    .filter(\n        pl.col(\"taxonomicStatus\") == pl.lit(\"accepted\"),\n        pl.col(\"taxonRank\") != \"unranked\",\n    )\n    .filter(pl.col(\"kingdom\").is_in([\"Animalia\", \"Plantae\"]))\n    .select([\"taxonID\"] + priority_columns)\n)\n\n\ndef join_and_parentId_insertion(\n    match_on: pl.DataFrame, _taxons_subset: pl.DataFrame, on: list\n) -> pl.DataFrame:\n    return (\n        match_on.join(_taxons_subset, on=on)\n        .with_columns(\n            parentNameUsageID=pl.when(pl.col(\"taxonID\").is_not_null())\n            .then(\"taxonID\")\n            .otherwise(\"parentNameUsageID\")\n        )\n        .drop(\"taxonID\")\n    )", "code_hash": "a6d478b4bb7451122894fc9097b30c0d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Vxnm", "name": "_"}, {"code": "mo.md(r\"\"\"## Non nulls stopped at class\"\"\")", "code_hash": "bf9782427d8438f1eeb86436453bd990", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "DnEU", "name": "_"}, {"code": "_filter_class = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") == \"\",\n    pl.col(\"family\") == \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n    pl.col(\"current_feature\") == \"phylum\",\n)\nmatch_on_class = still_no_match.with_columns(\n    name_to_match=pl.when(_filter_class).then(\"class\").otherwise(None)\n).filter(_filter_class)\n\n_x_class = (\n    still_no_match.filter(_filter_class)\n    .select(\"class\")\n    .group_by(\"class\")\n    .len()\n)\n\n_taxons_subset_class = (\n    taxons.filter(\n        pl.col(\"family\").is_null(),\n        pl.col(\"order\").is_null(),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"class\").is_in(_x_class[\"class\"].unique().to_list()),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n        # pl.col(\"phylum\").is_in(_x_class[\"phylum\"].unique().to_list()),\n    )\n    .select(\"taxonID\", \"class\")\n    .collect()\n)\nmatch_on_class = join_and_parentId_insertion(\n    match_on_class, _taxons_subset_class, [\"class\"]\n)", "code_hash": "ee5dcd9f9a176667af8e2663a7ff6006", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ulZA", "name": "_"}, {"code": "mo.md(r\"\"\"## non nulls stopping at order\"\"\")", "code_hash": "9346a2343e9ce579655ef335c26c50f2", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "ecfG", "name": "_"}, {"code": "_filter_order = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") == \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n    pl.col(\"current_feature\") == \"phylum\",\n)\nmatch_on_order = still_no_match.with_columns(\n    name_to_match=pl.when(_filter_order).then(\"order\").otherwise(None)\n).filter(_filter_order)\n_x_order = (\n    still_no_match.filter(_filter_order)\n    .select(\"order\")\n    .group_by(\"order\")\n    .len()\n)\n\n_taxons_subset_order = (\n    taxons.filter(\n        pl.col(\"family\").is_null(),\n        pl.col(\"order\").is_in(_x_order[\"order\"].unique().to_list()),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n    )\n    .select(\"taxonID\", \"order\")\n    .collect()\n)\nmatch_on_order = join_and_parentId_insertion(\n    match_on_order, _taxons_subset_order, [\"order\"]\n)", "code_hash": "47b4fc24c54bb76c6e3d34f171e5f31b", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Pvdt", "name": "_"}, {"code": "mo.md(r\"\"\"## non nulls stopping at family\"\"\")", "code_hash": "bd4f09eb18125680fab3775e7e111b20", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "ZBYS", "name": "_"}, {"code": "_filter_family = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\nmatch_on_family = still_no_match.with_columns(\n    name_to_match=pl.when(_filter_family).then(\"family\").otherwise(None)\n).filter(_filter_family)\n_x_family = (\n    still_no_match.filter(_filter_family)\n    .select(\"family\", \"order\")\n    .group_by(\"family\", \"order\")\n    .len()\n)\n\n_taxons_subset_family = (\n    taxons.filter(\n        pl.col(\"family\").is_in(_x_family[\"family\"].unique().to_list()),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n        pl.col(\"order\").is_in(_x_family[\"order\"].unique().to_list()),\n    )\n    .select(\"taxonID\", \"family\")\n    .collect()\n)\nmatch_on_family = join_and_parentId_insertion(\n    match_on_family, _taxons_subset_family, [\"family\"]\n)", "code_hash": "5610853f1ee76ad03ce20f08fdd63bf0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "aLJB", "name": "_"}, {"code": "mo.md(r\"\"\"## non nulls stopping at specificEpithet\"\"\")", "code_hash": "6f1161278de38c7a2f49dabe757e2294", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "nHfw", "name": "_"}, {"code": "_filter_specificEpithet = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"specificEpithet\") != \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\n\nto_be_match_on_specificEpithet = still_no_match.filter(_filter_specificEpithet)\n\n_x_specificEpithet = (\n    still_no_match.filter(_filter_specificEpithet)\n    .select(\"specificEpithet\", \"genus\")\n    .group_by(\"specificEpithet\", \"genus\")\n    .len()\n)\n\n_taxons_subset_specificEpithet = (\n    taxons.filter(\n        pl.col(\"specificEpithet\").is_in(\n            _x_specificEpithet[\"specificEpithet\"].unique().to_list()\n        ),\n        pl.col(\"genus\").is_in(_x_specificEpithet[\"genus\"].unique().to_list()),\n    )\n    .select(\"taxonID\", \"specificEpithet\", \"genus\")\n    .collect()\n)\nmatch_on_specificEpithet = join_and_parentId_insertion(\n    to_be_match_on_specificEpithet,\n    _taxons_subset_specificEpithet,\n    [\"specificEpithet\", \"genus\"],\n)", "code_hash": "88ea92eddec2791fabfc050a6a49528e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "xXTn", "name": "_"}, {"code": "mo.md(r\"\"\"## non nulls stopping at infraspecificEpithet\"\"\")", "code_hash": "cf020c757ce73e9ed4499b7aae03ac0b", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "AjVT", "name": "_"}, {"code": "_filter_infraspecificEpithet = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"infraspecificEpithet\") != \"\",\n)  # different filter because some don't have specificEpithet either, if I am not wrong\nto_be_match_on_infraspecificEpithet = still_no_match.filter(\n    _filter_infraspecificEpithet\n)\n\n_x_infraspecificEpithet = (\n    still_no_match.filter(_filter_infraspecificEpithet)\n    .select(\"infraspecificEpithet\", \"genus\")\n    .group_by(\"infraspecificEpithet\", \"genus\")\n    .len()\n)\n\n_taxons_subset_infraspecificEpithet = (\n    taxons.filter(\n        pl.col(\"infraspecificEpithet\").is_in(\n            _x_infraspecificEpithet[\"infraspecificEpithet\"].unique().to_list()\n        ),\n        pl.col(\"genus\").is_in(\n            _x_infraspecificEpithet[\"genus\"].unique().to_list()\n        ),\n    )\n    .select(\"taxonID\", \"infraspecificEpithet\", \"genus\")\n    .collect()\n)\n\nmatch_on_infraspecificEpithet = join_and_parentId_insertion(\n    to_be_match_on_infraspecificEpithet,\n    _taxons_subset_infraspecificEpithet,\n    [\"infraspecificEpithet\", \"genus\"],\n)", "code_hash": "eba56862832e028ac74d188c02f9f6c8", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "pHFh", "name": "_"}, {"code": "mo.md(r\"\"\"## Combining all these second matching wrangling stage dataframes of the ranks\"\"\")", "code_hash": "8fa0ac3399b354d7dbfda99e19d5b2bb", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "NCOB", "name": "_"}, {"code": "_to_drop = [\"current_feature\", \"current_name\", \"name_to_match\"]\n_to_drop2 = [\"current_feature\", \"current_name\"]\n_new_match = pl.concat(\n    [\n        match_on_class.drop(_to_drop),\n        match_on_order.drop(_to_drop),\n        match_on_family.drop(_to_drop),\n        match_on_specificEpithet.drop(_to_drop2),\n        match_on_infraspecificEpithet.drop(_to_drop2),\n    ]\n)\n# print(\"second wrangle new matches\", _new_match.shape)\n_new_match.write_csv(\"second_matches_set_from_wrangling.csv\")\n_new_match = pl.concat(\n    [\n        _new_match,\n        updated_to_matching.with_columns(\n            pl.col(\"parentNameUsageID\").cast(pl.Int64)\n        ),\n    ]\n)\n_new_match.write_csv(\"updated_to_matching.csv\")\n_no_match = no_match.join(\n    _new_match.select(\"speciesId\"), on=\"speciesId\", how=\"anti\"\n)\n_no_match.write_csv(\"no_match.csv\")", "code_hash": "d81c89a5083707a8e0ac1fc458b86601", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "aqbW", "name": "_"}], "metadata": {"marimo_version": "0.15.2"}, "version": "1"},
            "session": {"cells": [{"code_hash": "1c4af65e61673fa156224d1a44a913dd", "console": [], "id": "Hbol", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"introduction\">Introduction</h1>\n<span class=\"paragraph\">The documentation of this notebook is for those who are new to <code>python</code> and <code>polars</code></span>\n<span class=\"paragraph\">combination of r_transaltion.py script and more_r_translation.py marimo notebook</span>\n<span class=\"paragraph\">for the second matching wrangle, the parts for specificEpithet and infraSpecificEpithet doesn't match with many results.</span>\n<span class=\"paragraph\"><a href=\"https://docs.pola.rs/user-guide/getting-started/\" rel=\"noopener\" target=\"_blank\">Read the powers getting started guide</a>\nYou may check out the <code>Polars</code> API References and tutorials for more information.</span>\n<span class=\"paragraph\">String values are denoted with double quotations and contains unicode characters like alphabets, number and etc. eg: \"test\"</span>\n<span class=\"paragraph\">Booleans are binary values that are either 'True' or 'False'.  </span>\n<h1 id=\"imports\">Imports</h1></span>"}, "type": "data"}]}, {"code_hash": "ce4194fff5fe8b0eebb7a09769bc0473", "console": [], "id": "MJUe", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "e025bc903828106069c84aabb5a0c4ec", "console": [], "id": "vblA", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\"><code>with_columns()</code>:<a href=\"https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.with_columns.html\" rel=\"noopener\" target=\"_blank\"> Adds columns to this DataFrame. Added columns will replace existing columns with the same name.</a></span>\n<span class=\"paragraph\"><code>pl.col()</code>: <a href=\"https://docs.pola.rs/api/python/stable/reference/expressions/col.html\" rel=\"noopener\" target=\"_blank\">Create an expression representing column(s) in a DataFrame.</a>  </span>\n<span class=\"paragraph\"><code>.str</code>: to get the string functions so that you could chain it with other funcitons such as <code>strip_chars()</code>   </span>\n<span class=\"paragraph\"><code>strip_char()</code>: strip a certain characters that is present in the start or end of the string</span></span>"}, "type": "data"}]}, {"code_hash": "aec531ea99fb89c31feec8ef0103e84a", "console": [], "id": "bkHC", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "f960dad7d6e4ccbb564813492b17c3fc", "console": [], "id": "lEQa", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\"><code>transpose()</code>: matrix transpose the tabular data.</span></span>"}, "type": "data"}]}, {"code_hash": "326926b50dfc5120bb2413c46973fe5f", "console": [], "id": "PKri", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "740c615dabbd943e156e6d426dabb055", "console": [], "id": "Xref", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "1e0cab6e3e929b42d3d03e1e45ea6e18", "console": [], "id": "SFPL", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\"><code>~</code>: negation of the predicate expressions.<br />\n<code>fitler()</code> : <a href=\"https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.filter.html\" rel=\"noopener\" target=\"_blank\">Filter rows, retaining those that match the given predicate expression(s). Only rows where the predicate resolves as True are retained; when the predicate result is False (or null), the row is discarded.</a>  </span>\n<span class=\"paragraph\"><code>select()</code>: select specific columns </span>\n<span class=\"paragraph\"><code>when().then().otherwise()</code>: Like if else statement. \n<div class=\"language-scdoc codehilite\"><pre><span></span><code>e.g. infraspecificEpithet=pl.when(pl.col(&quot;infraspecificEpithet&quot;).is_null())\n        .then(pl.lit(&quot;&quot;))\n        .otherwise(pl.col(&quot;infraspecificEpithet&quot;))\n</code></pre></div>\nexplaination: when values in infraspecificEpithet column is null then populate it with the literal empty string (as denoted as \"\") otherise populate it with infraspecificEpithet.  </span>\n<span class=\"paragraph\"><code>lit()</code>: Tells the intepretator that you are refering to a literal string not any columns.  </span>\n<span class=\"paragraph\"><code>pl.col(\"col1\").is_in([\"a\",\"b\"])</code>: is_in is used to check and filter in values that are the list of strings, these strings do not refer to any columns.</span></span>"}, "type": "data"}]}, {"code_hash": "651051385bc53c333d98c016c1598f50", "console": [], "id": "BYtC", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "0a986c10a39f3669873e3545881fc184", "console": [], "id": "RGSE", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\">Lazyframes from <code>pl.scan_csv()</code> is use to efficiently process big csv files.</span></span>"}, "type": "data"}]}, {"code_hash": "41d3b7e805122f937ac25fb515025ff1", "console": [], "id": "Kclp", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "20e967ca7c38e7ddab3a577e282b91c3", "console": [], "id": "emfo", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\"><code>cast()</code>: Cast column(s) in to a specific polars datatype.  </span>\n<span class=\"paragraph\"><code>collect()</code>: Materialize this LazyFrame into a DataFrame. It is a slow function so use it sparingly and appropriately.</span>\n<span class=\"paragraph\"><code>is_duplicated()</code>: a expression function for checking if a row's set of values is duplicated from one of the previous row's set of values.  </span>\n<span class=\"paragraph\"><code>fill_null()</code>: fills null values in a column with a particular string.</span>\n<span class=\"paragraph\"><code>list[0]</code>: gets the first element of the list. the numbering starts from 0 because of computer's base 2 counting standards.</span></span>"}, "type": "data"}]}, {"code_hash": "d0bee1459bc800580e39aa090f0d97ff", "console": [], "id": "Hstk", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "2af03c47f68e34e926a5f5d66c460c3b", "console": [], "id": "nWHF", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"first-matching\">First Matching</h1>\n<span class=\"paragraph\"><code>sort()</code>: sort by a specific column(s) in ascending order</span></span>"}, "type": "data"}]}, {"code_hash": "c7f3a3438d801f195ee5a1cc82d021b0", "console": [], "id": "iLit", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d63a3ea8b7e381b43a40de6296620085", "console": [], "id": "ZHCJ", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "dd86a499496aff2645f80235dad40105", "console": [], "id": "RQiy", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\"><code>vstack()</code>: Stack the new dataframe vertically.<br />\n<code>group_by()</code>: group the data by some column(s) and then do an operation such as <code>mean()</code>, <code>len()</code>, <code>agg()</code> and etc.<br />\n<code>agg()</code>: a function to work on the groups.   </span>\n<span class=\"paragraph\">This line below is used to join the strings in the group using the delimiter \", \"\n<code>.agg(pl.col(\"feature_that_is_equal_to_canonicalName\").str.join(\", \"))</code>  </span>\n<span class=\"paragraph\"><code>split()</code>: used to split a string type column into a list of strings.</span></span>"}, "type": "data"}]}, {"code_hash": "be2f4ab2a04402de6adf9cc1b5fe6ace", "console": [], "id": "ROlb", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c943d6ec2349a5b647aadff8f2165077", "console": [], "id": "zsSM", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\"><code>copy()</code>: deep copy, you may search it up to read more about it.<br />\n<code>reverse()</code>: reverse a list in place<br />\n<code>index()</code>: The index() method in Python is used to find the position of the first occurrence of a specified value in a list or string.  </span>\n<span class=\"paragraph\"><code>bool()</code>: cast a value into boolean<br />\n<code>None</code>: Null value in python\n<code>append()</code>: add new element to the back of a list\n<code>len()</code>: get length of string,list,etc<br />\n<code>item()</code>: only in polars Series where there is one value, this will get that value out.  </span>\n<span class=\"paragraph\">This code returns a boolean <code>pl.Series</code>:\n<code>(\n                        _no_match_subset_to_update[_col1].item()\n                        == taxon_data_to_select_from[\n                            int(not bool(selected_row_int)), :\n                        ]\n                    )</code>  </span>\n<h1 id=\"i-stopped-the-documentation-here-as-i-was-given-the-instruction-that-these-instrucitons-are-no-longer-needed\">I stopped the documentation here as I was given the instruction that these instrucitons are no longer needed.</h1></span>"}, "type": "data"}]}, {"code_hash": "509ba5b325c022b6d94f8925bb09fb1a", "console": [], "id": "qnkX", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "ddb5f316ef72826d4b72561b97d0219e", "console": [], "id": "TqIu", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"second-matching-wrangle\">Second Matching Wrangle</h1></span>"}, "type": "data"}]}, {"code_hash": "a6d478b4bb7451122894fc9097b30c0d", "console": [], "id": "Vxnm", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "bf9782427d8438f1eeb86436453bd990", "console": [], "id": "DnEU", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"non-nulls-stopped-at-class\">Non nulls stopped at class</h2></span>"}, "type": "data"}]}, {"code_hash": "ee5dcd9f9a176667af8e2663a7ff6006", "console": [], "id": "ulZA", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "9346a2343e9ce579655ef335c26c50f2", "console": [], "id": "ecfG", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"non-nulls-stopping-at-order\">non nulls stopping at order</h2></span>"}, "type": "data"}]}, {"code_hash": "47b4fc24c54bb76c6e3d34f171e5f31b", "console": [], "id": "Pvdt", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "bd4f09eb18125680fab3775e7e111b20", "console": [], "id": "ZBYS", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"non-nulls-stopping-at-family\">non nulls stopping at family</h2></span>"}, "type": "data"}]}, {"code_hash": "5610853f1ee76ad03ce20f08fdd63bf0", "console": [], "id": "aLJB", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "6f1161278de38c7a2f49dabe757e2294", "console": [], "id": "nHfw", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"non-nulls-stopping-at-specificepithet\">non nulls stopping at specificEpithet</h2></span>"}, "type": "data"}]}, {"code_hash": "88ea92eddec2791fabfc050a6a49528e", "console": [], "id": "xXTn", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "cf020c757ce73e9ed4499b7aae03ac0b", "console": [], "id": "AjVT", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"non-nulls-stopping-at-infraspecificepithet\">non nulls stopping at infraspecificEpithet</h2></span>"}, "type": "data"}]}, {"code_hash": "eba56862832e028ac74d188c02f9f6c8", "console": [], "id": "pHFh", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "8fa0ac3399b354d7dbfda99e19d5b2bb", "console": [], "id": "NCOB", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"combining-all-these-second-matching-wrangling-stage-dataframes-of-the-ranks\">Combining all these second matching wrangling stage dataframes of the ranks</h2></span>"}, "type": "data"}]}, {"code_hash": "d81c89a5083707a8e0ac1fc458b86601", "console": [], "id": "aqbW", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}], "metadata": {"marimo_version": "0.15.2"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.15.2%22%0Aapp%20%3D%20marimo.App(width%3D%22full%22)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Introduction%20%20%0A%0A%20%20%20%20The%20documentation%20of%20this%20notebook%20is%20for%20those%20who%20are%20new%20to%20%60python%60%20and%20%60polars%60%0A%0A%20%20%20%20combination%20of%20r_transaltion.py%20script%20and%20more_r_translation.py%20marimo%20notebook%0A%0A%20%20%20%20for%20the%20second%20matching%20wrangle%2C%20the%20parts%20for%20specificEpithet%20and%20infraSpecificEpithet%20doesn't%20match%20with%20many%20results.%0A%0A%20%20%20%20%5BRead%20the%20powers%20getting%20started%20guide%5D(https%3A%2F%2Fdocs.pola.rs%2Fuser-guide%2Fgetting-started%2F)%0A%20%20%20%20You%20may%20check%20out%20the%20%60Polars%60%20API%20References%20and%20tutorials%20for%20more%20information.%0A%0A%20%20%20%20String%20values%20are%20denoted%20with%20double%20quotations%20and%20contains%20unicode%20characters%20like%20alphabets%2C%20number%20and%20etc.%20eg%3A%20%22test%22%0A%0A%20%20%20%20Booleans%20are%20binary%20values%20that%20are%20either%20'True'%20or%20'False'.%20%20%0A%0A%20%20%20%20%23%20Imports%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20polars%20as%20pl%0A%20%20%20%20return%20mo%2C%20pl%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%60with_columns()%60%3A%5B%20Adds%20columns%20to%20this%20DataFrame.%20Added%20columns%20will%20replace%20existing%20columns%20with%20the%20same%20name.%5D(https%3A%2F%2Fdocs.pola.rs%2Fapi%2Fpython%2Fstable%2Freference%2Fdataframe%2Fapi%2Fpolars.DataFrame.with_columns.html)%0A%0A%20%20%20%20%60pl.col()%60%3A%20%5BCreate%20an%20expression%20representing%20column(s)%20in%20a%20DataFrame.%5D(https%3A%2F%2Fdocs.pola.rs%2Fapi%2Fpython%2Fstable%2Freference%2Fexpressions%2Fcol.html)%20%20%0A%0A%20%20%20%20%20%60.str%60%3A%20to%20get%20the%20string%20functions%20so%20that%20you%20could%20chain%20it%20with%20other%20funcitons%20such%20as%20%60strip_chars()%60%20%20%20%0A%0A%20%20%20%20%60strip_char()%60%3A%20strip%20a%20certain%20characters%20that%20is%20present%20in%20the%20start%20or%20end%20of%20the%20string%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl)%3A%0A%20%20%20%20bos%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.read_csv(%22bos.csv%22)%0A%20%20%20%20%20%20%20%20.rename(%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22data%20cleanup%20changes%22%3A%20%22data%20cleanup%20changes%201%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22species%22%3A%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22subspecies%22%3A%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22domain%20%22%3A%20%22domain%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(pl.col(pl.String).str.strip_chars(%22%20%22))%0A%20%20%20%20%20%20%20%20.with_columns(genericName%3Dpl.col(%22genus%22))%0A%20%20%20%20)%0A%20%20%20%20return%20(bos%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%60transpose()%60%3A%20matrix%20transpose%20the%20tabular%20data.%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(bos)%3A%0A%20%20%20%20null_counts%20%3D%20(%0A%20%20%20%20%20%20%20%20bos.null_count()%0A%20%20%20%20%20%20%20%20.transpose(include_header%3DTrue)%0A%20%20%20%20%20%20%20%20.rename(%7B%22column%22%3A%20%22feature%22%2C%20%22column_0%22%3A%20%22len%22%7D)%0A%20%20%20%20)%0A%20%20%20%20columns_to_drop_as_all_nulls%20%3D%20(%0A%20%20%20%20%20%20%20%20null_counts.filter(null_counts%5B%22len%22%5D%20%3D%3D%20bos.shape%5B0%5D)%0A%20%20%20%20%20%20%20%20.transpose()%5B0%2C%20%3A%5D%0A%20%20%20%20%20%20%20%20.transpose()%0A%20%20%20%20%20%20%20%20.to_series()%0A%20%20%20%20%20%20%20%20.to_list()%0A%20%20%20%20)%0A%20%20%20%20return%20(columns_to_drop_as_all_nulls%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20columns_to_drop_as_they_are_just_changes_logs%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%22cleanup%20changes%20%22%2C%0A%20%20%20%20%20%20%20%20%22Data%20cleanup%20changes%22%2C%0A%20%20%20%20%20%20%20%20%22data%20cleanup%20changes%201%22%2C%0A%20%20%20%20%20%20%20%20%22changes%22%2C%0A%20%20%20%20%20%20%20%20%22cleanup%20changes%22%2C%0A%20%20%20%20%20%20%20%20%22Unnamed%3A%2018%22%2C%0A%20%20%20%20%20%20%20%20%22Unnamed%3A%2017%22%2C%0A%20%20%20%20%20%20%20%20%22Unnamed%3A%2019%22%2C%0A%20%20%20%20%20%20%20%20%22query%22%2C%0A%20%20%20%20%20%20%20%20%22query%20%22%2C%0A%20%20%20%20%20%20%20%20%22issue%22%2C%0A%20%20%20%20%20%20%20%20%22cleanup%20changes%2Fcomments%22%2C%0A%20%20%20%20%20%20%20%20%22subphylum%22%2C%0A%20%20%20%20%5D%0A%20%20%20%20return%20(columns_to_drop_as_they_are_just_changes_logs%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%60~%60%3A%20negation%20of%20the%20predicate%20expressions.%20%20%0A%20%20%20%20%60fitler()%60%20%3A%20%5BFilter%20rows%2C%20retaining%20those%20that%20match%20the%20given%20predicate%20expression(s).%20Only%20rows%20where%20the%20predicate%20resolves%20as%20True%20are%20retained%3B%20when%20the%20predicate%20result%20is%20False%20(or%20null)%2C%20the%20row%20is%20discarded.%5D(https%3A%2F%2Fdocs.pola.rs%2Fapi%2Fpython%2Fstable%2Freference%2Fdataframe%2Fapi%2Fpolars.DataFrame.filter.html)%20%20%0A%0A%20%20%20%20%60select()%60%3A%20select%20specific%20columns%20%0A%0A%20%20%20%20%60when().then().otherwise()%60%3A%20Like%20if%20else%20statement.%20%0A%20%20%20%20%60%60%60%0A%20%20%20%20e.g.%20infraspecificEpithet%3Dpl.when(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22infraspecificEpithet%22))%0A%20%20%20%20%60%60%60%0A%20%20%20%20explaination%3A%20when%20values%20in%20infraspecificEpithet%20column%20is%20null%20then%20populate%20it%20with%20the%20literal%20empty%20string%20(as%20denoted%20as%20%22%22)%20otherise%20populate%20it%20with%20infraspecificEpithet.%20%20%0A%0A%0A%20%20%20%20%60lit()%60%3A%20Tells%20the%20intepretator%20that%20you%20are%20refering%20to%20a%20literal%20string%20not%20any%20columns.%20%20%0A%0A%20%20%20%20%60pl.col(%22col1%22).is_in(%5B%22a%22%2C%22b%22%5D)%60%3A%20is_in%20is%20used%20to%20check%20and%20filter%20in%20values%20that%20are%20the%20list%20of%20strings%2C%20these%20strings%20do%20not%20refer%20to%20any%20columns.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20bos%2C%0A%20%20%20%20columns_to_drop_as_all_nulls%2C%0A%20%20%20%20columns_to_drop_as_they_are_just_changes_logs%2C%0A%20%20%20%20pl%2C%0A)%3A%0A%20%20%20%20bos_cleaned%20%3D%20(%0A%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20bos.drop(columns_to_drop_as_all_nulls)%0A%20%20%20%20%20%20%20%20%20%20%20%20.drop(columns_to_drop_as_they_are_just_changes_logs)%0A%20%20%20%20%20%20%20%20%20%20%20%20.select(~pl.selectors.starts_with(%22Unnamed%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20infraspecificEpithet%3Dpl.when(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22infraspecificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20infraspecificEpithet%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Glenea%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22mathemathica%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22mathematica%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22infraspecificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20specificEpithet%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Glenea%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22mathemathica%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22mathematica%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Bavia%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22sexupunctata%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22sexpunctata%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Omoedus%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22ephippigera%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22ephippiger%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Byblis%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22kallartha%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22kallarthra%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Alcockpenaeopsis%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22hungerfordi%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22hungerfordii%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Pseudosesarma%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22edwardsi%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22edwardsii%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Urocaridella%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22antonbruuni%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22antonbruunii%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genericName%22)%20%3D%3D%20%22Ocypode%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22)%20%3D%3D%20%22cordimanus%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22cordimana%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22specificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20domain%3Dpl.lit(%22Eukarya%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kingdom%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22phylum%22).is_in(%5B%22Ascomycota%22%2C%20%22Basidiomycota%22%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22fungi%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(pl.col(%22phylum%22)%20%3D%3D%20%22Cyanobacteria%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22Bacteria%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.when(pl.col(%22phylum%22)%20%3D%3D%20%22Ciliophora%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22Protista%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.lit(%22Animalia%22))%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonName%3Dpl.col(%22taxonName%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.str.replace_all(%22%3Ci%3E%22%2C%20%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.str.replace_all(%22%3C%2Fi%3E%22%2C%20%22%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20return%20(bos_cleaned%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22Lazyframes%20from%20%60pl.scan_csv()%60%20is%20use%20to%20efficiently%20process%20big%20csv%20files.%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl)%3A%0A%20%20%20%20_filter%20%3D%20pl.col(%22taxonomicStatus%22).is_in(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22accepted%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22synonym%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22homotypic%20synonym%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22proparte%20synonym%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22heterotypic%20synonym%22%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20taxon_ranked_only%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22gbif%2FTaxon.tsv%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20separator%3D%22%5Ct%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20quote_char%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20cache%3DTrue%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.filter((pl.col(%22taxonRank%22)%20!%3D%20%22unranked%22)%20%26%20_filter)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genericName%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonomicStatus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22acceptedNameUsageID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20%22domain%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.filter((pl.col(%22genus%22)%20!%3D%20%22%22)%20%26%20(pl.col(%22specificEpithet%22)%20!%3D%20%22%22))%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20infraspecificEpithet%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(%22%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22infraspecificEpithet%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20return%20(taxon_ranked_only%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%60cast()%60%3A%20Cast%20column(s)%20in%20to%20a%20specific%20polars%20datatype.%20%20%0A%0A%20%20%20%20%60collect()%60%3A%20Materialize%20this%20LazyFrame%20into%20a%20DataFrame.%20It%20is%20a%20slow%20function%20so%20use%20it%20sparingly%20and%20appropriately.%0A%0A%20%20%20%20%60is_duplicated()%60%3A%20a%20expression%20function%20for%20checking%20if%20a%20row's%20set%20of%20values%20is%20duplicated%20from%20one%20of%20the%20previous%20row's%20set%20of%20values.%20%20%0A%0A%20%20%20%20%60fill_null()%60%3A%20fills%20null%20values%20in%20a%20column%20with%20a%20particular%20string.%0A%0A%20%20%20%20%60list%5B0%5D%60%3A%20gets%20the%20first%20element%20of%20the%20list.%20the%20numbering%20starts%20from%200%20because%20of%20computer's%20base%202%20counting%20standards.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(bos_cleaned%2C%20pl%2C%20taxon_ranked_only)%3A%0A%20%20%20%20matching%20%3D%20(%0A%20%20%20%20%20%20%20%20taxon_ranked_only.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20other%3Dpl.LazyFrame(bos_cleaned)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%5B%22genericName%22%2C%20%22specificEpithet%22%2C%20%22infraspecificEpithet%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22right%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.rename(%7B%22taxonID%22%3A%20%22matched_taxonID%22%7D)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22speciesId%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22matched_taxonID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22acceptedNameUsageID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonName%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22domain%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22kingdom%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22phylum%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22class%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subclass%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22superorder%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22order%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22sub-order%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraorder%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22section%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subsection%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22superfamily%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22family%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subfamily%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22tribe%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22subgenus%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genericName%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(None))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22infraspecificEpithet%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22infraspecificEpithet%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20%23%20matching%20and%20contetnious%20split%0A%20%20%20%20%23%20What%20makes%20a%20data%20point%20contentious%20is%20where%20it%20has%20duplicate%20speciesId.%0A%20%20%20%20matching%20%3D%20matching.filter(~pl.col(%22speciesId%22).is_duplicated()).with_columns(%0A%20%20%20%20%20%20%20%20acceptedNameUsageID%3Dpl.col(%22acceptedNameUsageID%22)%0A%20%20%20%20%20%20%20%20.fill_null(pl.lit(None))%0A%20%20%20%20%20%20%20%20.cast(pl.Int64)%0A%20%20%20%20)%0A%20%20%20%20contentious%20%3D%20matching.filter(%0A%20%20%20%20%20%20%20%20(pl.col(%22speciesId%22).is_duplicated())%0A%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20acceptedNameUsageID%3Dpl.col(%22acceptedNameUsageID%22)%0A%20%20%20%20%20%20%20%20.fill_null(pl.lit(None))%0A%20%20%20%20%20%20%20%20.cast(pl.Int64)%0A%20%20%20%20)%0A%0A%20%20%20%20unique_contentious%20%3D%20contentious.filter(%0A%20%20%20%20%20%20%20%20(pl.col(%22acceptedNameUsageID%22).is_null())%0A%20%20%20%20%20%20%20%20%26%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22matched_taxonID%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22acceptedNameUsageID%22).implode()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20unique_contentious_speciesId%20%3D%20(%0A%20%20%20%20%20%20%20%20unique_contentious.select(%22speciesId%22).collect().to_series().implode()%0A%20%20%20%20)%20%20%23%20Just%20the%20speciesIds%0A%20%20%20%20contentious%20%3D%20contentious.filter(%0A%20%20%20%20%20%20%20%20~pl.col(%22speciesId%22).is_in(unique_contentious_speciesId)%0A%20%20%20%20)%20%20%23%20Removing%20unique%20conentious%0A%0A%20%20%20%20matching%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5Bmatching%2C%20unique_contentious%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20matching%20%3D%20matching.with_columns(%0A%20%20%20%20%20%20%20%20genus%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genus%22).is_null())%20%26%20(pl.col(%22specificEpithet%22).is_not_null())%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.then(pl.col(%22taxonName%22).str.split(%22%20%22).list%5B0%5D)%0A%20%20%20%20%20%20%20%20.otherwise(%22genus%22)%0A%20%20%20%20)%0A%0A%20%20%20%20no_match%20%3D%20(%0A%20%20%20%20%20%20%20%20matching.filter(pl.col(%22matched_taxonID%22).is_null())%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonRank%3Dpl.lit(%22BOSuncornirmedSpecies%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonomicStatus%3Dpl.lit(%22BOSunformired%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.lit(None)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.fill_null(%22%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20return%20(no_match%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20First%20Matching%0A%0A%20%20%20%20%60sort()%60%3A%20sort%20by%20a%20specific%20column(s)%20in%20ascending%20order%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl)%3A%0A%20%20%20%20repeated_accepted_taxons%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%22gbif%2FTaxon.tsv%22%2C%20separator%3D%22%5Ct%22%2C%20quote_char%3DNone%2C%20cache%3DTrue)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22taxonomicStatus%22)%20%3D%3D%20pl.lit(%22accepted%22))%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22kingdom%22).is_in(%5B%22Animalia%22%2C%20%22Plantae%22%5D))%0A%20%20%20%20%20%20%20%20.filter(~pl.col(%22canonicalName%22).is_null())%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22canonicalName%22)%20!%3D%20%22%22)%0A%20%20%20%20%20%20%20%20.sort(%22canonicalName%22)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22canonicalName%22).is_duplicated())%0A%20%20%20%20)%0A%20%20%20%20return%20(repeated_accepted_taxons%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20priority_columns%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%22family%22%2C%0A%20%20%20%20%20%20%20%20%22order%22%2C%0A%20%20%20%20%20%20%20%20%22class%22%2C%0A%20%20%20%20%20%20%20%20%22phylum%22%2C%0A%20%20%20%20%20%20%20%20%22kingdom%22%2C%0A%20%20%20%20%5D%0A%20%20%20%20return%20(priority_columns%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%60vstack()%60%3A%20Stack%20the%20new%20dataframe%20vertically.%20%20%0A%20%20%20%20%60group_by()%60%3A%20group%20the%20data%20by%20some%20column(s)%20and%20then%20do%20an%20operation%20such%20as%20%60mean()%60%2C%20%60len()%60%2C%20%60agg()%60%20and%20etc.%20%20%0A%20%20%20%20%60agg()%60%3A%20a%20function%20to%20work%20on%20the%20groups.%20%20%20%0A%0A%20%20%20%20This%20line%20below%20is%20used%20to%20join%20the%20strings%20in%20the%20group%20using%20the%20delimiter%20%22%2C%20%22%0A%20%20%20%20%60.agg(pl.col(%22feature_that_is_equal_to_canonicalName%22).str.join(%22%2C%20%22))%60%20%20%0A%0A%20%20%20%20%60split()%60%3A%20used%20to%20split%20a%20string%20type%20column%20into%20a%20list%20of%20strings.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20priority_columns%2C%20repeated_accepted_taxons)%3A%0A%20%20%20%20_schema%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22feature_that_is_equal_to_canonicalName%22%3A%20pl.String%2C%0A%20%20%20%20%20%20%20%20%22matches%22%3A%20pl.String%2C%0A%20%20%20%20%7D%0A%20%20%20%20_r%20%3D%20(repeated_accepted_taxons).collect()%0A%20%20%20%20RAT_interim%20%3D%20pl.DataFrame(schema%3D_schema)%0A%20%20%20%20for%20_col%20in%20priority_columns%3A%0A%20%20%20%20%20%20%20%20_canonical_names%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20_r.filter(pl.col(%22canonicalName%22)%20%3D%3D%20pl.col(_col))%0A%20%20%20%20%20%20%20%20%20%20%20%20.select(%22canonicalName%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.unique()%0A%20%20%20%20%20%20%20%20%20%20%20%20.to_series()%0A%20%20%20%20%20%20%20%20%20%20%20%20.to_list()%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20if%20len(_canonical_names)%20!%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_row%20%3D%20pl.DataFrame(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22feature_that_is_equal_to_canonicalName%22%3A%20_col%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22matches%22%3A%20_canonical_names%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20schema%3D_schema%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20RAT_interim%20%3D%20RAT_interim.vstack(_row)%0A%20%20%20%20RAT_feats%20%3D%20(%0A%20%20%20%20%20%20%20%20RAT_interim.group_by(%22matches%22)%0A%20%20%20%20%20%20%20%20.agg(pl.col(%22feature_that_is_equal_to_canonicalName%22).str.join(%22%2C%20%22))%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22feature_that_is_equal_to_canonicalName%22).str.split(%22%2C%20%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.sort(%22feature_that_is_equal_to_canonicalName%22)%0A%20%20%20%20)%0A%20%20%20%20return%20(RAT_feats%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%60copy()%60%3A%20deep%20copy%2C%20you%20may%20search%20it%20up%20to%20read%20more%20about%20it.%20%20%0A%20%20%20%20%60reverse()%60%3A%20reverse%20a%20list%20in%20place%20%20%0A%20%20%20%20%60index()%60%3A%20The%20index()%20method%20in%20Python%20is%20used%20to%20find%20the%20position%20of%20the%20first%20occurrence%20of%20a%20specified%20value%20in%20a%20list%20or%20string.%20%20%0A%0A%20%20%20%20%60bool()%60%3A%20cast%20a%20value%20into%20boolean%20%20%0A%20%20%20%20%60None%60%3A%20Null%20value%20in%20python%0A%20%20%20%20%60append()%60%3A%20add%20new%20element%20to%20the%20back%20of%20a%20list%0A%20%20%20%20%60len()%60%3A%20get%20length%20of%20string%2Clist%2Cetc%20%20%0A%20%20%20%20%60item()%60%3A%20only%20in%20polars%20Series%20where%20there%20is%20one%20value%2C%20this%20will%20get%20that%20value%20out.%20%20%0A%0A%20%20%20%20This%20code%20returns%20a%20boolean%20%60pl.Series%60%3A%0A%20%20%20%20%60%60%60%0A%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%3D%20taxon_data_to_select_from%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20int(not%20bool(selected_row_int))%2C%20%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%60%60%60%20%20%0A%0A%20%20%20%20%23%20I%20stopped%20the%20documentation%20here%20as%20I%20was%20given%20the%20instruction%20that%20these%20instrucitons%20are%20no%20longer%20needed.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(RAT_feats%2C%20no_match%2C%20pl%2C%20priority_columns%2C%20repeated_accepted_taxons)%3A%0A%20%20%20%20updated_to_matching%20%3D%20%5B%5D%0A%20%20%20%20still_no_match%20%3D%20%5B%5D%0A%20%20%20%20_collected_repeated_taxons%20%3D%20repeated_accepted_taxons.collect().fill_null(%22%22)%0A%20%20%20%20_reversed_priority_columns%20%3D%20priority_columns.copy()%0A%20%20%20%20_reversed_priority_columns.reverse()%0A%20%20%20%20for%20_col%20in%20_reversed_priority_columns%3A%0A%20%20%20%20%20%20%20%20for%20_match%20in%20RAT_feats%5B%22matches%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20skipping%20those%20that%20are%20not%20in%20RAT_feats%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20_match%20not%20in%20no_match%5B_col%5D.to_list()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20taxon_data_to_select_from%20%3D%20_collected_repeated_taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22canonicalName%22)%20%3D%3D%20_match%0A%20%20%20%20%20%20%20%20%20%20%20%20).select(%5B%22taxonID%22%5D%20%2B%20_reversed_priority_columns)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Select%20from%20the%20two%20rows%20what%20taxon%20data%20to%20select.%0A%20%20%20%20%20%20%20%20%20%20%20%20selected_row_int%20%3D%20-1%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20_tuple%20in%20enumerate(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20taxon_data_to_select_from.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%22taxonID%22%5D%20%2B%20priority_columns%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).iter_rows()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20col_index%20%3D%20priority_columns.index(_col)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x%20%3D%20_tuple%5Bcol_index%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20bool(_x)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20selected_row_int%20%3D%20i%20%20%23%20Since%20there%20are%20usually%20only%20two%20rows%20from%20taxon_data_to_select_from%2C%20the%20results%20is%20either%200%20or%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20assert%20selected_row_int%20!%3D%20-1%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20has_predicament1%20is%20when%20kingdom%20to%20genus%20all%20has%20values%20and%20it%20is%20kind%20of%20leveled%20between%20the%20two%20rows%20of%20the%20taxon%20data.%0A%20%20%20%20%20%20%20%20%20%20%20%20has_predicament1%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20_l%20%3D%20taxon_data_to_select_from%5B%22family%22%5D.to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20_col%20%3D%3D%20%22genus%22%20and%20_l%5B0%5D%20is%20not%20None%20and%20_l%5B1%5D%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20has_predicament1%20%3D%20True%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20chosen_taxonId%20%3D%20taxon_data_to_select_from%5Bselected_row_int%2C%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20other_taxonId%20%3D%20taxon_data_to_select_from%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20int(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20not%20bool(selected_row_int)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%20%20%23%20converts%20the%20int%20value%20into%20boolean%20than%20reverse%20the%20boolean%20before%20converting%20back%20to%20int.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Getting%20the%20_no_match_subset_to_update%20section%0A%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20no_match.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(_col)%20%3D%3D%20_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20_x%20%3D%20_reversed_priority_columns%5B%3A-3%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20feature_to_find_nulls%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x%5B_reversed_priority_columns.index(_col)%20%2B%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20len(_x)%20%3E%20_reversed_priority_columns.index(_col)%20%2B%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20)%20%20%23%20just%20the%20next%20feature%20to%20find%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20feature_to_find_nulls%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20_no_match_subset_to_update.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(feature_to_find_nulls)%20%3D%3D%20%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20_no_match_subset_to_update.is_empty()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20still_no_match_subset%20%3D%20no_match.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(_col)%20%3D%3D%20_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20current_feature%3Dpl.lit(_col)%2C%20current_name%3Dpl.lit(_match)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20still_no_match.append(still_no_match_subset)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Settling%20predicament%20one%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20this%20predicament%20thing%20should%20only%20happen%20when%20the%20subset%20is%20of%20only%201%20row.%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20has_predicament1%20and%20_no_match_subset_to_update.shape%5B0%5D%20%3D%3D%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20_col1%20in%20%5B%22class%22%2C%20%22order%22%2C%20%22family%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20*%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%3D%20taxon_data_to_select_from%5Bselected_row_int%2C%20%3A%5D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_col1%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20match%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20_col1%20in%20%5B%22class%22%2C%20%22order%22%2C%20%22family%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20*%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%3D%20taxon_data_to_select_from%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20int(not%20bool(selected_row_int))%2C%20%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%20%20%23%20searching%20in%20the%20three%20columns%20of%20interests%20for%20matches%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20assert%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%20%20%23%20Double%20check%20that%20there%20is%20no%20unmatch.%20%20%23%20noqa%3A%20E712%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20temp%20%3D%20chosen_taxonId%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chosen_taxonId%20%3D%20other_taxonId%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20other_taxonId%20%3D%20temp%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20turning%20these%20rows%20to%20matching%20by%20filling%20parentNameUsageID%0A%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20_no_match_subset_to_update.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22genus%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(other_taxonId))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.lit(chosen_taxonId))%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20updated_to_matching.append(_no_match_subset_to_update)%0A%0A%20%20%20%20%23%20turn%20them%20into%20dataframes%20and%20writing%20to%20csv%20files%0A%20%20%20%20updated_to_matching%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20updated_to_matching%2C%20rechunk%3DTrue%2C%20parallel%3DTrue%0A%20%20%20%20)%0A%20%20%20%20updated_to_matching.write_csv(%22first_matches_set_from_wrangling.csv%22)%0A%0A%20%20%20%20still_no_match%20%3D%20pl.concat(still_no_match%2C%20rechunk%3DTrue%2C%20parallel%3DTrue)%0A%20%20%20%20still_no_match%20%3D%20still_no_match.join(%0A%20%20%20%20%20%20%20%20updated_to_matching.select(%22speciesId%22)%2C%20on%3D%22speciesId%22%2C%20how%3D%22anti%22%0A%20%20%20%20)%0A%20%20%20%20return%20still_no_match%2C%20updated_to_matching%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%20Second%20Matching%20Wrangle%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20priority_columns)%3A%0A%20%20%20%20taxons%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%22gbif%2FTaxon.tsv%22%2C%20separator%3D%22%5Ct%22%2C%20quote_char%3DNone%2C%20cache%3DTrue)%0A%20%20%20%20%20%20%20%20.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22taxonomicStatus%22)%20%3D%3D%20pl.lit(%22accepted%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22taxonRank%22)%20!%3D%20%22unranked%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22kingdom%22).is_in(%5B%22Animalia%22%2C%20%22Plantae%22%5D))%0A%20%20%20%20%20%20%20%20.select(%5B%22taxonID%22%5D%20%2B%20priority_columns)%0A%20%20%20%20)%0A%0A%0A%20%20%20%20def%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on%3A%20pl.DataFrame%2C%20_taxons_subset%3A%20pl.DataFrame%2C%20on%3A%20list%0A%20%20%20%20)%20-%3E%20pl.DataFrame%3A%0A%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on.join(_taxons_subset%2C%20on%3Don)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(pl.col(%22taxonID%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(%22taxonID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22parentNameUsageID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.drop(%22taxonID%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20join_and_parentId_insertion%2C%20taxons%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20Non%20nulls%20stopped%20at%20class%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_class%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22current_feature%22)%20%3D%3D%20%22phylum%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_class%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter_class).then(%22class%22).otherwise(None)%0A%20%20%20%20).filter(_filter_class)%0A%0A%20%20%20%20_x_class%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_class)%0A%20%20%20%20%20%20%20%20.select(%22class%22)%0A%20%20%20%20%20%20%20%20.group_by(%22class%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_class%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22class%22).is_in(_x_class%5B%22class%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20pl.col(%22phylum%22).is_in(_x_class%5B%22phylum%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22class%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_class%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on_class%2C%20_taxons_subset_class%2C%20%5B%22class%22%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_class%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20non%20nulls%20stopping%20at%20order%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_order%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22current_feature%22)%20%3D%3D%20%22phylum%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_order%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter_order).then(%22order%22).otherwise(None)%0A%20%20%20%20).filter(_filter_order)%0A%20%20%20%20_x_order%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_order)%0A%20%20%20%20%20%20%20%20.select(%22order%22)%0A%20%20%20%20%20%20%20%20.group_by(%22order%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_order%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_in(_x_order%5B%22order%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_order%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on_order%2C%20_taxons_subset_order%2C%20%5B%22order%22%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_order%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20non%20nulls%20stopping%20at%20family%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_family%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_family%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter_family).then(%22family%22).otherwise(None)%0A%20%20%20%20).filter(_filter_family)%0A%20%20%20%20_x_family%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_family)%0A%20%20%20%20%20%20%20%20.select(%22family%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.group_by(%22family%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_family%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_in(_x_family%5B%22family%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_in(_x_family%5B%22order%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22family%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_family%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20match_on_family%2C%20_taxons_subset_family%2C%20%5B%22family%22%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_family%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20non%20nulls%20stopping%20at%20specificEpithet%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_specificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20to_be_match_on_specificEpithet%20%3D%20still_no_match.filter(_filter_specificEpithet)%0A%0A%20%20%20%20_x_specificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_specificEpithet)%0A%20%20%20%20%20%20%20%20.select(%22specificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.group_by(%22specificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_specificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x_specificEpithet%5B%22specificEpithet%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_in(_x_specificEpithet%5B%22genus%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22specificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_specificEpithet%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20to_be_match_on_specificEpithet%2C%0A%20%20%20%20%20%20%20%20_taxons_subset_specificEpithet%2C%0A%20%20%20%20%20%20%20%20%5B%22specificEpithet%22%2C%20%22genus%22%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_specificEpithet%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20non%20nulls%20stopping%20at%20infraspecificEpithet%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(join_and_parentId_insertion%2C%20pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20_filter_infraspecificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20!%3D%20%22%22%2C%0A%20%20%20%20)%20%20%23%20different%20filter%20because%20some%20don't%20have%20specificEpithet%20either%2C%20if%20I%20am%20not%20wrong%0A%20%20%20%20to_be_match_on_infraspecificEpithet%20%3D%20still_no_match.filter(%0A%20%20%20%20%20%20%20%20_filter_infraspecificEpithet%0A%20%20%20%20)%0A%0A%20%20%20%20_x_infraspecificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter_infraspecificEpithet)%0A%20%20%20%20%20%20%20%20.select(%22infraspecificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.group_by(%22infraspecificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset_infraspecificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x_infraspecificEpithet%5B%22infraspecificEpithet%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x_infraspecificEpithet%5B%22genus%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22infraspecificEpithet%22%2C%20%22genus%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%0A%20%20%20%20match_on_infraspecificEpithet%20%3D%20join_and_parentId_insertion(%0A%20%20%20%20%20%20%20%20to_be_match_on_infraspecificEpithet%2C%0A%20%20%20%20%20%20%20%20_taxons_subset_infraspecificEpithet%2C%0A%20%20%20%20%20%20%20%20%5B%22infraspecificEpithet%22%2C%20%22genus%22%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(match_on_infraspecificEpithet%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23%20Combining%20all%20these%20second%20matching%20wrangling%20stage%20dataframes%20of%20the%20ranks%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20match_on_class%2C%0A%20%20%20%20match_on_family%2C%0A%20%20%20%20match_on_infraspecificEpithet%2C%0A%20%20%20%20match_on_order%2C%0A%20%20%20%20match_on_specificEpithet%2C%0A%20%20%20%20no_match%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20updated_to_matching%2C%0A)%3A%0A%20%20%20%20_to_drop%20%3D%20%5B%22current_feature%22%2C%20%22current_name%22%2C%20%22name_to_match%22%5D%0A%20%20%20%20_to_drop2%20%3D%20%5B%22current_feature%22%2C%20%22current_name%22%5D%0A%20%20%20%20_new_match%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_class.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_order.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_family.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_specificEpithet.drop(_to_drop2)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_infraspecificEpithet.drop(_to_drop2)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20%23%20print(%22second%20wrangle%20new%20matches%22%2C%20_new_match.shape)%0A%20%20%20%20_new_match.write_csv(%22second_matches_set_from_wrangling.csv%22)%0A%20%20%20%20_new_match%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20_new_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20updated_to_matching.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22parentNameUsageID%22).cast(pl.Int64)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20_new_match.write_csv(%22updated_to_matching.csv%22)%0A%20%20%20%20_no_match%20%3D%20no_match.join(%0A%20%20%20%20%20%20%20%20_new_match.select(%22speciesId%22)%2C%20on%3D%22speciesId%22%2C%20how%3D%22anti%22%0A%20%20%20%20)%0A%20%20%20%20_no_match.write_csv(%22no_match.csv%22)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">8f405892138ed0eebe83310a7964d5f4958c58aa8806103683394149e6ff667a</marimo-code-hash>
</body>
</html>
