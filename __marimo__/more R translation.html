<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>more R translation.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>more R translation</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/index-BB71mG_d.js"></script>
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.15.2/dist/assets/index-DryPQDfA.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "more R translation.py",
            "mode": "read",
            "version": "0.15.2",
            "serverToken": "static",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "plain", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "full", "reference_highlighting": true, "theme": "dark"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "package_management": {"manager": "pip"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "full"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "mo.md(r\"\"\"# DF\"\"\")", "code_hash": "bc97dfe80f95aa77bca2d859e3e5228d", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "Hbol", "name": "_"}, {"code": "import marimo as mo\nimport polars as pl\n\nfrom r_translation import join\n\nmatching, contentious = join()\nmatching = matching.with_columns(\n    genus=pl.when(\n        (pl.col(\"genus\").is_null()) & (pl.col(\"specificEpithet\").is_not_null())\n    )\n    .then(pl.col(\"taxonName\").str.split(\" \").list[0])\n    .otherwise(\"genus\")\n)", "code_hash": "b4c5bcdbeb7a3ca949d4d46811a338d0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "contentious.collect_schema().keys()", "code_hash": "c1e8f2561fe7edcbb8b5b475a6e8f953", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "mo.md(r\"\"\"nomatch lazyframe is for BOS data point that has no current match in gbif data set.\"\"\")", "code_hash": "6d51c643cb8d9262e2640878e409da8c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "FZee", "name": "_"}, {"code": "nomatch = (\n    matching.filter(pl.col(\"matched_taxonID\").is_null())\n    .with_columns(\n        taxonRank=pl.lit(\"BOSuncornirmedSpecies\"),\n        taxonomicStatus=pl.lit(\"BOSunformired\"),\n        parentNameUsageID=pl.lit(None),\n    )\n    .fill_null(\"\")  \n    .collect()\n)\nnomatch", "code_hash": "b122cfb367ac277420ccb4d45b49986a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "matching_with_populated_match_taxonID = matching.filter(\n    pl.col(\"matched_taxonID\").is_not_null()\n).with_columns(\n    taxonRank=pl.lit(None),\n    taxonomicStatus=pl.lit(None),\n    parentNameUsageID=pl.lit(None),\n)", "code_hash": "6cd46d200401f8417f5c5e608f1b42d2", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "mo.md(r\"\"\"# repeated_accepted_taxons = RAT\"\"\")", "code_hash": "dcc234701f02d13056a0bedc02dab1c1", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "BYtC", "name": "_"}, {"code": "repeated_accepted_taxons = (\n    pl.scan_csv(\"gbif/Taxon.tsv\", separator=\"\\t\", quote_char=None, cache=True)\n    .filter(pl.col(\"taxonomicStatus\") == pl.lit(\"accepted\"))\n    .filter(pl.col(\"kingdom\").is_in([\"Animalia\", \"Plantae\"]))\n    .filter(~pl.col(\"canonicalName\").is_null())\n    .filter(pl.col(\"canonicalName\") != \"\")\n    .sort(\"canonicalName\")\n    .filter(pl.col(\"canonicalName\").is_duplicated())\n)", "code_hash": "c7f3a3438d801f195ee5a1cc82d021b0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "priority_columns = [\n    \"infraspecificEpithet\",\n    \"specificEpithet\",\n    \"genus\",\n    \"family\",\n    \"order\",\n    \"class\",\n    \"phylum\",\n    \"kingdom\",\n]\n\n_schema = {\n    \"feature_that_is_equal_to_canonicalName\": pl.String,\n    \"matches\": pl.String,\n}\n_r = (repeated_accepted_taxons).collect()\nRAT_interim = pl.DataFrame(schema=_schema)\nfor _col in priority_columns:\n    _canonical_names = (\n        (\n            _r.filter(pl.col(\"canonicalName\") == pl.col(_col))\n            .select(\"canonicalName\")\n            .unique()\n        )\n        .to_series()\n        .to_list()\n    )\n    if len(_canonical_names) != 0:\n        _row = pl.DataFrame(\n            data={\n                \"feature_that_is_equal_to_canonicalName\": _col,\n                \"matches\": _canonical_names,\n            },\n            schema=_schema,\n        )\n        RAT_interim = RAT_interim.vstack(_row)\nRAT_feats = (\n    RAT_interim.group_by(\"matches\")\n    .agg(pl.col(\"feature_that_is_equal_to_canonicalName\").str.join(\", \"))\n    .with_columns(\n        pl.col(\"feature_that_is_equal_to_canonicalName\").str.split(\", \")\n    )\n    .sort(\"feature_that_is_equal_to_canonicalName\")\n)", "code_hash": "031e310d99f9bdbc34ab634bea6a4145", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n# matching attempt\n\n\n\"\"\"\n)", "code_hash": "29205831e4212dc05421ee87a8c8c971", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "nWHF", "name": "_"}, {"code": "RAT_feats", "code_hash": "106e02d0d6b30d186bb81451827576a7", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "JgYX", "name": "_"}, {"code": "updated_to_matching = []\n# all_taxon_data_to_be_selected_from = []\nstill_no_match = []\n_collected_repeated_taxons = repeated_accepted_taxons.collect().fill_null(\"\")\n_reversed_priority_columns = priority_columns.copy()\n_reversed_priority_columns.reverse()\nfor _col in _reversed_priority_columns:\n    for _match in RAT_feats[\"matches\"]:\n        # skipping those that are not in RAT_feats\n        if _match not in nomatch[_col].to_list():\n            continue\n\n        print(\"-------\\nFeature:\", _col, \",Name:\", _match)\n\n        taxon_data_to_select_from = _collected_repeated_taxons.filter(\n            pl.col(\"canonicalName\") == _match\n        ).select([\"taxonID\"] + _reversed_priority_columns)\n\n        # Select from the two rows what taxon data to select.\n        selected_row_int = -1\n        for i, _tuple in enumerate(\n            taxon_data_to_select_from.select(\n                [\"taxonID\"] + priority_columns\n            ).iter_rows()\n        ):\n            col_index = priority_columns.index(_col)\n            _x = _tuple[col_index]\n            if not bool(_x):\n                selected_row_int = i  # Since there are usually only two rows from taxon_data_to_select_from, the results is either 0 or 1\n                break\n        assert selected_row_int != -1\n\n        # has_predicament1 is when kingdom to genus all has values and it is kind of leveled between the two rows of the taxon data.\n        has_predicament1 = False\n        _l = taxon_data_to_select_from[\"family\"].to_list()\n        if _col == \"genus\" and _l[0] != None and _l[1] != None:\n            print(\"same level detected\")\n            has_predicament1 = True\n\n        chosen_taxonId = taxon_data_to_select_from[selected_row_int, 0]\n        other_taxonId = taxon_data_to_select_from[\n            int(not bool(selected_row_int)), 0\n        ]\n\n        # Getting the _no_match_subset_to_update section\n        _no_match_subset_to_update = nomatch.filter(\n            pl.col(_col) == _match,\n        )\n        _x = _reversed_priority_columns[:-3]\n        feature_to_find_nulls = (\n            _x[_reversed_priority_columns.index(_col) + 1]\n            if len(_x) > _reversed_priority_columns.index(_col) + 1\n            else None\n        )  # just the next feature to find null\n        if feature_to_find_nulls is not None:\n            print(\"feature_to_find_nulls\", feature_to_find_nulls)\n            _no_match_subset_to_update = _no_match_subset_to_update.filter(\n                pl.col(feature_to_find_nulls) == \"\"\n            )\n            if _no_match_subset_to_update.is_empty():\n                still_no_match_subset = nomatch.filter(\n                    pl.col(_col) == _match,\n                ).with_columns(\n                    current_feature=pl.lit(_col), current_name=pl.lit(_match)\n                )\n                still_no_match.append(still_no_match_subset)\n                print(\n                    \"\\n\\n\\n\\n\\nskipping\",\n                    _col,\n                    _match,\n                    \"\\n this _no_match_subset_to_update dataframe doesn't have the same tax rank level\\n\",\n                    still_no_match_subset.select(_reversed_priority_columns),\n                )\n                print(\"---------\")\n                continue\n\n        # Settling predicament one\n        # this predicament thing should only happen when the subset is of only 1 row.\n        if has_predicament1 and _no_match_subset_to_update.shape[0] == 1:\n            match = True\n            for _col1 in [\"class\", \"order\", \"family\"]:\n                match *= (\n                    _no_match_subset_to_update[_col1].item()\n                    == taxon_data_to_select_from[selected_row_int, :][\n                        _col1\n                    ].item()\n                )\n            if not match:\n                match = True\n                for _col1 in [\"class\", \"order\", \"family\"]:\n                    match *= (\n                        _no_match_subset_to_update[_col1].item()\n                        == taxon_data_to_select_from[\n                            int(not bool(selected_row_int)), :\n                        ][_col1].item()\n                    )  # searching in the three columns of interests for matches\n                assert match == True  # Double check that there is no unmatch.\n                print(\"changing chosen taxonId\")\n                temp = chosen_taxonId\n                chosen_taxonId = other_taxonId\n                other_taxonId = temp\n\n        # turning these rows to matching by filling parentNameUsageID\n        _no_match_subset_to_update = _no_match_subset_to_update.with_columns(\n            parentNameUsageID=pl.when(\n                (pl.col(\"infraspecificEpithet\").is_null())\n                & (pl.col(\"specificEpithet\").is_not_null())\n                & (pl.col(\"genus\").is_not_null())\n            )\n            .then(pl.lit(other_taxonId))\n            .otherwise(pl.lit(chosen_taxonId))\n        )\n\n        # Debugging for matching data from gbif to new matched rows\n        print(\n            \"taxon_data_to_select_from\\n\",\n            taxon_data_to_select_from,\n        )\n        print(\"parentNameUsageID chosen:\", chosen_taxonId)\n        print(\"no_match_subset_to_update \")\n        print(_no_match_subset_to_update.select(_reversed_priority_columns))\n        print(\"---------\")\n\n        updated_to_matching.append(_no_match_subset_to_update)\n        # all_taxon_data_to_be_selected_from.append(taxon_data_to_select_from)\n\n# turn them into dataframes and writing to csv files\nupdated_to_matching = pl.concat(\n    updated_to_matching, rechunk=True, parallel=True\n)\nupdated_to_matching.write_csv(\"updated_to_matching.csv\")\nupdated_to_matching.write_csv(\"first_matches_set_from_wrangling.csv\")\n# all_taxon_data_to_be_selected_from = pl.concat(\n#     all_taxon_data_to_be_selected_from, rechunk=True, parallel=True\n# )\n# all_taxon_data_to_be_selected_from.write_csv(\n#     \"all_taxon_data_to_be_selected_from.csv\"\n# )\nstill_no_match = pl.concat(still_no_match, rechunk=True, parallel=True)\n# still_no_match.write_csv(\"still_no_match.csv\")", "code_hash": "0114ec21e9c2395c0e0cb96349112acb", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "mo.md(r\"\"\"## still no match stuff\"\"\")", "code_hash": "32dafeb7f0855ab0142db0802d364710", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "TqIu", "name": "_"}, {"code": "mo.md(r\"\"\"### `current_feature` uniques\"\"\")", "code_hash": "083809938bb4d1a81552506494cb138b", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "Vxnm", "name": "_"}, {"code": "still_no_match[\"current_feature\"].unique()", "code_hash": "33ab0a9d7ada37c97e1d834c2aea0151", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "DnEU", "name": "_"}, {"code": "mo.md(r\"\"\"### `current_name` uniques\"\"\")", "code_hash": "bfee185721d348a468116a0e92f27a42", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "ulZA", "name": "_"}, {"code": "still_no_match[\"current_name\"].unique()", "code_hash": "57a1e790bc576a0075757649719ce953", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ecfG", "name": "_"}, {"code": "mo.md(r\"\"\"## number of rows in still no match\"\"\")", "code_hash": "057f9e7fead0dac181fd80293ce2c25e", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "Pvdt", "name": "_"}, {"code": "still_no_match.shape[0]", "code_hash": "900226645560b36eae9a57264bf14fc5", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZBYS", "name": "_"}, {"code": "mo.md(r\"\"\"# second matching wrangle of new `Taxons` df with `still_no_match`\"\"\")", "code_hash": "009dc336968649136696c60d8718a0b9", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "aLJB", "name": "_"}, {"code": "taxons = (\n    pl.scan_csv(\"gbif/Taxon.tsv\", separator=\"\\t\", quote_char=None, cache=True)\n    .filter(\n        pl.col(\"taxonomicStatus\") == pl.lit(\"accepted\"),\n        pl.col(\"taxonRank\") != \"unranked\",\n    )\n    .filter(pl.col(\"kingdom\").is_in([\"Animalia\", \"Plantae\"]))\n    .select([\"taxonID\"] + priority_columns)\n)\ntaxons.collect().shape", "code_hash": "265a8221f4cecc346c1c4c3c4f09962b", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "mo.md(r\"\"\"## stop at class, there is only current_feature = phylum matches\"\"\")", "code_hash": "41bae431d2d32210958c99a469507128", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "nHfw", "name": "_"}, {"code": "priority_columns", "code_hash": "7428b3489a7108c1e6bf0d702c82c8b0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "xWYo", "name": "_"}, {"code": "## stop at class, there is only current_feature = phylum matches\n_filter = (\n      pl.col(\"class\") != \"\",\n    pl.col(\"order\") == \"\",\n    pl.col(\"family\") == \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n    pl.col(\"current_feature\") == \"phylum\",\n)\nmatch_on_class = still_no_match.with_columns(\n    name_to_match=pl.when(_filter)\n    .then(\"class\")\n    .otherwise(None)\n).filter(\n  _filter\n)\n\n_x1 = (\n    still_no_match.filter(_filter)\n    .select(\"class\", \"phylum\")\n    .group_by(\"class\", \"phylum\")\n    .len()\n)\n\n_taxons_subset = taxons.filter(\n    pl.col(\"family\").is_null(),\n    pl.col(\"order\").is_null(),\n    pl.col(\"genus\").is_null(),\n    pl.col(\"class\").is_in(_x1[\"class\"].unique()),\n    pl.col(\"specificEpithet\").is_null(),\n    pl.col(\"infraspecificEpithet\").is_null(),\n    pl.col(\"phylum\").is_in(_x1[\"phylum\"].unique()),\n).select(\"taxonID\", \"class\")\nmatch_on_class = (\n    pl.LazyFrame(match_on_class)\n    .join(\n        _taxons_subset,\n        on=\"class\",\n    )\n    .with_columns(\n        parentNameUsageID=pl.when(pl.col(\"taxonID\").is_not_null())\n        .then(\"taxonID\")\n        .otherwise(\"parentNameUsageID\")\n    )\n    .drop(\"taxonID\")\n).collect()\n\nmatch_on_class.shape", "code_hash": "461581c3fea6c7580609b9b460ad9a6f", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "xXTn", "name": "_"}, {"code": "match_on_class.group_by(\"parentNameUsageID\", \"name_to_match\").len()", "code_hash": "17d594c856bdb50c1387ecc0bf708967", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "AjVT", "name": "_"}, {"code": "match_on_class.shape", "code_hash": "e59efdb19d98b09e5d9b061978fed228", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "pHFh", "name": "_"}, {"code": "mo.md(r\"\"\"## stops at order there is only current_feature = phylum matches\"\"\")", "code_hash": "b230d7f93f3d653f2c0cd95ec2cd72a1", "config": {"column": null, "disabled": false, "hide_code": true}, "id": "NCOB", "name": "_"}, {"code": "## stops at order there is only current_feature = phylum matches\n_filter = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") == \"\",\n    pl.col(\"genus\") == \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n    pl.col(\"current_feature\") == \"phylum\",\n)\nmatch_on_order = still_no_match.with_columns(\n    name_to_match=pl.when(_filter).then(\"order\").otherwise(None)\n).filter(_filter)\n_x1 = (\n    still_no_match.filter(_filter)\n    .select(\"order\", \"phylum\")\n    .group_by(\"order\", \"phylum\")\n    .len()\n)\n\n_taxons_subset = (\n    taxons.filter(\n        pl.col(\"family\").is_null(),\n        pl.col(\"order\").is_in(_x1[\"order\"].unique().to_list()),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n        pl.col(\"phylum\").is_in(_x1[\"phylum\"].unique().to_list()),\n    )\n    .select(\"taxonID\", \"order\")\n    .collect()\n)\nmatch_on_order = (\n    match_on_order.join(\n        _taxons_subset,\n        on=\"order\",\n    )\n    .with_columns(\n        parentNameUsageID=pl.when(pl.col(\"taxonID\").is_not_null())\n        .then(\"taxonID\")\n        .otherwise(\"parentNameUsageID\")\n    )\n    .drop(\"taxonID\")\n)\nmatch_on_order.shape", "code_hash": "11465815ab1748354a0e4eac5f16edec", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "aqbW", "name": "_"}, {"code": "match_on_order.group_by(\"parentNameUsageID\", \"name_to_match\").len()", "code_hash": "faa4e1496856caa65a67d6265809aae8", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TRpd", "name": "_"}, {"code": "match_on_order.shape", "code_hash": "4dc97360e40545b698edecbb0ba5ed56", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TXez", "name": "_"}, {"code": "mo.md(r\"\"\"## stops at family, current_feature contains both phylum and order\"\"\")", "code_hash": "1d233999c0328eecafc197f0fbb45b14", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "dNNg", "name": "_"}, {"code": "## stops at family there is only current_feature = phylum matches\n_filter = (\n         pl.col(\"class\") != \"\",\n        pl.col(\"order\") != \"\",\n        pl.col(\"family\") != \"\",\n        pl.col(\"genus\") == \"\",\n        pl.col(\"specificEpithet\") == \"\",\n        pl.col(\"infraspecificEpithet\") == \"\",\n)\nmatch_on_family = still_no_match.with_columns(\n    name_to_match=pl.when(\n   _filter\n    )\n    .then(\"family\")\n    .otherwise(None)\n).filter(\n   _filter\n)\n_x1 = (\n    still_no_match.filter(\n        _filter\n    )\n    .select(\"family\", \"phylum\", \"order\")\n    .group_by(\"family\", \"phylum\", \"order\")\n    .len()\n)\n\n_taxons_subset = (\n    taxons.filter(\n        pl.col(\"family\").is_in(_x1[\"family\"].unique().to_list()),\n        pl.col(\"genus\").is_null(),\n        pl.col(\"specificEpithet\").is_null(),\n        pl.col(\"infraspecificEpithet\").is_null(),\n        pl.col(\"phylum\").is_in(_x1[\"phylum\"].unique().to_list()),\n        pl.col(\"order\").is_in(_x1[\"order\"].unique().to_list()),\n    )\n    .select(\"taxonID\", \"family\")\n    .collect()\n)\nmatch_on_family = (\n    match_on_family.join(\n        _taxons_subset,\n        on=\"family\",\n    )\n    .with_columns(\n        parentNameUsageID=pl.when(pl.col(\"taxonID\").is_not_null())\n        .then(\"taxonID\")\n        .otherwise(\"parentNameUsageID\")\n    )\n    .drop(\"taxonID\")\n)\nmatch_on_family.shape", "code_hash": "24bd5c5c216b623f5971b8d24f469b13", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "yCnT", "name": "_"}, {"code": "match_on_family.group_by(\n    \"parentNameUsageID\", \"name_to_match\", \"current_feature\"\n).len().filter(pl.col(\"current_feature\") == \"phylum\")", "code_hash": "a19aac178781ab31a469cf045919cf5a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "wlCL", "name": "_"}, {"code": "match_on_family.group_by(\n    \"parentNameUsageID\", \"name_to_match\", \"current_feature\"\n).len().filter(pl.col(\"current_feature\") == \"order\")", "code_hash": "9b89c89ff9b7a3d06257f34d61cb53ed", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "kqZH", "name": "_"}, {"code": "match_on_family.shape", "code_hash": "22a10eb8e24556f6fdbafbfff142bcc6", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "wAgl", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n## genus  \n\nThere is nothing for rank genus.\n\"\"\"\n)", "code_hash": "8e32c5b819476852385485077b1fb9a0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "awtG", "name": "_"}, {"code": "_filter = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"specificEpithet\") == \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\n_g = still_no_match.filter(_filter)\n_g", "code_hash": "ba9165fc9e3ddaa2c73d7bdd29d75f6e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "IMjo", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n## stops at specificEpithet there is only current_feature = phylum matches \n\n### something is wrong with some specificEpithet and infraSpecificEpithet for both pl.col('current_feature').is_in(['phylum','order']) cant be found in gbif.\n\"\"\"\n)", "code_hash": "cdc0c379d31c10fe0a643c5a2a458b0b", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "rEll", "name": "_"}, {"code": "## stops at family there is only current_feature = phylum matches\n_filter = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"specificEpithet\") != \"\",\n    pl.col(\"infraspecificEpithet\") == \"\",\n)\n\nto_be_match_on_specificEpithet = still_no_match.filter(_filter)\n\n_x1 = (\n    still_no_match.filter(_filter)\n    .select(\n        \"specificEpithet\",\n        \"genus\",\n    )\n    .group_by(\n        \"specificEpithet\",\n        \"genus\",\n    )\n    .len()\n)\n\n_taxons_subset = (\n    taxons.filter(\n        pl.col(\"specificEpithet\").is_in(\n            _x1[\"specificEpithet\"].unique().to_list()\n        ),\n        pl.col(\"genus\").is_in(_x1[\"genus\"].unique().to_list()),\n    )\n    .select(\n        \"taxonID\",\n        \"specificEpithet\",\n        \"genus\",\n    )\n    .collect()\n)\n\n# TAXON.TSV doesn't have pl.col(\"genus\")=='Dicaeum',pl.col('specificEpithet')=='chysorrheum'\nmatch_on_specificEpithet = (\n    to_be_match_on_specificEpithet.join(\n        _taxons_subset,\n        on=[\"genus\", \"specificEpithet\"],\n        # how=\"left\"\n    )\n    .with_columns(\n        parentNameUsageID=pl.when(pl.col(\"taxonID\").is_not_null())\n        .then(\"taxonID\")\n        .otherwise(\"parentNameUsageID\")\n    )\n    .drop(\"taxonID\")\n)\nmatch_on_specificEpithet.shape\n# match_on_specificEpithet.write_csv(\"matching_attempt_on_specificEpithet.csv\")", "code_hash": "79b7f583948d9235dbbb9c0a8b3313f9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "dGlV", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n## infraspecificepithet\n\ndifferent filter because some don't have specificEpithet either, if I am not wrong\n\"\"\"\n)", "code_hash": "390eaf1a8c6a7ea6fefcafecc570fcda", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SVvN", "name": "_"}, {"code": "# InfraspecificEpithet\n\n## stops at family there is only current_feature = phylum matches\n_filter = (\n    pl.col(\"class\") != \"\",\n    pl.col(\"order\") != \"\",\n    pl.col(\"family\") != \"\",\n    pl.col(\"genus\") != \"\",\n    pl.col(\"infraspecificEpithet\") != \"\",\n)  # different filter because some don't have specificEpithet either, if I am not wrong\nto_be_match_on_infraspecificEpithet = still_no_match.filter(_filter)\n\n_x1 = (\n    still_no_match.filter(_filter)\n    .select(\n        \"infraspecificEpithet\",\n        \"genus\",\n    )\n    .group_by(\n        \"infraspecificEpithet\",\n        \"genus\",\n    )\n    .len()\n)\n\n_taxons_subset = (\n    taxons.filter(\n        pl.col(\"infraspecificEpithet\").is_in(\n            _x1[\"infraspecificEpithet\"].unique().to_list()\n        ),\n        pl.col(\"genus\").is_in(_x1[\"genus\"].unique().to_list()),\n    )\n    .select(\n        \"taxonID\",\n        \"infraspecificEpithet\",\n        \"genus\",\n    )\n    .collect()\n)\n\n\n# TAXON.TSV doesn't have pl.col(\"genus\")=='Dicaeum',pl.col('specificEpithet')=='chysorrheum'\nmatch_on_infraspecificEpithet = (\n    to_be_match_on_infraspecificEpithet.join(\n        _taxons_subset,\n        on=[\"genus\", \"infraspecificEpithet\"],\n    )\n    .with_columns(\n        parentNameUsageID=pl.when(pl.col(\"taxonID\").is_not_null())\n        .then(\"taxonID\")\n        .otherwise(\"parentNameUsageID\")\n    )\n    .drop(\"taxonID\")\n)\n# print(match_on_infraspecificEpithet.select(priority_columns))", "code_hash": "6a3702388aaa5e48e52f120c2935a2a6", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "cNIS", "name": "_"}, {"code": "mo.md(\n    r\"\"\"\n#combining updated parent id rows\n\ntodo: specificEpithet infraSpecificepithet\n\"\"\"\n)", "code_hash": "0b5ec19235d13036f37e3e64d8164680", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SdmI", "name": "_"}, {"code": "match_on_class.columns", "code_hash": "104636d67f58724b1ef2d9c98a26c8be", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "HBeq", "name": "_"}, {"code": "mo.md(r\"\"\"unfortunately my 2nd wrangle did some redundant work. I don't know how to remove this wrangling\"\"\")", "code_hash": "f869e9c5e5edc04542513b4b38cb49fa", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PDMd", "name": "_"}, {"code": "_to_drop = [\"current_feature\", \"current_name\", \"name_to_match\"]\n_to_drop2 = [\"current_feature\", \"current_name\"]\n_new_match = pl.concat(\n    [\n        match_on_class.drop(_to_drop),\n        match_on_order.drop(_to_drop),\n        match_on_family.drop(_to_drop),\n        match_on_specificEpithet.drop(_to_drop2),\n        match_on_infraspecificEpithet.drop(_to_drop2),\n    ]\n)\n_redundant = updated_to_matching.with_columns(\n).join(_new_match, on=\"speciesId\")  # removing redundant\nprint(\"parentNameUsageID on the redundant check:\",(_redundant[\"parentNameUsageID\"] != _redundant[\"parentNameUsageID_right\"]).any())\n_new_match.write_csv(\"second_matches_set_from_wrangling.csv\")\n\n_new_match = _new_match.join(_redundant.select('speciesId'),on = \"speciesId\",how='anti')\nprint(\"new match shape\",_new_match.shape)\nprint()\n_new_match = pl.concat(\n    [\n        _new_match,\n        updated_to_matching.with_columns(\n            pl.col(\"parentNameUsageID\").cast(pl.Int64)\n        ),\n    ]\n)\n_new_match.write_csv(\"updated_to_matching.csv\")\nprint(\"shape of all matches:\",_new_match.shape[0])\n# print(\"new match unique speciesId\",_new_match.select(\"speciesId\").unique())\nprint(\"shape of nomatch before any matches\",nomatch.shape[0])\n_x = nomatch.join(_new_match.select(\"speciesId\"), on=\"speciesId\", how=\"anti\")\nprint(_x.shape)", "code_hash": "560416ac15064e8c612476eb896172ef", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lgWD", "name": "_"}, {"code": "5943 + 2502", "code_hash": "e4759e3c76b64be7e2224e120928ba04", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "uoIF", "name": "_"}], "metadata": {"marimo_version": "0.15.2"}, "version": "1"},
            "session": {"cells": [{"code_hash": "bc97dfe80f95aa77bca2d859e3e5228d", "console": [], "id": "Hbol", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"df\">DF</h1></span>"}, "type": "data"}]}, {"code_hash": "b4c5bcdbeb7a3ca949d4d46811a338d0", "console": [{"name": "stdout", "text": "bos_df columns: ['speciesId', 'phylum', 'class', 'subclass', 'order', 'sub-order', 'infraorder', 'section', 'subsection', 'superfamily', 'family', 'subfamily', 'tribe', 'genus', 'subgenus', 'specificEpithet', 'infraspecificEpithet', 'taxonName', 'source_file', 'taxon', 'superorder', 'domain', 'kingdom', 'section/parvorder', 'Column2', 'infraclass', 'commonName', 'species2', 'clade 1', 'clade 2', 'clade 3', 'genericName']\n", "type": "stream"}, {"name": "stdout", "text": "taxon.csv columns, odict_keys(['taxonID', 'genericName', 'genus', 'specificEpithet', 'infraspecificEpithet', 'taxonomicStatus', 'acceptedNameUsageID'])\n", "type": "stream"}], "id": "MJUe", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c1e8f2561fe7edcbb8b5b475a6e8f953", "console": [], "id": "vblA", "outputs": [{"data": {"text/html": "<pre style='font-size: 12px'>odict_keys([&#x27;speciesId&#x27;, &#x27;matched_taxonID&#x27;, &#x27;acceptedNameUsageID&#x27;, &#x27;taxonName&#x27;, &#x27;domain&#x27;, &#x27;kingdom&#x27;, &#x27;phylum&#x27;, &#x27;class&#x27;, &#x27;subclass&#x27;, &#x27;superorder&#x27;, &#x27;order&#x27;, &#x27;sub-order&#x27;, &#x27;infraorder&#x27;, &#x27;section&#x27;, &#x27;subsection&#x27;, &#x27;superfamily&#x27;, &#x27;family&#x27;, &#x27;subfamily&#x27;, &#x27;tribe&#x27;, &#x27;genus&#x27;, &#x27;subgenus&#x27;, &#x27;genericName&#x27;, &#x27;specificEpithet&#x27;, &#x27;infraspecificEpithet&#x27;])</pre>"}, "type": "data"}]}, {"code_hash": "6d51c643cb8d9262e2640878e409da8c", "console": [], "id": "FZee", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\">nomatch lazyframe is for BOS data point that has no current match in gbif data set.</span></span>"}, "type": "data"}]}, {"code_hash": "b122cfb367ac277420ccb4d45b49986a", "console": [], "id": "Xref", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (8_445, 27)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>matched_taxonID</th><th>acceptedNameUsageID</th><th>taxonName</th><th>domain</th><th>kingdom</th><th>phylum</th><th>class</th><th>subclass</th><th>superorder</th><th>order</th><th>sub-order</th><th>infraorder</th><th>section</th><th>subsection</th><th>superfamily</th><th>family</th><th>subfamily</th><th>tribe</th><th>genus</th><th>subgenus</th><th>genericName</th><th>specificEpithet</th><th>infraspecificEpithet</th><th>taxonRank</th><th>taxonomicStatus</th><th>parentNameUsageID</th></tr><tr><td>str</td><td>i64</td><td>i64</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>null</td></tr></thead><tbody><tr><td>&quot;A-Anne-Clit-Hirudinea-000001&quot;</td><td>null</td><td>null</td><td>&quot;Glossiphoniidae sp. &quot;1&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Annelida&quot;</td><td>&quot;Clitellata&quot;</td><td>&quot;Hirudinea&quot;</td><td>&quot;&quot;</td><td>&quot;Rhynchobdellida&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Glossiphoniidae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000002&quot;</td><td>null</td><td>null</td><td>&quot;Glossiphoniidae sp. &quot;2&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Annelida&quot;</td><td>&quot;Clitellata&quot;</td><td>&quot;Hirudinea&quot;</td><td>&quot;&quot;</td><td>&quot;Rhynchobdellida&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Glossiphoniidae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000003&quot;</td><td>null</td><td>null</td><td>&quot;Glossiphoniidae sp. &quot;3&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Annelida&quot;</td><td>&quot;Clitellata&quot;</td><td>&quot;Hirudinea&quot;</td><td>&quot;&quot;</td><td>&quot;Rhynchobdellida&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Glossiphoniidae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000004&quot;</td><td>null</td><td>null</td><td>&quot;Hirudinidae sp. &quot;1&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Annelida&quot;</td><td>&quot;Clitellata&quot;</td><td>&quot;Hirudinea&quot;</td><td>&quot;&quot;</td><td>&quot;Arhynchobdellida&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Hirudinidae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Anne-Clit-Hirudinea-000005&quot;</td><td>null</td><td>null</td><td>&quot;Hirudinidae sp. &quot;2&quot;&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Annelida&quot;</td><td>&quot;Clitellata&quot;</td><td>&quot;Hirudinea&quot;</td><td>&quot;&quot;</td><td>&quot;Arhynchobdellida&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Hirudinidae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;A-Hemi-Enteropneusta-000010&quot;</td><td>null</td><td>null</td><td>&quot;Acorn worm sp.&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Hemichordata&quot;</td><td>&quot;Enteropneusta&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;blank-UnID&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Hemi-Enteropneusta-000011&quot;</td><td>null</td><td>null</td><td>&quot;Acorn worm sp.&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Hemichordata&quot;</td><td>&quot;Enteropneusta&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;blank-UnID&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Phoronida-000002&quot;</td><td>null</td><td>null</td><td>&quot;Phoronida sp.&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Phoronida&quot;</td><td>&quot;blank-Phor&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;blank-Phor&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Phoronidae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;A-Phoronida-000003&quot;</td><td>null</td><td>null</td><td>&quot;Phoronida sp. SEA-4090&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Animalia&quot;</td><td>&quot;Phoronida&quot;</td><td>&quot;blank-Phor&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;blank-Phor&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Phoronidae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr><tr><td>&quot;B-Alga-Cyanobacteria-000003&quot;</td><td>null</td><td>null</td><td>&quot;Microcystis icthyoblabe&quot;</td><td>&quot;Eukarya&quot;</td><td>&quot;Bacteria&quot;</td><td>&quot;Cyanobacteria&quot;</td><td>&quot;Cyanobacteriia&quot;</td><td>&quot;Oscillatoriophycideae&quot;</td><td>&quot;&quot;</td><td>&quot;Cyanobacteriales&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Microcystaceae&quot;</td><td>&quot;&quot;</td><td>&quot;&quot;</td><td>&quot;Microcystis&quot;</td><td>&quot;&quot;</td><td>&quot;Microcystis&quot;</td><td>&quot;icthyoblabe&quot;</td><td>&quot;&quot;</td><td>&quot;BOSuncornirmedSpecies&quot;</td><td>&quot;BOSunformired&quot;</td><td>null</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "6cd46d200401f8417f5c5e608f1b42d2", "console": [], "id": "SFPL", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "dcc234701f02d13056a0bedc02dab1c1", "console": [], "id": "BYtC", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"repeated_accepted_taxons-rat\">repeated_accepted_taxons = RAT</h1></span>"}, "type": "data"}]}, {"code_hash": "c7f3a3438d801f195ee5a1cc82d021b0", "console": [], "id": "RGSE", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "031e310d99f9bdbc34ab634bea6a4145", "console": [], "id": "Kclp", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "29205831e4212dc05421ee87a8c8c971", "console": [], "id": "nWHF", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"matching-attempt\">matching attempt</h1></span>"}, "type": "data"}]}, {"code_hash": "106e02d0d6b30d186bb81451827576a7", "console": [], "id": "JgYX", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (1_639, 2)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>matches</th><th>feature_that_is_equal_to_canonicalName</th></tr><tr><td>str</td><td>list[str]</td></tr></thead><tbody><tr><td>&quot;Micrognathozoa&quot;</td><td>[&quot;class&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Sirenia&quot;</td><td>[&quot;family&quot;, &quot;order&quot;]</td></tr><tr><td>&quot;Passeriformes&quot;</td><td>[&quot;family&quot;, &quot;order&quot;]</td></tr><tr><td>&quot;Psychopsis&quot;</td><td>[&quot;genus&quot;]</td></tr><tr><td>&quot;Parlatoria&quot;</td><td>[&quot;genus&quot;]</td></tr><tr><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Diplura&quot;</td><td>[&quot;genus&quot;, &quot;order&quot;, &quot;class&quot;]</td></tr><tr><td>&quot;Arthropoda&quot;</td><td>[&quot;genus&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Ctenophora&quot;</td><td>[&quot;genus&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Acanthocephala&quot;</td><td>[&quot;genus&quot;, &quot;phylum&quot;]</td></tr><tr><td>&quot;Protura&quot;</td><td>[&quot;order&quot;, &quot;class&quot;]</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "0114ec21e9c2395c0e0cb96349112acb", "console": [], "id": "iLit", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "32dafeb7f0855ab0142db0802d364710", "console": [], "id": "TqIu", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"still-no-match-stuff\">still no match stuff</h2></span>"}, "type": "data"}]}, {"code_hash": "083809938bb4d1a81552506494cb138b", "console": [], "id": "Vxnm", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h3 id=\"current_feature-uniques\"><code>current_feature</code> uniques</h3></span>"}, "type": "data"}]}, {"code_hash": "33ab0a9d7ada37c97e1d834c2aea0151", "console": [], "id": "DnEU", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (2,)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>current_feature</th></tr><tr><td>str</td></tr></thead><tbody><tr><td>&quot;order&quot;</td></tr><tr><td>&quot;phylum&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "bfee185721d348a468116a0e92f27a42", "console": [], "id": "ulZA", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h3 id=\"current_name-uniques\"><code>current_name</code> uniques</h3></span>"}, "type": "data"}]}, {"code_hash": "57a1e790bc576a0075757649719ce953", "console": [], "id": "ecfG", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (4,)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>current_name</th></tr><tr><td>str</td></tr></thead><tbody><tr><td>&quot;Arthropoda&quot;</td></tr><tr><td>&quot;Siluriformes&quot;</td></tr><tr><td>&quot;Passeriformes&quot;</td></tr><tr><td>&quot;Ctenophora&quot;</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "057f9e7fead0dac181fd80293ce2c25e", "console": [], "id": "Pvdt", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"number-of-rows-in-still-no-match\">number of rows in still no match</h2></span>"}, "type": "data"}]}, {"code_hash": "900226645560b36eae9a57264bf14fc5", "console": [], "id": "ZBYS", "outputs": [{"data": {"text/html": "<pre style='font-size: 12px'>2287</pre>"}, "type": "data"}]}, {"code_hash": "009dc336968649136696c60d8718a0b9", "console": [], "id": "aLJB", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"second-matching-wrangle-of-new-taxons-df-with-still_no_match\">second matching wrangle of new <code>Taxons</code> df with <code>still_no_match</code></h1></span>"}, "type": "data"}]}, {"code_hash": "265a8221f4cecc346c1c4c3c4f09962b", "console": [], "id": "emfo", "outputs": [{"data": {"application/json": "[2755560, 9]"}, "type": "data"}]}, {"code_hash": "41bae431d2d32210958c99a469507128", "console": [], "id": "nHfw", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"stop-at-class-there-is-only-current_feature-phylum-matches\">stop at class, there is only current_feature = phylum matches</h2></span>"}, "type": "data"}]}, {"code_hash": "7428b3489a7108c1e6bf0d702c82c8b0", "console": [], "id": "xWYo", "outputs": [{"data": {"application/json": "[\"infraspecificEpithet\", \"specificEpithet\", \"genus\", \"family\", \"order\", \"class\", \"phylum\", \"kingdom\"]"}, "type": "data"}]}, {"code_hash": "461581c3fea6c7580609b9b460ad9a6f", "console": [{"name": "stderr", "text": "/tmp/marimo_230255/__marimo__cell_xXTn_.py:47: DeprecationWarning: `is_in` with a collection of the same datatype is ambiguous and deprecated.\nPlease use `implode` to return to previous behavior.\n\nSee https://github.com/pola-rs/polars/issues/22149 for more information.\n  ).collect()\n", "type": "stream"}], "id": "xXTn", "outputs": [{"data": {"application/json": "[42, 30]"}, "type": "data"}]}, {"code_hash": "17d594c856bdb50c1387ecc0bf708967", "console": [], "id": "AjVT", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (4, 3)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>parentNameUsageID</th><th>name_to_match</th><th>len</th></tr><tr><td>i64</td><td>str</td><td>u32</td></tr></thead><tbody><tr><td>353</td><td>&quot;Ostracoda&quot;</td><td>16</td></tr><tr><td>10713444</td><td>&quot;Collembola&quot;</td><td>2</td></tr><tr><td>365</td><td>&quot;Tentaculata&quot;</td><td>7</td></tr><tr><td>11545536</td><td>&quot;Copepoda&quot;</td><td>17</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "e59efdb19d98b09e5d9b061978fed228", "console": [], "id": "pHFh", "outputs": [{"data": {"application/json": "[42, 30]"}, "type": "data"}]}, {"code_hash": "b230d7f93f3d653f2c0cd95ec2cd72a1", "console": [], "id": "NCOB", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"stops-at-order-there-is-only-current_feature-phylum-matches\">stops at order there is only current_feature = phylum matches</h2></span>"}, "type": "data"}]}, {"code_hash": "11465815ab1748354a0e4eac5f16edec", "console": [], "id": "aqbW", "outputs": [{"data": {"application/json": "[896, 30]"}, "type": "data"}]}, {"code_hash": "faa4e1496856caa65a67d6265809aae8", "console": [], "id": "TRpd", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (21, 3)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>parentNameUsageID</th><th>name_to_match</th><th>len</th></tr><tr><td>i64</td><td>str</td><td>u32</td></tr></thead><tbody><tr><td>788</td><td>&quot;Mantodea&quot;</td><td>2</td></tr><tr><td>643</td><td>&quot;Isopoda&quot;</td><td>54</td></tr><tr><td>1500</td><td>&quot;Cumacea&quot;</td><td>6</td></tr><tr><td>637</td><td>&quot;Decapoda&quot;</td><td>103</td></tr><tr><td>787</td><td>&quot;Plecoptera&quot;</td><td>1</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>1496</td><td>&quot;Araneae&quot;</td><td>1</td></tr><tr><td>1373</td><td>&quot;Stomatopoda&quot;</td><td>10</td></tr><tr><td>841</td><td>&quot;Mysida&quot;</td><td>7</td></tr><tr><td>872</td><td>&quot;Scorpiones&quot;</td><td>2</td></tr><tr><td>1426</td><td>&quot;Sessilia&quot;</td><td>11</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "4dc97360e40545b698edecbb0ba5ed56", "console": [], "id": "TXez", "outputs": [{"data": {"application/json": "[896, 30]"}, "type": "data"}]}, {"code_hash": "1d233999c0328eecafc197f0fbb45b14", "console": [], "id": "dNNg", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"stops-at-family-current_feature-contains-both-phylum-and-order\">stops at family, current_feature contains both phylum and order</h2></span>"}, "type": "data"}]}, {"code_hash": "24bd5c5c216b623f5971b8d24f469b13", "console": [], "id": "yCnT", "outputs": [{"data": {"application/json": "[1131, 30]"}, "type": "data"}]}, {"code_hash": "a19aac178781ab31a469cf045919cf5a", "console": [], "id": "wlCL", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (172, 4)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>parentNameUsageID</th><th>name_to_match</th><th>current_feature</th><th>len</th></tr><tr><td>i64</td><td>str</td><td>str</td><td>u32</td></tr></thead><tbody><tr><td>9644</td><td>&quot;Eucnemidae&quot;</td><td>&quot;phylum&quot;</td><td>1</td></tr><tr><td>5925</td><td>&quot;Gryllidae&quot;</td><td>&quot;phylum&quot;</td><td>28</td></tr><tr><td>8888</td><td>&quot;Idoteidae&quot;</td><td>&quot;phylum&quot;</td><td>1</td></tr><tr><td>2783</td><td>&quot;Menoponidae&quot;</td><td>&quot;phylum&quot;</td><td>18</td></tr><tr><td>6981</td><td>&quot;Erotylidae&quot;</td><td>&quot;phylum&quot;</td><td>1</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>7780</td><td>&quot;Chrysomelidae&quot;</td><td>&quot;phylum&quot;</td><td>11</td></tr><tr><td>7366</td><td>&quot;Desidae&quot;</td><td>&quot;phylum&quot;</td><td>1</td></tr><tr><td>8672</td><td>&quot;Pinnotheridae&quot;</td><td>&quot;phylum&quot;</td><td>3</td></tr><tr><td>4551</td><td>&quot;Penaeidae&quot;</td><td>&quot;phylum&quot;</td><td>12</td></tr><tr><td>9596</td><td>&quot;Coeloplanidae&quot;</td><td>&quot;phylum&quot;</td><td>4</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "9b89c89ff9b7a3d06257f34d61cb53ed", "console": [], "id": "kqZH", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (2, 4)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>parentNameUsageID</th><th>name_to_match</th><th>current_feature</th><th>len</th></tr><tr><td>i64</td><td>str</td><td>str</td><td>u32</td></tr></thead><tbody><tr><td>5164</td><td>&quot;Plotosidae&quot;</td><td>&quot;order&quot;</td><td>4</td></tr><tr><td>4512</td><td>&quot;Ariidae&quot;</td><td>&quot;order&quot;</td><td>3</td></tr></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "22a10eb8e24556f6fdbafbfff142bcc6", "console": [], "id": "wAgl", "outputs": [{"data": {"application/json": "[1131, 30]"}, "type": "data"}]}, {"code_hash": "8e32c5b819476852385485077b1fb9a0", "console": [], "id": "awtG", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"genus\">genus</h2>\n<span class=\"paragraph\">There is nothing for rank genus.</span></span>"}, "type": "data"}]}, {"code_hash": "ba9165fc9e3ddaa2c73d7bdd29d75f6e", "console": [], "id": "IMjo", "outputs": [{"data": {"text/html": "<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (0, 29)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>speciesId</th><th>matched_taxonID</th><th>acceptedNameUsageID</th><th>taxonName</th><th>domain</th><th>kingdom</th><th>phylum</th><th>class</th><th>subclass</th><th>superorder</th><th>order</th><th>sub-order</th><th>infraorder</th><th>section</th><th>subsection</th><th>superfamily</th><th>family</th><th>subfamily</th><th>tribe</th><th>genus</th><th>subgenus</th><th>genericName</th><th>specificEpithet</th><th>infraspecificEpithet</th><th>taxonRank</th><th>taxonomicStatus</th><th>parentNameUsageID</th><th>current_feature</th><th>current_name</th></tr><tr><td>str</td><td>i64</td><td>i64</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>null</td><td>str</td><td>str</td></tr></thead><tbody></tbody></table></div>"}, "type": "data"}]}, {"code_hash": "cdc0c379d31c10fe0a643c5a2a458b0b", "console": [], "id": "rEll", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"stops-at-specificepithet-there-is-only-current_feature-phylum-matches\">stops at specificEpithet there is only current_feature = phylum matches</h2>\n<h3 id=\"something-is-wrong-with-some-specificepithet-and-infraspecificepithet-for-both-plcolcurrent_featureis_inphylumorder-cant-be-found-in-gbif\">something is wrong with some specificEpithet and infraSpecificEpithet for both pl.col('current_feature').is_in(['phylum','order']) cant be found in gbif.</h3></span>"}, "type": "data"}]}, {"code_hash": "79b7f583948d9235dbbb9c0a8b3313f9", "console": [], "id": "dGlV", "outputs": [{"data": {"application/json": "[1, 29]"}, "type": "data"}]}, {"code_hash": "390eaf1a8c6a7ea6fefcafecc570fcda", "console": [], "id": "SVvN", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"infraspecificepithet\">infraspecificepithet</h2>\n<span class=\"paragraph\">different filter because some don't have specificEpithet either, if I am not wrong</span></span>"}, "type": "data"}]}, {"code_hash": "6a3702388aaa5e48e52f120c2935a2a6", "console": [], "id": "cNIS", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "0b5ec19235d13036f37e3e64d8164680", "console": [], "id": "SdmI", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"combining-updated-parent-id-rows\">combining updated parent id rows</h1>\n<span class=\"paragraph\">todo: specificEpithet infraSpecificepithet</span></span>"}, "type": "data"}]}, {"code_hash": "104636d67f58724b1ef2d9c98a26c8be", "console": [], "id": "HBeq", "outputs": [{"data": {"application/json": "[\"speciesId\", \"matched_taxonID\", \"acceptedNameUsageID\", \"taxonName\", \"domain\", \"kingdom\", \"phylum\", \"class\", \"subclass\", \"superorder\", \"order\", \"sub-order\", \"infraorder\", \"section\", \"subsection\", \"superfamily\", \"family\", \"subfamily\", \"tribe\", \"genus\", \"subgenus\", \"genericName\", \"specificEpithet\", \"infraspecificEpithet\", \"taxonRank\", \"taxonomicStatus\", \"parentNameUsageID\", \"current_feature\", \"current_name\", \"name_to_match\"]"}, "type": "data"}]}, {"code_hash": "f869e9c5e5edc04542513b4b38cb49fa", "console": [], "id": "PDMd", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><span class=\"paragraph\">unfortunately my 2nd wrangle did some redundant work. I don't know how to remove this wrangling</span></span>"}, "type": "data"}]}, {"code_hash": "560416ac15064e8c612476eb896172ef", "console": [{"name": "stdout", "text": "parentNameUsageID on the redundant check: False\nnew match shape (2035, 27)\n\n", "type": "stream"}, {"name": "stdout", "text": "shape of all matches: 2502\nshape of nomatch before any matches 8445\n(5943, 27)\n", "type": "stream"}], "id": "lgWD", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "e4759e3c76b64be7e2224e120928ba04", "console": [], "id": "uoIF", "outputs": [{"data": {"text/html": "<pre style='font-size: 12px'>8445</pre>"}, "type": "data"}]}], "metadata": {"marimo_version": "0.15.2"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.15.2%22%0Aapp%20%3D%20marimo.App(width%3D%22full%22)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%20DF%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20polars%20as%20pl%0A%0A%20%20%20%20from%20r_translation%20import%20join%0A%0A%20%20%20%20matching%2C%20contentious%20%3D%20join()%0A%20%20%20%20matching%20%3D%20matching.with_columns(%0A%20%20%20%20%20%20%20%20genus%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22genus%22).is_null())%20%26%20(pl.col(%22specificEpithet%22).is_not_null())%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.then(pl.col(%22taxonName%22).str.split(%22%20%22).list%5B0%5D)%0A%20%20%20%20%20%20%20%20.otherwise(%22genus%22)%0A%20%20%20%20)%0A%20%20%20%20return%20contentious%2C%20matching%2C%20mo%2C%20pl%0A%0A%0A%40app.cell%0Adef%20_(contentious)%3A%0A%20%20%20%20contentious.collect_schema().keys()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22nomatch%20lazyframe%20is%20for%20BOS%20data%20point%20that%20has%20no%20current%20match%20in%20gbif%20data%20set.%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(matching%2C%20pl)%3A%0A%20%20%20%20nomatch%20%3D%20(%0A%20%20%20%20%20%20%20%20matching.filter(pl.col(%22matched_taxonID%22).is_null())%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonRank%3Dpl.lit(%22BOSuncornirmedSpecies%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20taxonomicStatus%3Dpl.lit(%22BOSunformired%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.lit(None)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.fill_null(%22%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20nomatch%0A%20%20%20%20return%20(nomatch%2C)%0A%0A%0A%40app.cell%0Adef%20_(matching%2C%20pl)%3A%0A%20%20%20%20matching_with_populated_match_taxonID%20%3D%20matching.filter(%0A%20%20%20%20%20%20%20%20pl.col(%22matched_taxonID%22).is_not_null()%0A%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20taxonRank%3Dpl.lit(None)%2C%0A%20%20%20%20%20%20%20%20taxonomicStatus%3Dpl.lit(None)%2C%0A%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.lit(None)%2C%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%20repeated_accepted_taxons%20%3D%20RAT%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl)%3A%0A%20%20%20%20repeated_accepted_taxons%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%22gbif%2FTaxon.tsv%22%2C%20separator%3D%22%5Ct%22%2C%20quote_char%3DNone%2C%20cache%3DTrue)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22taxonomicStatus%22)%20%3D%3D%20pl.lit(%22accepted%22))%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22kingdom%22).is_in(%5B%22Animalia%22%2C%20%22Plantae%22%5D))%0A%20%20%20%20%20%20%20%20.filter(~pl.col(%22canonicalName%22).is_null())%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22canonicalName%22)%20!%3D%20%22%22)%0A%20%20%20%20%20%20%20%20.sort(%22canonicalName%22)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22canonicalName%22).is_duplicated())%0A%20%20%20%20)%0A%20%20%20%20return%20(repeated_accepted_taxons%2C)%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20repeated_accepted_taxons)%3A%0A%20%20%20%20priority_columns%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20%22family%22%2C%0A%20%20%20%20%20%20%20%20%22order%22%2C%0A%20%20%20%20%20%20%20%20%22class%22%2C%0A%20%20%20%20%20%20%20%20%22phylum%22%2C%0A%20%20%20%20%20%20%20%20%22kingdom%22%2C%0A%20%20%20%20%5D%0A%0A%20%20%20%20_schema%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22feature_that_is_equal_to_canonicalName%22%3A%20pl.String%2C%0A%20%20%20%20%20%20%20%20%22matches%22%3A%20pl.String%2C%0A%20%20%20%20%7D%0A%20%20%20%20_r%20%3D%20(repeated_accepted_taxons).collect()%0A%20%20%20%20RAT_interim%20%3D%20pl.DataFrame(schema%3D_schema)%0A%20%20%20%20for%20_col%20in%20priority_columns%3A%0A%20%20%20%20%20%20%20%20_canonical_names%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_r.filter(pl.col(%22canonicalName%22)%20%3D%3D%20pl.col(_col))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.select(%22canonicalName%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.unique()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.to_series()%0A%20%20%20%20%20%20%20%20%20%20%20%20.to_list()%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20if%20len(_canonical_names)%20!%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_row%20%3D%20pl.DataFrame(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22feature_that_is_equal_to_canonicalName%22%3A%20_col%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22matches%22%3A%20_canonical_names%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20schema%3D_schema%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20RAT_interim%20%3D%20RAT_interim.vstack(_row)%0A%20%20%20%20RAT_feats%20%3D%20(%0A%20%20%20%20%20%20%20%20RAT_interim.group_by(%22matches%22)%0A%20%20%20%20%20%20%20%20.agg(pl.col(%22feature_that_is_equal_to_canonicalName%22).str.join(%22%2C%20%22))%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22feature_that_is_equal_to_canonicalName%22).str.split(%22%2C%20%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.sort(%22feature_that_is_equal_to_canonicalName%22)%0A%20%20%20%20)%0A%20%20%20%20return%20RAT_feats%2C%20priority_columns%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20matching%20attempt%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(RAT_feats)%3A%0A%20%20%20%20RAT_feats%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(RAT_feats%2C%20nomatch%2C%20pl%2C%20priority_columns%2C%20repeated_accepted_taxons)%3A%0A%20%20%20%20updated_to_matching%20%3D%20%5B%5D%0A%20%20%20%20all_taxon_data_to_be_selected_from%20%3D%20%5B%5D%0A%20%20%20%20still_no_match%20%3D%20%5B%5D%0A%20%20%20%20_collected_repeated_taxons%20%3D%20repeated_accepted_taxons.collect().fill_null(%22%22)%0A%20%20%20%20_reversed_priority_columns%20%3D%20priority_columns.copy()%0A%20%20%20%20_reversed_priority_columns.reverse()%0A%20%20%20%20for%20_col%20in%20_reversed_priority_columns%3A%0A%20%20%20%20%20%20%20%20for%20_match%20in%20RAT_feats%5B%22matches%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20skipping%20those%20that%20are%20not%20in%20RAT_feats%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20_match%20not%20in%20nomatch%5B_col%5D.to_list()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22-------%5CnFeature%3A%22%2C%20_col%2C%20%22%2CName%3A%22%2C%20_match)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20taxon_data_to_select_from%20%3D%20_collected_repeated_taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22canonicalName%22)%20%3D%3D%20_match%0A%20%20%20%20%20%20%20%20%20%20%20%20).select(%5B%22taxonID%22%5D%20%2B%20_reversed_priority_columns)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Select%20from%20the%20two%20rows%20what%20taxon%20data%20to%20select.%0A%20%20%20%20%20%20%20%20%20%20%20%20selected_row_int%20%3D%20-1%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20_tuple%20in%20enumerate(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20taxon_data_to_select_from.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%22taxonID%22%5D%20%2B%20priority_columns%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).iter_rows()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20col_index%20%3D%20priority_columns.index(_col)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x%20%3D%20_tuple%5Bcol_index%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20bool(_x)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20selected_row_int%20%3D%20i%20%20%23%20Since%20there%20are%20usually%20only%20two%20rows%20from%20taxon_data_to_select_from%2C%20the%20results%20is%20either%200%20or%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20assert%20selected_row_int%20!%3D%20-1%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20has_predicament1%20is%20when%20kingdom%20to%20genus%20all%20has%20values%20and%20it%20is%20kind%20of%20leveled%20between%20the%20two%20rows%20of%20the%20taxon%20data.%0A%20%20%20%20%20%20%20%20%20%20%20%20has_predicament1%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20_l%20%3D%20taxon_data_to_select_from%5B%22family%22%5D.to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20_col%20%3D%3D%20%22genus%22%20and%20_l%5B0%5D%20!%3D%20None%20and%20_l%5B1%5D%20!%3D%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22same%20level%20detected%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20has_predicament1%20%3D%20True%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20chosen_taxonId%20%3D%20taxon_data_to_select_from%5Bselected_row_int%2C%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20other_taxonId%20%3D%20taxon_data_to_select_from%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20int(not%20bool(selected_row_int))%2C%200%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Getting%20the%20_no_match_subset_to_update%20section%0A%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20nomatch.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(_col)%20%3D%3D%20_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20_x%20%3D%20_reversed_priority_columns%5B%3A-3%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20feature_to_find_nulls%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x%5B_reversed_priority_columns.index(_col)%20%2B%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20len(_x)%20%3E%20_reversed_priority_columns.index(_col)%20%2B%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20)%20%20%23%20just%20the%20next%20feature%20to%20find%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20feature_to_find_nulls%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22feature_to_find_nulls%22%2C%20feature_to_find_nulls)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20_no_match_subset_to_update.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(feature_to_find_nulls)%20%3D%3D%20%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20_no_match_subset_to_update.is_empty()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20still_no_match_subset%20%3D%20nomatch.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(_col)%20%3D%3D%20_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20current_feature%3Dpl.lit(_col)%2C%20current_name%3Dpl.lit(_match)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20still_no_match.append(still_no_match_subset)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%5Cn%5Cn%5Cn%5Cn%5Cnskipping%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_col%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%5Cn%20this%20_no_match_subset_to_update%20dataframe%20doesn't%20have%20the%20same%20tax%20rank%20level%5Cn%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20still_no_match_subset.select(_reversed_priority_columns)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22---------%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Settling%20predicament%20one%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20this%20predicament%20thing%20should%20only%20happen%20when%20the%20subset%20is%20of%20only%201%20row.%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20has_predicament1%20and%20_no_match_subset_to_update.shape%5B0%5D%20%3D%3D%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20_col1%20in%20%5B%22class%22%2C%20%22order%22%2C%20%22family%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20*%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%3D%20taxon_data_to_select_from%5Bselected_row_int%2C%20%3A%5D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_col1%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20match%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20_col1%20in%20%5B%22class%22%2C%20%22order%22%2C%20%22family%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20match%20*%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%3D%20taxon_data_to_select_from%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20int(not%20bool(selected_row_int))%2C%20%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%5B_col1%5D.item()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%20%20%23%20searching%20in%20the%20three%20columns%20of%20interests%20for%20matches%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20assert%20match%20%3D%3D%20True%20%20%23%20Double%20check%20that%20there%20is%20no%20unmatch.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22changing%20chosen%20taxonId%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20temp%20%3D%20chosen_taxonId%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chosen_taxonId%20%3D%20other_taxonId%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20other_taxonId%20%3D%20temp%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20turning%20these%20rows%20to%20matching%20by%20filling%20parentNameUsageID%0A%20%20%20%20%20%20%20%20%20%20%20%20_no_match_subset_to_update%20%3D%20_no_match_subset_to_update.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22infraspecificEpithet%22).is_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22specificEpithet%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22genus%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(other_taxonId))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.lit(chosen_taxonId))%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Debugging%20for%20matching%20data%20from%20gbif%20to%20new%20matched%20rows%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22taxon_data_to_select_from%5Cn%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20taxon_data_to_select_from%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22parentNameUsageID%20chosen%3A%22%2C%20chosen_taxonId)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22no_match_subset_to_update%20%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(_no_match_subset_to_update.select(_reversed_priority_columns))%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22---------%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20updated_to_matching.append(_no_match_subset_to_update)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20all_taxon_data_to_be_selected_from.append(taxon_data_to_select_from)%0A%0A%20%20%20%20%23%20turn%20them%20into%20dataframes%20and%20writing%20to%20csv%20files%0A%20%20%20%20updated_to_matching%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20updated_to_matching%2C%20rechunk%3DTrue%2C%20parallel%3DTrue%0A%20%20%20%20)%0A%20%20%20%20updated_to_matching.write_csv(%22updated_to_matching.csv%22)%0A%20%20%20%20updated_to_matching.write_csv(%22first_matches_set_from_wrangling.csv%22)%0A%20%20%20%20%23%20all_taxon_data_to_be_selected_from%20%3D%20pl.concat(%0A%20%20%20%20%23%20%20%20%20%20all_taxon_data_to_be_selected_from%2C%20rechunk%3DTrue%2C%20parallel%3DTrue%0A%20%20%20%20%23%20)%0A%20%20%20%20%23%20all_taxon_data_to_be_selected_from.write_csv(%0A%20%20%20%20%23%20%20%20%20%20%22all_taxon_data_to_be_selected_from.csv%22%0A%20%20%20%20%23%20)%0A%20%20%20%20still_no_match%20%3D%20pl.concat(still_no_match%2C%20rechunk%3DTrue%2C%20parallel%3DTrue)%0A%20%20%20%20%23%20still_no_match.write_csv(%22still_no_match.csv%22)%0A%20%20%20%20return%20still_no_match%2C%20updated_to_matching%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20still%20no%20match%20stuff%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%23%20%60current_feature%60%20uniques%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(still_no_match)%3A%0A%20%20%20%20still_no_match%5B%22current_feature%22%5D.unique()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%23%20%60current_name%60%20uniques%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(still_no_match)%3A%0A%20%20%20%20still_no_match%5B%22current_name%22%5D.unique()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20number%20of%20rows%20in%20still%20no%20match%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(still_no_match)%3A%0A%20%20%20%20still_no_match.shape%5B0%5D%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%20second%20matching%20wrangle%20of%20new%20%60Taxons%60%20df%20with%20%60still_no_match%60%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20priority_columns)%3A%0A%20%20%20%20taxons%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.scan_csv(%22gbif%2FTaxon.tsv%22%2C%20separator%3D%22%5Ct%22%2C%20quote_char%3DNone%2C%20cache%3DTrue)%0A%20%20%20%20%20%20%20%20.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22taxonomicStatus%22)%20%3D%3D%20pl.lit(%22accepted%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22taxonRank%22)%20!%3D%20%22unranked%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.filter(pl.col(%22kingdom%22).is_in(%5B%22Animalia%22%2C%20%22Plantae%22%5D))%0A%20%20%20%20%20%20%20%20.select(%5B%22taxonID%22%5D%20%2B%20priority_columns)%0A%20%20%20%20)%0A%20%20%20%20taxons.collect().shape%0A%20%20%20%20return%20(taxons%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20stop%20at%20class%2C%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(priority_columns)%3A%0A%20%20%20%20priority_columns%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20%23%23%20stop%20at%20class%2C%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%0A%20%20%20%20_filter%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22current_feature%22)%20%3D%3D%20%22phylum%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_class%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter).then(%22class%22).otherwise(None)%0A%20%20%20%20).filter(_filter)%0A%0A%20%20%20%20_x1%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter)%0A%20%20%20%20%20%20%20%20.select(%22class%22%2C%20%22phylum%22)%0A%20%20%20%20%20%20%20%20.group_by(%22class%22%2C%20%22phylum%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset%20%3D%20taxons.filter(%0A%20%20%20%20%20%20%20%20pl.col(%22family%22).is_null()%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22).is_null()%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20pl.col(%22class%22).is_in(_x1%5B%22class%22%5D.unique())%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20pl.col(%22phylum%22).is_in(_x1%5B%22phylum%22%5D.unique())%2C%0A%20%20%20%20).select(%22taxonID%22%2C%20%22class%22)%0A%20%20%20%20match_on_class%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.LazyFrame(match_on_class)%0A%20%20%20%20%20%20%20%20.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20_taxons_subset%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22class%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(pl.col(%22taxonID%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(%22taxonID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22parentNameUsageID%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.drop(%22taxonID%22)%0A%20%20%20%20).collect()%0A%0A%20%20%20%20match_on_class.shape%0A%20%20%20%20return%20(match_on_class%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_class)%3A%0A%20%20%20%20match_on_class.group_by(%22parentNameUsageID%22%2C%20%22name_to_match%22).len()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_class)%3A%0A%20%20%20%20match_on_class.shape%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%23%20stops%20at%20order%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20%23%23%20stops%20at%20order%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%0A%20%20%20%20_filter%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22current_feature%22)%20%3D%3D%20%22phylum%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_order%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter).then(%22order%22).otherwise(None)%0A%20%20%20%20).filter(_filter)%0A%20%20%20%20_x1%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter)%0A%20%20%20%20%20%20%20%20.select(%22order%22%2C%20%22phylum%22)%0A%20%20%20%20%20%20%20%20.group_by(%22order%22%2C%20%22phylum%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_in(_x1%5B%22order%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22phylum%22).is_in(_x1%5B%22phylum%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_order%20%3D%20(%0A%20%20%20%20%20%20%20%20match_on_order.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20_taxons_subset%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22order%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(pl.col(%22taxonID%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(%22taxonID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22parentNameUsageID%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.drop(%22taxonID%22)%0A%20%20%20%20)%0A%20%20%20%20match_on_order.shape%0A%20%20%20%20return%20(match_on_order%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_order)%3A%0A%20%20%20%20match_on_order.group_by(%22parentNameUsageID%22%2C%20%22name_to_match%22).len()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_order)%3A%0A%20%20%20%20match_on_order.shape%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%23%23%20stops%20at%20family%2C%20current_feature%20contains%20both%20phylum%20and%20order%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20%23%23%20stops%20at%20family%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%0A%20%20%20%20_filter%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%20%20%20%20match_on_family%20%3D%20still_no_match.with_columns(%0A%20%20%20%20%20%20%20%20name_to_match%3Dpl.when(_filter).then(%22family%22).otherwise(None)%0A%20%20%20%20).filter(_filter)%0A%20%20%20%20_x1%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter)%0A%20%20%20%20%20%20%20%20.select(%22family%22%2C%20%22phylum%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.group_by(%22family%22%2C%20%22phylum%22%2C%20%22order%22)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22family%22).is_in(_x1%5B%22family%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_null()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22phylum%22).is_in(_x1%5B%22phylum%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22order%22).is_in(_x1%5B%22order%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%22taxonID%22%2C%20%22family%22)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%20%20%20%20match_on_family%20%3D%20(%0A%20%20%20%20%20%20%20%20match_on_family.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20_taxons_subset%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22family%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(pl.col(%22taxonID%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(%22taxonID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22parentNameUsageID%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.drop(%22taxonID%22)%0A%20%20%20%20)%0A%20%20%20%20match_on_family.shape%0A%20%20%20%20return%20(match_on_family%2C)%0A%0A%0A%40app.cell%0Adef%20_(match_on_family%2C%20pl)%3A%0A%20%20%20%20match_on_family.group_by(%0A%20%20%20%20%20%20%20%20%22parentNameUsageID%22%2C%20%22name_to_match%22%2C%20%22current_feature%22%0A%20%20%20%20).len().filter(pl.col(%22current_feature%22)%20%3D%3D%20%22phylum%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_family%2C%20pl)%3A%0A%20%20%20%20match_on_family.group_by(%0A%20%20%20%20%20%20%20%20%22parentNameUsageID%22%2C%20%22name_to_match%22%2C%20%22current_feature%22%0A%20%20%20%20).len().filter(pl.col(%22current_feature%22)%20%3D%3D%20%22order%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_family)%3A%0A%20%20%20%20match_on_family.shape%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20genus%20%20%0A%0A%20%20%20%20There%20is%20nothing%20for%20rank%20genus.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20still_no_match)%3A%0A%20%20%20%20_filter%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%20%20%20%20_g%20%3D%20still_no_match.filter(_filter)%0A%20%20%20%20_g%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20stops%20at%20specificEpithet%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%20%0A%0A%20%20%20%20%23%23%23%20something%20is%20wrong%20with%20some%20specificEpithet%20and%20infraSpecificEpithet%20for%20both%20pl.col('current_feature').is_in(%5B'phylum'%2C'order'%5D)%20cant%20be%20found%20in%20gbif.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20%23%23%20stops%20at%20family%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%0A%20%20%20%20_filter%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20%3D%3D%20%22%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20to_be_match_on_specificEpithet%20%3D%20still_no_match.filter(_filter)%0A%0A%20%20%20%20_x1%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.group_by(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22specificEpithet%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x1%5B%22specificEpithet%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_in(_x1%5B%22genus%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22specificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20TAXON.TSV%20doesn't%20have%20pl.col(%22genus%22)%3D%3D'Dicaeum'%2Cpl.col('specificEpithet')%3D%3D'chysorrheum'%0A%20%20%20%20match_on_specificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20to_be_match_on_specificEpithet.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20_taxons_subset%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%5B%22genus%22%2C%20%22specificEpithet%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20how%3D%22left%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(pl.col(%22taxonID%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(%22taxonID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22parentNameUsageID%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.drop(%22taxonID%22)%0A%20%20%20%20)%0A%20%20%20%20match_on_specificEpithet.shape%0A%20%20%20%20%23%20match_on_specificEpithet.write_csv(%22matching_attempt_on_specificEpithet.csv%22)%0A%20%20%20%20return%20(match_on_specificEpithet%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20infraspecificepithet%0A%0A%20%20%20%20different%20filter%20because%20some%20don't%20have%20specificEpithet%20either%2C%20if%20I%20am%20not%20wrong%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20still_no_match%2C%20taxons)%3A%0A%20%20%20%20%23%20InfraspecificEpithet%0A%0A%20%20%20%20%23%23%20stops%20at%20family%20there%20is%20only%20current_feature%20%3D%20phylum%20matches%0A%20%20%20%20_filter%20%3D%20(%0A%20%20%20%20%20%20%20%20pl.col(%22class%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22order%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22family%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22genus%22)%20!%3D%20%22%22%2C%0A%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22)%20!%3D%20%22%22%2C%0A%20%20%20%20)%20%20%23%20different%20filter%20because%20some%20don't%20have%20specificEpithet%20either%2C%20if%20I%20am%20not%20wrong%0A%20%20%20%20to_be_match_on_infraspecificEpithet%20%3D%20still_no_match.filter(_filter)%0A%0A%20%20%20%20_x1%20%3D%20(%0A%20%20%20%20%20%20%20%20still_no_match.filter(_filter)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.group_by(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.len()%0A%20%20%20%20)%0A%0A%20%20%20%20_taxons_subset%20%3D%20(%0A%20%20%20%20%20%20%20%20taxons.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22infraspecificEpithet%22).is_in(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_x1%5B%22infraspecificEpithet%22%5D.unique().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22genus%22).is_in(_x1%5B%22genus%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22taxonID%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22infraspecificEpithet%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22genus%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.collect()%0A%20%20%20%20)%0A%0A%0A%20%20%20%20%23%20TAXON.TSV%20doesn't%20have%20pl.col(%22genus%22)%3D%3D'Dicaeum'%2Cpl.col('specificEpithet')%3D%3D'chysorrheum'%0A%20%20%20%20match_on_infraspecificEpithet%20%3D%20(%0A%20%20%20%20%20%20%20%20to_be_match_on_infraspecificEpithet.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20_taxons_subset%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%5B%22genus%22%2C%20%22infraspecificEpithet%22%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20parentNameUsageID%3Dpl.when(pl.col(%22taxonID%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(%22taxonID%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%22parentNameUsageID%22)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.drop(%22taxonID%22)%0A%20%20%20%20)%0A%20%20%20%20%23%20print(match_on_infraspecificEpithet.select(priority_columns))%0A%20%20%20%20return%20(match_on_infraspecificEpithet%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23combining%20updated%20parent%20id%20rows%0A%0A%20%20%20%20todo%3A%20specificEpithet%20infraSpecificepithet%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(match_on_class)%3A%0A%20%20%20%20match_on_class.columns%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22unfortunately%20my%202nd%20wrangle%20did%20some%20redundant%20work.%20I%20don't%20know%20how%20to%20remove%20this%20wrangling%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20match_on_class%2C%0A%20%20%20%20match_on_family%2C%0A%20%20%20%20match_on_infraspecificEpithet%2C%0A%20%20%20%20match_on_order%2C%0A%20%20%20%20match_on_specificEpithet%2C%0A%20%20%20%20nomatch%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20updated_to_matching%2C%0A)%3A%0A%20%20%20%20_to_drop%20%3D%20%5B%22current_feature%22%2C%20%22current_name%22%2C%20%22name_to_match%22%5D%0A%20%20%20%20_to_drop2%20%3D%20%5B%22current_feature%22%2C%20%22current_name%22%5D%0A%20%20%20%20_new_match%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_class.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_order.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_family.drop(_to_drop)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_specificEpithet.drop(_to_drop2)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20match_on_infraspecificEpithet.drop(_to_drop2)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20_redundant%20%3D%20updated_to_matching.with_columns().join(%0A%20%20%20%20%20%20%20%20_new_match%2C%20on%3D%22speciesId%22%0A%20%20%20%20)%20%20%23%20removing%20redundant%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%22parentNameUsageID%20on%20the%20redundant%20check%3A%22%2C%0A%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20_redundant%5B%22parentNameUsageID%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20!%3D%20_redundant%5B%22parentNameUsageID_right%22%5D%0A%20%20%20%20%20%20%20%20).any()%2C%0A%20%20%20%20)%0A%20%20%20%20_new_match.write_csv(%22second_matches_set_from_wrangling.csv%22)%0A%0A%20%20%20%20_new_match%20%3D%20_new_match.join(%0A%20%20%20%20%20%20%20%20_redundant.select(%22speciesId%22)%2C%20on%3D%22speciesId%22%2C%20how%3D%22anti%22%0A%20%20%20%20)%0A%20%20%20%20print(%22new%20match%20shape%22%2C%20_new_match.shape)%0A%20%20%20%20print()%0A%20%20%20%20_new_match%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20_new_match%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20updated_to_matching.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22parentNameUsageID%22).cast(pl.Int64)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20_new_match.write_csv(%22updated_to_matching.csv%22)%0A%20%20%20%20print(%22shape%20of%20all%20matches%3A%22%2C%20_new_match.shape%5B0%5D)%0A%20%20%20%20%23%20print(%22new%20match%20unique%20speciesId%22%2C_new_match.select(%22speciesId%22).unique())%0A%20%20%20%20print(%22shape%20of%20nomatch%20before%20any%20matches%22%2C%20nomatch.shape%5B0%5D)%0A%20%20%20%20_nomatch%20%3D%20nomatch.join(_new_match.select(%22speciesId%22)%2C%20on%3D%22speciesId%22%2C%20how%3D%22anti%22)%0A%20%20%20%20print(_x.shape)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%205943%20%2B%202502%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">8f83db4b6c83864f77fa245bcd8a3eb15611bfbf7279e7a64c213a4e0f475d1e</marimo-code-hash>
</body>
</html>
